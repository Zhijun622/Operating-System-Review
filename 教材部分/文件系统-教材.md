# 文件系统

第7章
输入/输出（input/output，I/O）系统是OS的重要组成部分，用于管理诸如打印机和扫
描仪等I/O设备，以及用于存储数据的各种存储设备，如磁盘和磁带机等。由于设备类型繁
多，差异又非常大，I/O系统成为了OS中最繁杂且与硬件最紧密相关的部分。本章将在简要
介绍I/O设备的基础上，着重阐述OS对I/O的管理。本章知识导图如图7-1所示。
输入/输出系统
I/O系统的功能、模型与接口
I/O设备和设备控制器
I/O软件
缓冲区管理
磁盘性能概述和磁盘调度
I/O系统的基本功能
I/O系统的层次结构与模型
I/O系统的接口
系统调用
库函数
假脱机系统
FCFS调度算法
SCAN调度算法
CSCAN调度算法
NStepSCAN调度算法
和FSCAN调度算法
SSTF调度算法
磁盘性能概述 
磁盘调度
中断处理程序
设备驱动程序
与设备无关的I/O软件
用户层的I/O软件
设备分配与回收
逻辑设备名映射
到物理设备名
I/O调度
图7-1　第7章知识导图
第7章导读


--- Page 221 ---
200
计算机操作系统 （慕课版）
7.1　I/O系统的功能、模型与接口
I/O系统管理的主要对象是I/O设备和相应的设备控制器。I/O系统最主要的任务是，满足用
户进程提出的I/O请求，提高I/O速度，提高设备的利用率，以及为更高层的进程方便地使用I/O
设备提供手段。
7.1.1　I/O 系统的基本功能
为了满足系统和用户的请求，I/O系统应具有下述几方面的基本功能，其中，第一、第二方
面的功能是为了方便用户使用I/O设备；第三、第四方面的功能是为了提高处理机和I/O设备的利
用率；第五、第六方面的功能是为了给用户在共享设备时提供方便，以保证系统能有条不紊地
运行，当系统发生错误时能及时发现错误，甚至自动修正错误。
1．能够隐藏 I/O 设备的细节
I/O设备的类型非常多，且彼此间在很多方面都存在差异，如它们接收和产生数据的速度、
数据传输方向、数据粒度、数据的表示形式以及可靠性等方面。为了对这些千差万别的 I/O设备
进行控制，通常会为它们配置相应的设备控制器。这是一种硬件设备，其中包含若干个用于存
放控制命令和参数的寄存器。用户通过这些命令和参数，可以控制I/O设备执行所要求的操作。
显然，对于不同的I/O设备，需要有不同的命令和参数。例如，在对磁盘进行操作时，不仅
要给出本次是读命令还是写命令，还要给出源数据或目标数据的位置，包括磁盘的盘面号、磁
道号和扇区号。由此可见，要求程序员或用户编写直接面向这些 I/O设备的程序是极其困难的。
因此，I/O系统必须通过对I/O设备加以适当的抽象，以隐藏I/O设备的实现细节，仅向上层进程
提供少量的、抽象的读/写命令，如read、write等。实际上，关于隐藏性问题，我们在第1章中已
做了类似的介绍。
2．能够保证设备无关性
隐藏物理设备的细节，在早期的OS 中就已实现，它可以方便用户对设备进行使用。保证设
备无关性这一功能，是在较晚时才实现的，且是在隐藏 I/O设备细节的基础上实现的。一方面，
用户不仅可以使用抽象的I/O命令，还可以使用抽象的逻辑设备名来使用设备，例如，当用户要
输出打印时，他只须提供（读或）写的命令（用于提出对I/O设备的要求）和抽象的逻辑设备
名，如/dev/printer，而不必指明具体是哪一台打印机；另一方面，也可以有效地提高OS的可移
植性和易适应性。对于OS本身而言，应允许在不需要将整个OS进行重新编译的情况下增添新的
设备驱动程序，以方便新的I/O设备安装。如在Windows系统中，系统可以为新的I/O设备自动寻
找和安装设备驱动程序，从而做到即插即用。
3．能够提高处理机和 I/O 设备的利用率
在一般的系统中，许多I/O设备间是相互独立的，能够并行操作，处理机与设备之间也能并
行操作。因此，I/O系统的第三方面功能是尽可能地让处理机和I/O设备并行操作，以提高它们的
利用率。为此，一方面要求处理机能快速响应用户的I/O请求，使I/O设备能够尽快运行起来；另
一方面要求尽量减少在每个 I/O设备运行时处理机的干预时间。在本章中将介绍许多有助于实现
该目标的方法。

--- Page 222 ---
201
第
7章 
输入/输出系统
4．能够对 I/O 设备进行控制
对I/O设备进行控制是设备驱动程序的功能之一。目前对I/O设备有4 种控制方式：①轮询的
可编程I/O方式；②中断的可编程I/O方式；③直接存储器访问（direct memory access，DMA）方
式；④I/O通道方式。应采用何种控制方式，与I/O设备的传输速率、传输的数据单位等因素有
关。例如针对打印机、键盘等低速设备，由于它们传输数据的基本单位是字节（或字），故应
采用中断的可编程I/O方式；而针对磁盘、光盘等高速设备，由于它们传输数据的基本单位是数
据块，故应采用DMA方式，以提高系统的利用率。此外，I/O通道方式的引入，使得对I/O操作
的组织和数据的传输，都能独立进行而无需CPU的干预。为了给上层软件和用户提供方便，显
然I/O软件也应屏蔽掉这种差异，向上层软件和用户提供统一的操作接口。
5．能够确保对设备的正确共享
根据设备的共享属性，可将系统中的设备分为两类。①独占设备，进程应互斥地访问此类
设备，即系统一旦把此类设备分配给某进程后，便由该进程独占，直至用完释放。典型的独占
设备有打印机、磁带机等。系统在对独占设备进行分配时，还应考虑分配的安全性。②共享设
备，是指在一段时间内允许多个进程同时访问的设备。典型的共享设备是磁盘，当有多个进程
对磁盘执行读/写操作时，操作可以交叉进行而不会影响到读/写的正确性。
6．能够处理错误
大多数的设备都包括了较多的机械和电气部分，运行时容易出现错误和故障。从处理的
角度看，可以将错误分为临时性错误和持久性错误。对于临时性错误，可通过重试操作来纠
正它；只有在发生了持久性错误时，才需要向上层报告。例如，在磁盘传输数据过程中发生错
误，系统并不认为磁盘已发生了故障，而是可以重新传输，一直重传多次后仍然有错，才会认
为磁盘发生了故障。由于多数错误是与设备紧密相关的，因此对于错误的处理，应该尽可能地
在接近硬件的层面上进行，即低层软件能够解决的错误就不向上层报告，因此高层也就不能感
知。只有低层软件解决不了的错误才向上层报告，请求上层软件解决。
7.1.2　I/O 系统的层次结构与模型
I/O系统由I/O软件和I/O设备（硬件）等组成。I/O软件涉及的面很宽，向下与硬件密切关联，
向上又与文件系统、虚拟存储器系统和用户直接交互，它们都需要I/O系统来实现I/O操作。为使复
杂的I/O软件能具有清晰的结构、更好的可移植性和易适应性，目前已普遍采用具有层次结构的I/O
系统。该结构是将I/O系统中的设备管理模块分为若干个层次，每层都是利用其下层提供的服务来
完成I/O功能中的某些子功能的，并且会屏蔽这些功能实现的细节，向上层提供服务。
1．I/O 系统的层次结构
通常把“I/O软件”组织成4个层次，它们包含于图7-2所示的I/O系统的层次结构中，图中的
箭头表示I/O的控制流。各层次及其功能介绍如下。
（1）用户层软件 ，用于提供与用户交互的接口，用户可直接调用该层所提供的与I/O操作
有关的库函数对设备进行操作。
（2）与设备无关的I/O软件，用于实现用户程序与设备驱动程序的统一接口、设备命名、
设备保护以及设备的分配与释放等，同时为设备管理和数据传输提供必要的存储空间。
（3）设备驱动程序 ，与硬件直接相关，用于执行系统对 I/O设备发出的操作指令，换言

--- Page 223 ---
202
计算机操作系统 （慕课版）
之，是驱动I/O设备工作的驱动程序。
（4）中断处理程序，用于保存被中断进程的CPU现场环境，保存完成后转入相应的中断处
理程序处理中断，处理完成后再恢复被中断进程的CPU现场环境，最后返回被中断进程。
用户层软件
与设备无关的I/O软件
设备驱动程序
中断处理程序
I/O应答
产生I/O请求；格式化I/O；SPOOLing
映射；保护；分块；缓冲；分配
设置设备寄存器；检查状态
执行I/O操作
硬件
图 7-2　I/O 系统的层次结构
2．I/O 系统的模型
为了能更清晰地描述I/O系统中主要模块之间的关系，这里进一步介绍I/O系统的模型，即I/O
系统中各种I/O模块之间的层次视图，如图7-3所示。
应用程序
文件
系统
块设备接口
块设备管理
CD-ROM
驱动程序
键盘
驱动程序
CD-ROM
中断处理程序
CD-ROM
控制器
CD-ROM
驱动器
硬盘
驱动器
硬盘
控制器
键盘
控制器
键盘
打印机
控制器
打印机
网络
控制器
网络
键盘
中断处理程序
网络
驱动程序
网络
中断处理程序
打印机
驱动程序
打印机
中断处理程序
硬盘
驱动程序
硬盘
中断处理程序
…
…
…
…
…
…
… … …
流设备管理 网络通信软件
流设备接口 网络通信
接口
打开/关闭
读/写
打开/关闭
取/放
io_control
打开/关闭
读/写
发送/接收
虚拟内存
管理
用户层软件
I/O系统接口
与设备无关的I/O软件
设备驱动程序
中断处理程序
设备控制器
软件/硬件接口
图 7-3　I/O 系统中各种 I/O 模块之间的层次视图
（1）I/O系统的上/下接口。
① I/O系统接口 。上接口是I/O系统接口，它是I/O系统与上层系统之间的接口，向上层系
统提供对设备进行操作的抽象I/O命令，以方便上层系统对设备进行使用。有不少OS在用户层提
供了与I/O操作有关的库函数供用户使用。在上层系统中有文件系统、虚拟存储器系统以及用户
进程等。
② 软件/硬件接口 。下接口是软件/ 硬件接口。它的上面是中断处理程序和用于不同设备
的设备驱动程序。它的下面是各种设备的控制器，如CD-ROM控制器、硬盘控制器、键盘控制

--- Page 224 ---
203
第
7章 
输入/输出系统
器、打印机控制器以及网络控制器等，它们都属于硬件。由于设备种类繁多，故该接口相当复
杂。如图7-3所示，在上接口与下接口之间是I/O系统。
（2）I/O系统的分层。
与前面所述的I/O软件的分层相对应，I/O系统本身也可分为以下3个层次。
① 中断处理程序 。它处于I/O系统的最低层，直接与硬件进行交互。当有 I/O设备发来中
断请求信号时，在中断硬件做了初步处理后，便转向中断处理程序。它首先保存被中断进程的
CPU现场环境，然后转入相应设备的中断处理程序处理中断，在中断处理完成后又恢复被中断
进程的CPU现场环境，并返回断点继续运行。
② 设备驱动程序。它处于I/O系统的次低层，是进程和设备控制器之间的通信程序，其主要
功能是：将上层发来的抽象I/O请求转换为针对I/O设备的具体命令和参数，并把它们装入设备控
制器中的命令寄存器和参数寄存器中，或者相反。由于设备之间的差异很大，每类设备的驱动
程序都不同，故必须由设备制造厂商提供设备驱动程序，而不是由OS设计者来设计。因此，每
当在系统中增加一个新设备时，都需要由设备制造厂商提供新的驱动程序。
③ 与设备无关的I/O软件 。在现代OS 的I/O系统中，I/O 软件基本上都实现了与设备无关
性，因此它们也称为与设备无关的软件，其基本含义是： I/O软件独立于具体使用的物理设备。
由此带来的最大好处是：提高了 I/O系统的可适应性和可扩展性，使它们能应用于许多类型的设
备，而且在每次增加新设备或替换老设备时，都不需要对 I/O软件进行修改，这样就方便了系统
的更新和扩展。与设备无关的 I/O软件的内容包括设备命名、设备分配、数据缓冲和数据高速缓
冲等。
7.1.3　I/O 系统的接口
I/O系统与上层之间的接口，根据设备类型的不同，又可进一步分为若干类。在图7-3中给出
了块设备接口、流设备接口和网络通信接口。
1．块设备接口
块设备接口是块设备管理程序与上层之间的接口。该接口反映了大部分磁盘存储器、光盘
存储器、闪存等的本质特征，用于控制该类设备的I/O。
（1）块设备。所谓块设备，是指数据的存取和传输都是以数据块为单位的设备。典型的块
设备是磁盘。该设备的基本特征是传输速率较高，通常为每秒几十MB到几百MB。另一特征是
可寻址，即能指定数据的输入源地址以及输出的目标地址，可随机读/ 写磁盘中的任一块；磁盘
设备的I/O通常采用DMA方式。
（2）隐藏了磁盘的二维结构 。块设备接口将磁盘上的所有扇区从0 到n-1依次编号，n是磁
盘中的扇区总数。经过这样编号后，就可以把磁盘的二维结构变为线性序列。在二维结构中，
每个扇区的地址需要用磁道号和扇区号来表示，换言之，块设备接口隐藏了磁盘地址是二维结
构的这一情况。
（3）将抽象命令映射为低层操作。块设备接口支持上层发来的、面向文件或设备的打开、
读、写和关闭等抽象命令。该接口将上述命令映射为设备能识别的较低层的具体操作，例如，上层
发来读磁盘命令时，它会先将抽象命令中的逻辑块号转换为磁盘的盘面号、磁道号和扇区号等。
虚拟存储器系统也需要使用块设备接口，因为在进程运行期间，每当它所访问的页面不在
内存中时，便会发生缺页中断，此时就需要利用 I/O系统（通过块设备接口）从磁盘存储器中将
所缺页面调入内存。

--- Page 225 ---
204
计算机操作系统 （慕课版）
2．流设备接口
流设备接口是流设备管理程序与上层之间的接口。该接口又称为字符设备接口，它反映了
大部分字符设备的本质特征，用于控制字符设备的I/O。
（1）字符设备。所谓字符设备，是指数据的存取和传输是以字符（字节）为单位的设备，
如键盘、打印机等。字符设备的基本特征是传输速率较低，通常为每秒几B 至数千B。其另一特
征是不可寻址，即不能指定数据的输入源地址以及输出的目标地址。字符设备在 I/O时通常采用
中断驱动I/O方式。
（2）get操作和put操作。由于字符设备是不可寻址的，因而对它只能采取顺序存取方式。
通常会为字符设备建立一个字符缓冲区（队列），设备的 I/O字节流顺序地进入字符缓冲区（读
入），或从字符缓冲区顺序地送出到设备（输出）。用户程序获取或输出字节的方法是采用get
操作和put操作。get操作用于从字符缓冲区取得一个字节（到内存），并将它返回给调用者。而
put操作则用于将一个新字节（从内存）输出到字符缓冲区，以待送出到设备。
（3）in-control指令 。因字符设备的类型非常多，且差异甚大，所以为了以统一的方式
来处理它们，通常会在字符设备接口中提供一种通用的in-control指令。该指令中包含了许多参
数，每个参数均表示一个与具体设备相关的特定功能。
因为大多数字符设备都属于独占设备，所以必须采取互斥方式实现共享。为此，字符设备
接口提供了打开操作和关闭操作。在使用此类设备时，必须先用打开操作来打开设备。如果设
备已被打开，则表示它正被其他进程使用。
3．网络通信接口
在现代OS中，都提供了面向网络的功能。但首先还需要通过某种方式，把计算机连接到网
络上。同时OS也必须提供相应的网络软件和网络通信接口，以使计算机能通过网络同网络上的
其他计算机进行通信，或上网浏览信息。由于网络通信接口涉及许多关于网络的知识，如网络
中的各种硬件、网络通信协议和网络的层次结构等，这里将不再对其做专门的介绍，读者如有
兴趣可查阅相关书籍以了解之。
目前，随着 I/O 设备种类的增加，现代 OS 是如何有效进行 I/O 设备管理的？
思考题
7.2　I/O设备和设备控制器
I/O设备一般是由执行I/O操作的机械部分和执行I/O控制的电子部件组成的。通常会将这两
部分分开，执行I/O操作的机械部分就是一般的I/O设备，而执行I/O控制的电子部件，则称为设
备控制器或适配器（adapter）。微机和小型计算机中的控制器，常做成印刷电路卡的形式，因
而它也常被称为控制卡、接口卡或网卡，可将它插入计算机的扩展槽中。在有的大、中型计算
机系统中，还配置了I/O通道或I/O处理机。
7.2.1　I/O 设备
1．I/O 设备的类型
I/O设备的类型繁多，除了能将它们分为块设备和字符设备，独占设备和共享设备外，还可

--- Page 226 ---
205
第
7章 
输入/输出系统
从设备的使用特性上将它们分为存储设备和 I/O设备，以及从设备的传输速率上将它们分为低速
设备、中速设备和高速设备。
（1）按使用特性分类 。第一类是存储设备，也称为外存、辅存，是用于存储信息的主要
设备。该类设备存取速度较内存慢，但容量较内存却大得多，价格也便宜。第二类是 I/O设备，
它又可分为输入设备、输出设备和交互式设备。输入设备用于接收外部信息，如键盘、鼠标、
扫描仪、视频摄像机等。输出设备用于将计算机处理后的信息送向处理机外部的设备，如打印
机、绘图仪等。交互式设备则集成了上述两类设备，主要有显示器等，用于同步显示用户命令
以及命令执行的结果。
（2）按传输速率分类 。按传输速率的高低，可将I/O设备分为三类。第一类是低速设备，
其传输速率仅为每秒几字节至数百字节，典型的低速设备有键盘、鼠标等。第二类是中速设
备，其传输速率为每秒数千字节至数十万字节，典型的中速设备有行式打印机、激光打印机
等。第三类是高速设备，其传输速率为每秒数十万字节至千兆字节，典型的高速设备有磁带
机、磁盘机、光盘机等。
2．设备与设备控制器之间的接口
通常，设备并不直接与CPU进行通信，而是与设备控制器进行通信，因此，在I/O设备中应含
有与设备控制器之间的接口，在该接口中有三类信号（见图7-4），各对应一条信号线。
I/O设备
缓冲 转换器
控制逻辑
信号
数据
至设备
控制器
数据信号线
状态信号线
控制信号线
图 7-4　设备与设备控制器之间的接口
（1）数据信号线。这类信号线用于在设备和设备控制器之间传送数据信号。对输入设备而
言，由外界输入的信号经转换器转换所形成的数据，通常会先送入缓冲器中，当数据量达到一
定的比特（字节）数后，再从缓冲器通过一组数据信号线传送给设备控制器，如图 7-4所示。对
输出设备而言，则是将从设备控制器经过数据信号线传送来的一批数据，先暂存于缓冲器中，
经转换器做适当转换后再逐个字符地输出。
（2）控制信号线 。这类信号线被作为由设备控制器向I/O设备发送控制信号的通路。该控
制信号规定了设备将要执行的操作，如读操作（由设备向设备控制器传送数据），或写操作
（从设备控制器接收数据），或执行磁头移动操作等。
（3）状态信号线。这类信号线用于传送指示设备当前状态的信号。设备的当前状态有正在
读（或写）、设备已读（或写）完成、准备好了新的需要传送的数据等。
7.2.2　设备控制器
设备控制器的主要功能是，控制一个或多个I/O设备，以实现I/O设备和计算机之间的数据交
换。它是CPU与I/O设备之间的接口，接收从CPU发来的命令，去控制I/O设备工作，使CPU能够
从繁杂的设备控制事务中解脱出来。设备控制器是一个可编址的设备，当仅控制一个设备时，
它只有一个唯一的设备地址；若设备控制器连接多个设备，则其应含有多个设备地址，每个设
备地址对应一个设备。可把设备控制器分成两类：一类是用于控制字符设备的控制器，另一类

--- Page 227 ---
206
计算机操作系统 （慕课版）
是用于控制块设备的控制器。
1．设备控制器的基本功能
（1）接收和识别命令。设备控制器能接收并识别处理机发来的多种命令。在控制器中具有
相应的控制寄存器，用于存放接收的命令和参数，并对所接收的命令进行译码。例如，磁盘控
制器可以接收CPU发来的read、 write、format等15条不同的命令，而且有些命令还带有参数。相
应地，在磁盘控制器中有多个寄存器和命令译码器。
（2）数据交换。设备控制器能实现CPU与设备控制器之间、设备控制器与设备之间的数据
交换。前者通过数据总线，由CPU并行地把数据写入设备控制器，或从设备控制器中并行地读
出数据。后者通过寄存器，由设备将数据输入设备控制器，或由设备控制器传送数据给设备。
为此，在设备控制器中须设置数据寄存器。
（3）标志和报告设备的状态。设备控制器会记下设备的状态以供CPU了解。例如，仅当该
设备处于发送就绪状态时，CPU才能启动设备控制器从设备中读出数据。为此，在设备控制器
中应设置一状态寄存器，用其中的某一位来反映设备的某一种状态。当CPU将该寄存器的内容
读入后，便可了解该设备的状态。
（4）地址识别。设备控制器是一个可编址的设备，其必须能够识别自身所控制的每个设备
的地址。当控制一个设备时，其只有一个唯一的设备地址；当控制多个设备时，其含有多个设
备地址，并使每个设备地址对应一个设备。此外，为使CPU能向（或从）寄存器中写入（或读
出）数据，这些寄存器都应具有唯一的地址。设备控制器应能正确识别这些地址，为此，在设
备控制器中应配置地址译码器。
（5）数据缓冲区 。由于I/O设备的数据传输速率较低，而CPU和内存的速率却很高，故在
设备控制器中必须设置一缓冲区。在输出时，用此缓冲区暂存由主机高速传来的数据，然后再
以I/O设备所具有的传输速率将缓冲区中的数据传送给I/O设备。在输入时，缓冲区则用于暂存从I/
O设备传来的数据，待接收到一批数据后，再将缓冲区中的数据高速地传送给主机。
（6）差错控制。对于由I/O设备传送来的数据，设备控制器还兼管差错检测。若发现传送
中出现了错误，则通常会将差错检测码置位，并向CPU报告，于是CPU将本次传送来的数据作
废，并重新进行一次传送。这样便可保证数据输入的正确性。
2．设备控制器的组成
由于设备控制器位于CPU与设备之间，它既要与CPU通信，又要与设备通信，还应具有按
照CPU所发来的命令去控制设备工作的功能，因此，现有的大多数设备控制器都是由以下三部
分组成的。
（1）设备控制器与CPU的接口 。该接口用于实现CPU与设备控制器之间的通信，在该接
口中共有三类信号线：数据线、地址线和控制线。数据线通常与两类寄存器相连接：①第一类
是数据寄存器，在设备控制器中可以有一个或多个数据寄存器，用于存放从设备传送来的数据
（输入），或从CPU传送来的数据（输出）；②第二类是控制/ 状态寄存器，在设备控制器中可
以有一个或多个此类寄存器，用于存放从CPU送来的控制信息或设备的状态信息。
（2）设备控制器与设备的接口 。在一个设备控制器上，可以连接一个或多个设备。相应
地，在设备控制器中便有一个或多个设备接口。在每个接口中都存在数据、控制和状态这三种
类型的信号。设备控制器中的I/O逻辑会根据处理机发来的地址信号去选择一个设备接口。
（3）I/O逻辑。I/O逻辑用于实现对设备的控制。它通过一组控制线与CPU交互，CPU利用

--- Page 228 ---
207
第
7章 
输入/输出系统
该逻辑，向控制器发送I/O命令。CPU每当要启动一个设备时，一方面会将启动命令发送给设备控
制器，另一方面又会通过地址线把地址发送给设备控制器，由设备控制器根据I/O逻辑对地址进行
译码，再根据所译出的命令对所选设备进行控制。设备控制器的组成如图7-5所示。
设备控制器与CPU接口
数据线
设备控
制器与
设备
接口1
数据
状态
控制
数据
状态
控制
设备控
制器与
设备
接口i
地址线
控制线
数据寄存器
控制/状态
寄存器
I/O
逻辑
…
…
设备控制器与设备接口
图 7-5　设备控制器的组成
7.2.3　内存映像 I/O
驱动程序将抽象I/O命令转换出的一系列具体的命令、参数等数据，装入设备控制器的相应
寄存器中，由设备控制器来执行这些命令，具体实施对 I/O设备的控制。这一工作可采用以下两
种方法完成。
1．采用特定 I/O 指令形式
在早期的计算机（包括大型计算机）中，为实现CPU和设备控制器之间的通信，为每个控
制寄存器分配一个I/O端口，端口号是一个8 位或16位的整数，如图7-6 （a）所示。另外还设置
了一些特定的I/O指令。例如，为了将 CPU寄存器中的内容复制到设备控制器寄存器中，所须使
用的特定I/O指令可表示如下：
io-store　cpu-reg, dev-no, dev-reg
其中，cpu-reg是CPU的某个寄存器；dev-no是指定的设备控制器的地址；dev-reg是指定设备控制器
中的寄存器。如果是将CPU寄存器中的内容存入内存的某个单元（k）中，则将使用下面的指令：
Store　cpu-reg, k
该方法的主要缺点是，访问内存和访问设备需要两种不同的指令。
2．采用内存映像 I/O 形式
在采用内存映像I/O形式这一方法中，在编址上不再区分内存单元地址和设备控制器中的寄
存器地址，都采用 k。当k值处于0～n-1这一范围时，被认为是内存地址，若 k≥n，则被认为是
某个设备控制器的寄存器地址。由图7-6 （b）可以看出，当 k=n时，表示设备控制器0 的第1个
寄存器opcode的地址。因此，如果想将CPU寄存器中的内容传送到设备控制器0 的第1个寄存器
opcode，则只须使用如下所示的一般的存储指令即可。
Store　cpu-reg, n
采用内存映像I/O形式统一了对内存和对设备控制器的访问方法，这无疑会简化I/O设备的
编程。

--- Page 229 ---
208
计算机操作系统 （慕课版）
地址
内存 内存
0
dev_0
dev_1
n-1
0
n-1
n
n+1
n+2
…
…
…
…
地址
opcode
Operand 0
Operand 1
设备
控制器 0
…
opcode
Operand 0
Operand 1
设备
控制器 1
…
opcode
Operand 0
Operand 1
设备
控制器 0
…
opcode
Operand 0
Operand 1
设备
控制器 1
（a）采用特定I/O指令形式 （b）采用内存映像I/O形式
图 7-6　设备寻址形式
7.2.4　I/O 通道
1．I/O 通道设备的引入
虽然在CPU与I/O设备之间增加了设备控制器后，能大大减少CPU对I/O设备的干预，但当主
机所配置的I/O设备有很多时， CPU的负担仍然会很重。为此，在 CPU和设备控制器之间又增设
了通道（channel），其主要目的是建立独立的I/O操作，即不仅使数据的传送能独立于CPU，而
且使对I/O操作的组织、管理及其结束处理尽量独立，以保证 CPU有更多的时间进行数据处理；
或者说，其目的是使一些原来由CPU处理的I/O任务转由通道来承担，从而把CPU从繁杂的I/O任
务中解脱出来。在设置了通道后， CPU只须向通道发送一条 I/O指令。通道在接收到该指令后，
便会从内存中取出本次要执行的通道程序，然后执行该程序；仅当通道完成了规定的I/O任务
后，才向CPU发送中断信号。
实际上，I/O通道是一种特殊的处理机，它具有执行I/O指令的能力，并能通过执行（I/O）
通道程序来控制I/O操作。但I/O通道又与一般的处理机不同，主要表现在以下两个方面：一是I/O通
道指令类型单一（这是由通道硬件比较简单所致），其所能执行的命令主要局限于与 I/O操作有
关的指令；二是I/O通道没有自己的内存，所执行的通道程序是放在主机的内存中的，换言之，
是I/O通道与CPU共享内存。
2．通道类型
前已述及，通道是用于控制外围设备（包括字符设备和块设备）的。由于外围设备的类型
较多，且它们的传输速率相差甚大，因此通道也具有多种类型。这里，根据信息交换方式的不
同，可把通道分成以下3类。
（1）字节多路通道。
字节多路通道（byte multiplexor channel）是一种按字节交叉方式工作的通道。它通常含有

--- Page 230 ---
209
第
7章 
输入/输出系统
许多非分配型子通道，其数量可为几十到数百个，每个子通道均连接一台 I/O设备，并控制该设
备的I/O操作。这些子通道按时间片轮转方式共享主通道。当第一个子通道控制其I/O设备完成
一个字节的交换后，其便会立即腾出主通道，让给第二个子通道使用；当第二个子通道也完成
一个字节的交换后，同样也会把主通道让给第三个子通道；依此类推。当所有子通道轮转一周
后，再由第一个子通道去使用字节多路主通道。这样，只要字节多路主通道扫描每个子通道的
速率足够快，并且连接到子通道上的设备的速率又不是太高，便不会导致丢失信息。
图7-7所示为字节多路通道的工作原理。它所含有的多个子通道A ，B，C，D，…，N，分
别通过设备控制器各与一台设备相连。假定这些设备的速率相近，且都同时向主机传送数据。
设备A 所传送的数据流为A1， A2， A3，…；设备B 所传送的数据流为B1， B2， B3，…；以
此类推。把这些数据流合成后（通过主通道）送往主机，合成以后的数据流为A1， B1，C1，
D1，…，A2，B2，C2，D2，…，A3，B3，C3，D3，…。
A1B1C1…A2B2C2…
A1A2…子通道A
设备控制器A
设备
设备控制器B
设备控制器C
设备控制器D
设备控制器N
B1B2…子通道B
C1C2…子通道C
D1D2…子通道D
N1N2…子通道N
…
…
图 7-7　字节多路通道的工作原理
（2）数组选择通道。
字节多路通道不适用于连接高速设备，这推动了按数组方式进行数据传送的数组选择通道
（block selector channel ）的形成。这种通道虽然可以连接多台高速设备，但由于它只含有一个
分配型子通道，在一段时间内只能执行一道通道程序，控制一台设备进行数据传送，这致使当
某台设备占用了该通道后，便会一直由它独占，即使它无数据传送，闲置的通道也不允许其他
设备使用，直至该设备传送完毕并释放该通道。可见，这种通道的利用率很低。
（3）数组多路通道。
数组选择通道虽有很高的传输速率，但它每次只允许一个设备传输数据。数组多路通道
（block multiplexor channel）是通过结合两个优点（即数组选择通道传输速率高和字节多路通道
能使各子通道分时并行操作）而形成的一种新通道。它含有多个非分配型子通道，因而这种通
道既具有很高的数据传输速率，又能获得令人满意的通道利用率。也正因此，才使该通道能被
广泛地用于连接多台高、中速的外围设备，其数据传送是按数组方式进行的。
3． “瓶颈”问题
由于通道价格昂贵，机器中所设置的通道数量势必较少，这往往又会使它成为I/O的瓶颈，
进而造成整个系统吞吐量下降。例如，在图7-8中，假设设备1 至设备4是四个磁盘，为了启动磁
盘4，必须用通道1 和设备控制器2 ；但若这两者已被其他设备占用，则必然无法启动磁盘4 。类
似地，若要启动磁盘1和磁盘2，则由于它们都要用到通道1，因而也不可能启动。这些就是由通
道不足所造成的“瓶颈”现象。

--- Page 231 ---
210
计算机操作系统 （慕课版）
存储器
通道1
设备控制器1
设备1
设备2
设备3
设备4
设备5
设备6
设备7
设备控制器2
设备控制器3
设备控制器4
通道2
图 7-8　单通路 I/O 系统
解决“瓶颈”问题最有效的方法，便是增加设备到主机间的通路而不增加通道，如图7-9
所示。换言之，就是把一个设备连接到多个设备控制器上，而把一个设备控制器又连接到多
个通道上。图7-9中的设备1 、2、3、4都有4 条通往存储器的通路。例如，设备4 可通过设备
控制器1 和通道1 到存储器，也可通过设备控制器2 和通道1 到存储器。多通路方式不仅解决了
“瓶颈”问题，而且提高了系统的可靠性，因为个别通道或设备控制器的故障不会使设备和
存储器之间没有通路。
存储器
通道1
设备控制器1
设备控制器2
通道2
设备1
设备2
设备3
设备4
图 7-9　多通路 I/O 系统
7.2.5　I/O 设备的控制方式
对I/O设备的控制，早期是使用轮询的可编程I/O方式，后来发展为使用中断的可编程I/O方
式。随着DMA控制器的出现，以字节为单位进行传输变为了以数据块为单位进行传输，这大大
改善了块设备的I/O性能。I/O通道的出现，又使对I/O操作的组织和数据的传输都能独立进行，
而无需CPU的干预。应当指出，在I/O设备的控制方式的整个发展过程中，始终贯穿着这样一条
宗旨：尽量减少主机对I/O控制的干预，把主机从繁杂的I/O控制事务中解脱出来，以便其能更多
地去完成数据处理任务。
1．使用轮询的可编程 I/O 方式
处理机对I/O设备的控制采取轮询的可编程I/O方式（程序轮询I/O方式），即在处理机向设
备控制器发出一条I/O指令，启动输入设备输入数据时，要同时把状态寄存器中的忙/ 闲标志busy
置为1，然后便不断地循环测试busy（称为轮询）。当busy=1时，表示输入机尚未输完一个字
（节），处理机应继续对该标志进行测试，直至busy=0，表明输入机已将输入数据送入控制器
的数据寄存器中。于是处理机将数据寄存器中的数据取出，送入内存的指定单元中，这样便完

--- Page 232 ---
211
第
7章 
输入/输出系统
成了一个字（节）的I/O操作。接着再去读下一个数据，并置busy=1。图7-10 （a）所示为程序
轮询I/O方式的流程。
（a）程序轮询I/O方式 （b）中断驱动I/O方式 （c）DMA方式
向I/O控制器
发读命令 CPU→I/O
CPU→内存
I/O→CPU
I/O→CPU从I/O控制器
中读入字
向存储器
中写字
读I/O控制器
的状态
未完成
未就绪
检查状态
出错
传送完成？
完成
下一条指令
就绪
向I/O控制器
发读命令
向I/O控制器
发读块命令
读DMA控制器
的状态
CPU→I/O
CPU→DMA
DMA→CPU
CPU→内存
I/O→CPU
I/O→CPU从I/O控制器
中读入字
向存储器
中写字
读I/O控制器
的状态
未完成
检查状态
出错
传送完成？
完成
下一条指令 下一条指令
就绪
CPU做其他事
CPU做其他事
中断
中断
图 7-10　I/O 设备的控制方式流程
在程序轮询 I/O方式中， CPU的绝大部分时间都用于等待 I/O设备完成数据 I/O的循环测试
中，这造成了对CPU的极大浪费。在该方式中， CPU之所以要不断测试 I/O设备的状态，是因为
在CPU中无中断机构，这使I/O设备无法向CPU报告它已完成了一个字节的输入操作。
2．使用中断的可编程 I/O 方式
当前，对I/O设备的控制，广泛采用中断的可编程I/O方式（中断驱动I/O方式），即当某进
程要启动某个I/O 设备工作时，便由CPU 向相应的设备控制器发出一条I/O 命令，然后立即返回
继续执行原来的任务。设备控制器接收到命令后会按照该命令的要求去控制指定的 I/O设备。此
时，CPU与I/O设备并行操作。例如，在输入时，当设备控制器收到 CPU发来的读命令后，便去
控制相应的输入设备读数据。一旦数据进入数据寄存器，设备控制器便会通过控制线向CPU发
送一中断信号，由CPU检查输入过程中是否出错；若无错，便向设备控制器发送取走数据的信
号，然后再通过设备控制器以及数据线将数据写入内存指定单元中。图7-10（ b）所示为中断驱
动I/O方式的流程。
在I/O设备输入每个数据的过程中，可使CPU与I/O设备并行工作。仅当输入完一个数据时，
才需要CPU花费极短的时间去做一些中断处理。这样可使 CPU和I/O设备都处于忙碌状态，从而
提高整个系统的资源利用率及吞吐量。例如，从终端输入一个字节的时间约为100ms，而将字节
送入终端缓冲区的时间小于0.1ms。若采用程序轮询I/O方式，则CPU约有99.9ms的时间处于“忙
等”中。但采用中断驱动I/O方式后，CPU可利用这99.9ms的时间去做其他事情，而仅用0.1ms的
时间来处理由设备控制器发来的中断请求。可见，中断驱动 I/O方式可以成百上千倍地提高 CPU
的利用率。

--- Page 233 ---
212
计算机操作系统 （慕课版）
3．直接存储器访问（DMA）方式
（1）DMA方式的引入。
虽然中断驱动I/O方式比程序轮询I/O方式更有效，但它仍是以字（节）为单位进行I/O操作
的。每当完成一个字（节）的I/O操作，设备控制器便要向CPU请求一次中断。换言之，采用中
断驱动I/O 方式时的CPU 是以字（节）为单位进行干预的。如果将这种方式用于块设备的I/O 操
作，显然是极其低效的。例如，为了从磁盘中读出1KB的数据块，需要中断CPU 1K次。为了进
一步减少CPU对I/O设备的干预，引入了DMA方式，如图7-10（c）所示。
该方式的特点是：①数据传输的基本单位是数据块，即在CPU与 I/O设备之间，每次至少传
送一个数据块；②所传送的数据是从 I/O设备直接送入内存的，或者相反；③仅在传送一个或多
个数据块的开始和结束时，才须CPU干预，整块数据的传送是在DMA控制器的控制下完成的。
可见，DMA方式较中断驱动I/O方式，又进一步提高了CPU与I/O设备的并行操作程度。
（2）DMA控制器的组成。
DMA控制器由3部分组成：主机与DMA控制器的接口；DMA控制器与块设备的接口；I/O控
制逻辑。图7-11所示为DMA控制器的组成。这里主要介绍主机与DMA控制器的接口。
CPU
命令 系统总线
I/O
控制
逻辑
…
count
DR
MAR
DC
CR
DMA控制器
内存 主机与DMA控制器的接口 DMA控制器与块设备的接口
图 7-11　DMA 控制器的组成
为了实现在主机与DMA控制器之间直接交换成块的数据，必须在DMA控制器中设置如下4
类寄存器：①命令寄存器（command register， CR），用于接收从CPU发来的I/O命令，或有关
控制信息，或设备的状态；②内存地址寄存器（memory address register， MAR），在输入时，
它存放把数据从设备传送到内存的起始目标地址，在输出时，它存放由内存到设备的内存源地
址；③数据寄存器（data register， DR），用于暂存从设备到内存或从内存到设备的数据；  
④数据计数器（data counter，DC），用于存放本次CPU要读或写的字（节）数。
（3）DMA控制器的工作过程。
当CPU要从磁盘读入一个数据块时，其便会向磁盘控制器发送一条读命令。该命令会被送
入命令寄存器中。同时，还须将本次要读入的数据在内存中的起始目标地址送入内存地址寄存
器中。将要读数据的字（节）数送入数据计数器中，还须将磁盘中的源地址直接送至DMA控制
器的I/O控制逻辑上。然后，启动DMA控制器进行数据传送。以后，CPU便可去处理其他任务
了，整个数据传送过程由DMA控制器进行控制。当DMA控制器已从磁盘中读入一个字（节）的
数据并送入数据寄存器后，再挪用一个存储器周期，以将该字（节）传送到内存地址寄存器所
指示的内存单元中。然后便对内存地址寄存器的内容加 1，将数据计数器的内容减1，若减1后数
据计数器的内容不为0，则表示传送未完，继续传送下一个字（节）；否则，表示传送结束，并
由DMA控制器发出中断请求。图7-12所示为DMA方式的工作流程。

--- Page 234 ---
213
第
7章 
输入/输出系统
设置MAR和DC初值
启动DMA传送数据
挪用存储器周期
传送数据字
内存地址寄存器加1
数据计数器减1
请求中断
是
否
在继续执行用户程序
的同时，准备下一次传送
DC=0?
图 7-12　DMA 方式的工作流程
4．I/O 通道方式
（1）I/O通道方式的引入。
虽然DMA方式比中断驱动I/O方式已经显著减少了CPU的干预，即已由以字（节）为单位的
干预减少到了以数据块为单位的干预，但 CPU每发出一条I/O指令，也只能去读（或写）一个连
续的数据块。而当我们需要一次去读多个数据块且将它们分别传送到不同的内存区域（或者相
反）时，就须由CPU分别发出多条I/O指令并进行多次中断处理。
I/O通道方式是DMA方式的发展，它可进一步减少CPU的干预，即把对一个数据块以读（或
写）为单位的干预，减少为对一组数据块以读（或写）及有关的控制和管理为单位的干预。同
时，又可实现CPU、通道和I/O设备三者的并行操作，从而更有效地提高整个系统的资源利用
率。例如，当CPU要完成一组相关的读（或写）操作及有关控制时，只须向I/O通道发送一条I/O
指令，以给出其所要执行的通道程序的起始地址和要访问的 I/O设备，通道接到该指令后，通过
执行通道程序便可完成CPU指定的I/O任务。
（2）通道程序。
通道是通过执行通道程序并与设备控制器共同工作来实现对I/O设备的控制的。通道程序是
由一系列通道指令（或称为通道命令）所构成的。通道指令与一般的机器指令不同，在它的每
条指令中都包含了下列信息。
① 操作码，规定了指令所执行的操作，如读、写、控制等。
② 内存地址，表示字节送入内存（读操作）和从内存取出数据（写操作）时的内存起始地址。
③ 计数，表示本条指令所要读（或写）的数据的字节数。
④ 通道程序结束位P，用于表示通道程序是否结束；P=1表示本条指令是通道程序的最后一
条指令。
⑤ 记录结束标志R，R=0表示本通道指令与下一条指令所处理的数据同属于一个记录，R=1
表示这是处理某记录的最后一条指令。
下面给出了一个由六条通道指令所构成的简单的通道程序。该程序的功能是将内存中
不同地址的数据写成多个记录。其中，前3 条指令分别将813 ～892单元中的80个字符、1 034 ～ 
1 173单元中的140个字符、5 830～5 889单元中的60个字符写成一个记录；第4条指令单独写一个
具有300个字符的记录；第5、6条指令共写含300个字符的记录。

--- Page 235 ---
214
计算机操作系统 （慕课版）
指令编号 操作符 P R 计数 内存地址
1 WRITE 0 0 80 813
2 WRITE 0 0 140 1 034
3 WRITE 0 1 60 5 830
4 WRITE 0 1 300 2 000
5 WRITE 0 0 50 1 650
6 WRITE 1 1 250 2 720
7.3　中断和中断处理程序
对于OS中的I/O系统，本章采取从低层向高层这一介绍方法，从本节开始首先介绍中断处理
程序。中断在OS中有着特殊且重要的地位，它是多道程序得以实现的基础，没有中断就不可能
实现多道程序，因为进程之间的切换是通过中断来完成的。另外，中断也是设备管理的基础，
为了提高CPU的利用率并实现 CPU与I/O设备并行执行，也必须有中断的支持。中断处理程序是
I/O系统中最低的一层，它是整个I/O系统的基础。
7.3.1　中断简介
1．中断和陷入
（1）中断（interrupt）。中断是指CPU对I/O设备发来的中断信号的一种
响应。CPU暂停正在执行的程序，保存CPU现场环境后，自动转去执行该I/O设
备的中断处理程序。执行完后再回到断点，继续执行原来的程序。I/O设备可以是字符设备，也可
以是块设备以及通信设备等。由于中断是由外部设备引起的，故其又被称为外中断或硬中断。
（2）陷入或陷阱（trap）。另外还有一种由CPU内部事件所引起的中断，例如进程在运算
过程中发生了上溢或下溢，再如程序出错（如指令非法、地址越界、电源故障等）以及执行到
程序中预设的软中断指令。通常把这类中断称为内中断，或软中断，或陷入。与中断一样，若
系统发现了陷入事件，CPU也将暂停正在执行的程序，转去执行该陷入事件的处理程序。中断
和陷入的主要区别是信号的来源不同，即来自CPU外部还是CPU内部。
2．中断向量表和中断优先级
（1）中断向量表。为了实现处理上的方便，通常会为每种设备配以相应的中断处理程序，
并把该程序的入口地址放在中断向量表的一个表项中，为每个设备的中断请求规定一个中断
号，它直接对应中断向量表的一个表项。当 I/O设备发来中断请求信号时，由中断控制器确定该
请求的中断号，并根据该中断号查找中断向量表，从中取得该设备相应的中断处理程序的入口
地址，这样便可转入中断处理程序并执行。
（2）中断优先级。实际情况是经常会有多个中断信号源，每个中断信号源对服务要求的紧
急程度并不相同，例如，键盘的中断请求的紧急程度不如打印机，而打印机的中断请求的紧急
程度又不如磁盘等。为此，系统就需要为它们分别规定不同的优先级。
3．处理多中断信号源的方式
针对多中断信号源情况，当处理机正在处理一个中断时，又来了一个新的中断请求，这时
中断及其处理


--- Page 236 ---
215
第
7章 
输入/输出系统
应该如何处理？例如，当系统正在处理打印机中断时，又收到了优先级更高的磁盘中断信号。
对于这种情况，可采用以下两种处理方式。
（1）屏蔽（禁止）中断 。当处理机正在处理一个中断时，将“屏蔽”掉所有的中断，即
处理机对任何新到的中断请求都暂时不予理睬，而让它们等待。直到处理机已完成本次中断的
处理后，才去检查是否有新的中断发生。若有，再去处理新的中断；若无，则返回被中断的程
序。在该方法中，所有中断都将按顺序排队依次被处理。其优点是简单，但不能用于对实时性
要求较高的中断请求。图7-13 （a）所示为多中断情况下的顺序中断处理。
（2）嵌套中断。在设置了中断优先级的系统中，通常按以下规则来控制优先级：①当同时
有多个优先级不同的中断请求时，CPU优先响应最高优先级的中断请求；②高优先级的中断请
求可以抢占正在运行的低优先级中断的处理机，该方式类似于基于优先级的抢占式进程调度。
例如，处理机正在处理打印机中断，当有磁盘中断到来时，可暂停对打印机中断的处理而转去
处理磁盘中断。如果新到的是键盘中断，则由于它的优先级低于打印机的，故处理机会继续处
理打印机中断。图7-13 （b）所示为多中断情况下的嵌套中断处理。
用户程序 用户程序中断处理器X 中断处理器X
中断处理器Y
（a）顺序中断处理 （b）嵌套中断处理
中断处理器Y
图 7-13　对多中断的处理方式
7.3.2　中断处理程序
当一个进程请求I/O操作时，该进程将被挂起，直到I/O设备完成I/O操作后，设备控制器才
会向CPU发送一中断请求，CPU响应后便转向中断处理程序，中断处理程序执行相应的处理，
并在处理完后解除相应进程的阻塞状态。中断处理程序的处理过程可分成以下几个步骤。
1．测定是否有未响应的中断信号
每当设备完成一个字符（字或数据块）的读入（或输出），设备控制器便会向CPU发送一
中断请求信号，请求CPU将设备已读入的数据传送到内存的缓冲区中（读入），或者请求CPU
将要输出的数据传送给设备控制器（输出）。程序每当执行完当前指令后，CPU都要测试是否
有未响应的中断信号。若没有，则继续执行下一条指令；若有，则停止原有进程的执行，准备
转去执行中断处理程序，即为把CPU的控制权转交给中断处理程序做准备。
2．保护被中断进程的 CPU 现场环境
在把控制权转交给中断处理程序之前，需要先保护被中断进程的CPU现场环境，以便以后
能恢复运行。首先需要保存的是从中断现场恢复到当前进程运行所需要的信息。通常由硬件自

--- Page 237 ---
216
计算机操作系统 （慕课版）
动将处理机状态字（processor status word，PSW）和保存在程序计数器（program counter ，PC）
中下一条指令的地址，保存在中断保留区（中断栈）中。然后，把被中断进程的CPU现场信
息，即所有CPU寄存器（如通用寄存器、段寄存器等）的内容，都压入中断栈中，因为在处
理中断时可能会用到这些寄存器。图7-14所示为一个简单的保护中断现场示意。该用户程序
是指令在 N位置时被中断的，程序计数器中的内容为 N+1，所有寄存器的内容都被保留在中
断栈中。
PSW T+M T
PC（N+1）
PSW
PC（N+1）
处理机状态字
程序计数器
用户程序
中断处理子例程 中断栈
返回
开始
寄存器
线指针Rn
R0
Rn
R0
…
…
…
Y
N
N-1
图 7-14　保护中断现场示意
3．转入相应设备的中断处理程序
由CPU对各个中断信号源进行测试，以确定引起本次中断的I/O设备，并向提供中断信号的
设备发送确认信号。在该设备收到确认信号后，就立即取消它所发出的中断请求信号。然后，
将相应设备的中断处理程序的入口地址装入程序计数器中。这样，当CPU运行时，便可自动转
入相应设备的中断处理程序。
4．处理中断
对不同的设备有不同的中断处理程序。该程序首先会从设备控制器中读出设备状态，以
判别本次中断是正常完成中断还是异常结束中断。若是正常完成中断，中断处理程序便做结束
处理。假如这次是字符设备的读操作，则来自输入设备的中断表明该设备已经读入了一个字节
（字）的数据，并已放入数据寄存器中。此时中断处理程序应将该数据传送给CPU，再将它存
入缓冲区中，并修改相应的缓冲区指针，使其指向下一个内存单元。若还有命令，则可再向设
备控制器发送新的命令，进行新一轮的数据传送。若是异常结束中断，则根据发生异常的原因
做相应的处理。
5．恢复 CPU 现场环境后退出中断
当中断处理完成以后，需要恢复CPU现场并退出中断。但是，此刻是否返回被中断的进
程，取决于两个因素：①本中断是否采用了屏蔽（禁止）中断驱动 I/O方式，若是，则返回被中
断的进程；②针对中断处理方式为中断嵌套方式的情况，如果没有优先级更高的中断来请求I/O，
则在中断处理完成后仍返回被中断的进程；反之，系统将处理优先级更高的中断请求。
如果要返回到被中断的进程，则可将保存在中断栈中的被中断进程的CPU现场信息取出，
并装入相应的寄存器中，其中包括该程序下一次要执行的指令的地址N+1、处理机状态字以及各
通用寄存器和段寄存器的内容。这样，当CPU再执行本程序时，便会从N+1处开始，最终返回被

--- Page 238 ---
217
第
7章 
输入/输出系统
中断的进程。
I/O操作完成后，驱动程序必须检查本次I/O操作中是否发生了错误，并向上层软件报告，最
终向调用者报告本次I/O的执行情况。除了上述的第4 步（处理中断）外，其他步骤对所有I/O设
备都是相同的，因而对于某种OS，如UNIX系统，其会把这些共同的部分集中起来，形成中断总
控程序。每当要进行中断处理时，都要首先进入中断总控程序。而对于第4 步，则对不同设备须
采用不同的中断处理程序继续执行。图7-15所示为中断处理流程。
唤醒被阻塞的
驱动程序进程
中断请求信号
对被中断进程的CPU
现场环境进行保护
分析中断原因，转入
相应的中断处理程序
中断
处理程序
中断
处理程序 … 中断
处理程序
恢复被中断
进程的CPU现场
返回被中断的进
程，继续执行
图 7-15　中断处理流程
7.3.3　实例 ： Linux 系统中断处理
在Linux系统中，中断会打断内核中进程的正常调度运行，因此要求中断处理程序尽可能简短。
但是在实际的Linux系统中，当中断到来时，往往要完成大量的耗时工作。因此，期望中断处理程序
运行得快，并且完成的工作多。这两个目标是相互制约的，为此，Linux系统中引入了上/下半部机
制：上半部是中断处理程序，而下半部则是一些虽与中断有关但是可以延后执行的任务。上半部简
单快速，执行时会禁止一些（或全部）中断；下半部延后执行，而且在执行期间可以响应所有的中
断。这种机制可使系统处于中断屏蔽状态的时间尽可能短，以此来提高系统的响应能力。
在Linux系统中，不同的设备对应的中断不同，每个中断都会通过一个唯一的数字（中
断值）进行标志，以使OS能够对中断进行区分。这些中断值通常被称为中断请求（interrupt 
request，IRQ），IRQ为数值型。在响应一个特定中断的时候，内核会执行一个函数，即中断处
理程序。例如，由一个函数专门处理来自系统时钟的中断，而另一个函数专门处理由键盘产生
的中断。一个设备的中断处理程序是其设备驱动程序的一部分，设备驱动程序是用于对设备进
行管理的内核代码。
在Linux系统中，中断处理程序是普通的C 函数，只不过这些函数必须按照特定的类型进行
声明，以便内核能够以标准的方式传递中断处理程序的信息。在其他方面，它们与一般的函数
没有差别。中断处理程序的设计可分为3个部分：①注册中断；②处理中断；③注销中断。
1．注册中断
request_irq函数用于注册一个中断处理程序，声明位于文件linux/interrupt.h中。该函数若执

--- Page 239 ---
218
计算机操作系统 （慕课版）
行成功，则返回0 ；若返回非0值，则表示有错误发生，此时指定的中断处理程序不会被注册。
具体函数说明如下：
1　　 int request_irq(unsigned int irq, 
2　　                          void(*handler)(int, void*, struct pt_regs *), 
3　       　                   unsigned long flags, const char*devname, void*dev_id)
第1个参数irq：要分配的中断号。
第2个参数*handler：一个指针，指向处理这个中断的实际中断处理函数。
第3个参数flags：与中断管理有关的各种选项，其定义位于文件linux/interrupt.h中，重要标
志包括IRQF_DISABLED、IRQF_TIMER、IRQF_SHARED等。
第4个参数*devname：与中断相关的设备名，以ASCII表示，如键盘对应的“keyboard”等。
第5个参数*dev_id：主要用于共享中断线。
该函数的使用示例如下：
1　　 if (request_irq(irqn,my_interrupt,SA_SHIRQ,"my_device",dev))
2　　 {
3　　 　 printk(KERN_ERR"my_device: cannot register IRQ %d, \n", irqn);
4　　 　 return –EIO;
5　　 }
2．处理中断
在Linux系统中，典型的中断处理程序声明为：
　　static irqreturn_t intr_handler(int irq, void *dev_id, struct pt_regs *regs)
该函数的返回值为irqreturn_t型，实际上为int型。该函数可能返回两个特殊值。
 IRQ_NONE ：当中断处理程序检测到一个中断，但该中断对应的设备并不是在注册中
断处理程序期间指定的产生源时，返回该值。
 IRQ_HANDLED：当中断处理程序被正确调用且确实是它所对应的设备产生了中断
时，返回该值。
具体的中断处理程序编写一般包括3个部分：①检查设备是否产生了中断；②清除中断产生
标志；③执行相应的硬件操作。中断处理程序的特别之处在于，它是在中断处理时间内运行的，
因此它的行为受到了某些限制：不能使用可能引起阻塞的函数；不能使用可能引起调度的函数。
下面所示的共享中断处理程序（ short范例），使用中断来调用 do_gettimeofday （功能是取
得当前时间），并把当前时间打印到大小为一页的环形缓冲区，最后唤醒所有的读进程。
1　　 void short_sh_interrupt(int irq, void *dev_id, struct pt_regs *regs)
2　　 {
3　　        int value;
4　 　       struct timeval tv;
5　 　       /* 如果不是short，则立即返回 */
6　 　       value = inb(short_base);
7　  　      if (!(value & 0x80)) return;
8　  　      /* 清除中断位 */
9　   　     outb(value & 0x7F, short_base);
10　     　 do_gettimeofday(&tv);

--- Page 240 ---
219
第
7章 
输入/输出系统
11　     　 /* 写一个16B的记录;  假设PAGE_SIZE是16的倍数 */
12　     　 short_head += sprintf((char *)short_head,"%08u.%06u/n",
13　     　 (int)(tv.tv_sec % 100000000), (int)(tv.tv_usec));
14　    　  if (short_head == short_buffer + PAGE_SIZE)
15　     　 short_head = short_buffer; /* 绕回来 */
16　     　 wake_up_interruptible(&short_queue); /* 唤醒所有的读进程 */
17　　 }
用来读取在中断时间里填满的缓冲区的节点是/dev/shortint ，它内部的实现为中断的产生和
报告做了特别的处理。每向设备写入一个字节都会产生一个中断；而在读设备时则会给出每次
中断报告的时间。
3．注销中断
卸载驱动程序时，需要注销相应的中断处理程序，并释放中断请求线。可以调用函数free_irq
来释放中断请求线。
　　 void free_irq(unisigned int irq, void *dev_id)
如果指定的中断请求线不是共享的，那么该函数删除中断处理程序的同时，将会禁用该中
断请求线。如果中断请求线是共享的，则仅删除dev_id所对应的中断处理程序，而这条中断线本
身只有在删除了最后一个中断处理程序后才会被禁用。
请思考硬件中断和软件中断的区别与联系，并说明为什么 OS 是中断驱动的。
思考题
7.4　设备驱动程序
设备驱动程序通常又称为设备处理程序，它是I/O系统的上层与设备控制器之间的通信程
序，其主要任务是接收上层软件发来的抽象I/O要求，如read或 write命令，把它们转换为具体要
求后发送给设备控制器，进而使其启动设备去执行任务；反之，它也会将设备控制器发来的信
号传送给上层软件。由于设备驱动程序与硬件密切相关，故通常会为每类设备配置一种设备驱
动程序，例如，打印机和显示器需要不同的驱动程序。
7.4.1　设备驱动程序概述
1．设备驱动程序的功能
为了实现I/O系统的上层与设备控制器之间的通信，设备驱动程序应具有以下功能：①接收
由与设备无关的软件发来的命令和参数，并将命令中的抽象 I/O要求转换为与设备相关的低层操
作序列；②检查用户I/O请求的合法性，了解I/O设备的工作状态，传递与I/O设备操作有关的参
数，设置I/O设备的工作方式；③发出I/O命令，如果I/O设备空闲，则立即启动它，完成指定的I/O
操作；如果I/O设备忙碌，则将请求者的请求块挂在I/O设备队列上等待；④及时响应由设备控制
器发来的中断请求，并根据其中断类型，调用相应的中断处理程序进行处理。

--- Page 241 ---
220
计算机操作系统 （慕课版）
2．设备驱动程序的特点
设备驱动程序属于低级系统程序，它与一般的应用程序及系统程序之间有下述明显差
异：①设备驱动程序是实现在与设备无关的软件和设备控制器之间通信和转换的程序，具体
说，它将抽象的I/O请求转换成具体的I/O操作后传送给设备控制器，又把设备控制器中所记录
的设备状态和I/O操作的完成情况及时地反映给请求I/O的进程；②设备驱动程序与设备控制器
以及I/O设备的硬件特性紧密相关，对于不同类型的I/O设备，应配置不同的设备驱动程序，但
可以为相同的多个I/O 设备设置一个设备驱动程序；③设备驱动程序与I/O设备所采用的I/O 控
制方式紧密相关，常用的I/O控制方式是中断驱动I/O方式和DMA方式；④由于设备驱动程序
与硬件紧密相关，因而其中的一部分必须用汇编语言书写，目前有很多设备驱动程序的基本
部分都已固化在ROM中；⑤设备驱动程序应允许可重入，一个正在运行的设备驱动程序常会
在一次调用完成前被再次调用。
3．设备处理方式
在不同的OS中，所采用的设备处理方式并不完全相同。根据在设备处理时是否设置进程以
及设置什么样的进程，可将设备处理方式分成3 类。①为每类设备设置一个进程，专门用于执行
这类设备的I/O操作。例如，为所有的交互式终端设置一个交互式终端进程；再如，为同一类型
的打印机设置一个打印进程。这种方式比较适合于较大的系统。②在整个系统中设置一个 I/O进
程，专门用于执行系统中各类设备的 I/O操作；也可以设置一个输入进程和一个输出进程，分别
处理系统中的输入操作和输出操作。③不设置专门的设备处理进程，而只为各类设备设置相应
的设备驱动程序，供用户或系统进程调用。这种方式目前用得较多。
7.4.2　设备驱动程序的执行过程
设备驱动程序的主要任务是启动指定设备，完成上层软件指定的I/O工作。但在启动设备之
前，应先完成必要的准备工作，如检测设备状态是否为“忙”等。在完成所有的准备工作后，
才向设备控制器发送一条启动命令。以下是设备驱动程序的执行过程。
1．将抽象要求转换为具体要求
通常在每个设备控制器中都含有若干个寄存器，分别用于暂存命令、参数和数据等。由于
用户及上层软件对设备控制器的具体情况毫无了解，因而只能发出命令（抽象要求) ，这些命令
是无法传送给设备控制器的。因此，就需要将这些抽象要求转换为具体要求。例如，将抽象要
求中的盘块号转换为磁盘的盘面号、磁道号及扇区号。而这一转换工作只能由设备驱动程序来
完成，因为在OS中只有设备驱动程序是同时了解抽象要求和设备控制器中的寄存器情况的，也
只有它才知道命令、数据和参数应分别送往哪个寄存器。
2．校验服务请求
设备驱动程序在启动I/O设备之前，必须先检查该用户的I/O请求是不是该设备能够执行的。
一个非法请求的典型例子是，用户试图请求从一台打印机读入数据。如果设备驱动程序能检查
出这类错误，则认为此次I/O请求非法，它将向I/O 系统报告I/O请求出错。I/O系统可以根据具体
情况做出不同的决定，例如，可以停止请求进程的运行，或者仅通知请求进程它的I/O请求有
错，但仍然让它继续运行。此外，还有一些设备（如磁盘等）虽然都是既可读、又可写的，但
若在打开这些设备时规定的是只可读，则用户的写请求必然会被拒绝。

--- Page 242 ---
221
第
7章 
输入/输出系统
3．检查设备的状态
启动某个设备进行I/O操作，其前提条件应是该设备正处于就绪状态。为此，在每个设备控
制器中都配置有一个状态寄存器。设备驱动程序在启动设备之前，要先把状态寄存器中的内容
读入CPU的某个寄存器中，通过测试寄存器中的不同位来了解设备的状态，如图7-16所示。例
如，为了向某设备写入数据，此前应先检查状态寄存器中接收就绪的状态位，看它是否处于接
收就绪状态。仅当它处于接收就绪状态时，才能启动其设备控制器，否则只能等待。
D7
DSR
FE
OE
PE
Tx
EMP
Rx
RDY
Tx
RDY
SYN
DET
D6
D5
D4
D3
D2
D1
D0
发送就绪
接收就绪
发送器空
奇偶校验错
溢出错
组帧错
检出的SYNC特征
DSR引脚的状态
图 7-16　状态寄存器的格式
4．传送必要的参数
在确定设备处于接收（发送）就绪状态后，便可向设备控制器的相应寄存器传送数据以及
同控制本次数据传送有关的参数。例如，在某种设备控制器中配置了两个控制寄存器，其中一
个是命令寄存器，用于存放 CPU发来的各种控制命令，以决定本次 I/O操作是接收数据还是发送
数据等；另一个是方式寄存器，用于存放本次传送数据的速率、发送的字符长度等数据。如果
利用RS232接口进行异步通信，则在启动该接口之前，应先按通信规程设定波特率、奇偶校验方
式、停止位数目及数据字节长度等参数。对于较为复杂的块设备，除了必须向其设备控制器发
出启动命令外，还须传送更多的参数。
5．启动 I/O 设备
在完成上述各项准备工作后，驱动程序便可向设备控制器中的命令寄存器传送相应的控制
命令。对于字符设备，若发出的是写命令，则设备驱动程序会把一个字节（或字）传送给设备
控制器；若发出的是读命令，则设备驱动程序会等待接收数据，并通过读入设备控制器的状态
寄存器中状态字的方法来确定数据是否到达。
在多道程序系统中，设备驱动程序一旦发出I/O命令、启动一个I/O操作后，其便会把控制权
返回给I/O系统，把自己阻塞起来，直到中断到来时再被唤醒。具体的I/O操作是在设备控制器的
控制下进行的，因此，在设备忙于传送数据时， CPU可以去干其他的事情，实现了 CPU与I/O设
备的并行操作。
7.4.3　设备驱动程序的框架
1．设备驱动程序与外界的接口
计算机中有各种各样的设备，每种设备都有自己的设备驱动程序，因而设备驱动程序的代
码在内核中占比较大。另外，设备驱动程序可由设备生产厂家提供，也可由程序爱好者编制。
这样，就有必要对设备驱动程序与外界的接口进行严格的定义与管理。设备驱动程序与外界的

--- Page 243 ---
222
计算机操作系统 （慕课版）
接口可分为3部分：设备驱动程序与OS内核的接口、设备驱动程序与系统引导的接口、设备驱动
程序与设备的接口。
（1）设备驱动程序与OS内核的接口 。为了实现设备无关性，在UNIX和 Linux系统中，设
备被作为特别文件处理，用户的 I/O请求、对命令的合法性检查以及参数处理任务等，都在文件
系统中统一处理。只在需要各种设备执行具体操作时，系统才会通过相应的数据结构（如 UNIX
系统的块设备转接表、字符设备转接表等）转入不同的设备驱动程序。
（2）设备驱动程序与系统引导的接口。这一部分利用设备驱动程序对设备进行初始化，初
始化内容包括为管理设备而分配的数据结构、设备的请求队列等。
（3）设备驱动程序与设备的接口。这一部分与具体设备密切相关，描述了设备驱动程序如
何与设备交互作用。
2．设备驱动程序的组成
（1）设备驱动程序的注册与注销。设备驱动程序可在系统初启时初始化，也可在需要时动
态加载。初始化的一项重要工作就是设备登记（或注册），即把设备驱动程序的地址登记在设
备表的相应表项中。经登记后，只要知道设备的主设备号，就可以找到该类设备的各种驱动函
数。这样，在设备驱动程序上的其他内核模块中就可以“看见”这个模块了。当关闭设备时，
要从内核中注销设备驱动程序。
（2）设备的打开与释放。打开设备需要完成以下工作：增加设备的使用计数；检查设备的
状态，以及是否存在设备尚未准备好或者类似的硬件问题；若是首次打开，则初始化设备；识
别次设备号；根据需要更新相关的数据结构。释放设备又称关闭设备，是打开设备的逆过程。
释放设备主要需要完成以下工作：释放打开设备时所分配的内存；若是最后一个释放，则关闭
设备；减少设备的使用计数。
（3）设备的读/写操作 。一般来说，设备驱动程序接受来自上层与设备无关软件的抽象请
求，并使该请求得以执行。如果请求到来时设备驱动程序是空闲的，它就会立即执行该请求；
它若正忙于处理前面的请求，则把新请求放入未完成队列中，并尽快处理。设备驱动程序确定
发给设备控制器的命令后，会把它们写入设备控制器的设备寄存器中。
（4）设备的控制操作 。除了需要执行读/ 写操作外，有时还需要控制设备，该控制主要用
于对特殊文件的低层参数进行操作。如果对象是设备文件且有相应的 I/O控制函数，则转到该函
数，依据上层模块提供的I/O控制命令读取并设置有关的参数。
（5）设备的中断与轮询 。如果设备支持中断，则按照中断驱动I/O方式进行处理，即设备
驱动程序发出命令之后，可采取下述两种方式中的一种来处理。①在很多情况下，设备驱动程
序等待设备控制器完成某些工作时它会阻塞自己，直至出现中断对它解除阻塞。②在另一些情
况下，操作没有延迟就完成了，此时设备驱动程序不必阻塞。例如，在终端上的滚屏就是把一
些字节写入设备控制器的寄存器，速度很快，整个动作几微秒内就完成了。
上述操作完成后，必须检查是否有错。如果一切正常，设备驱动程序就会把数据结构传
到与设备无关的软件。最后，返回某些出错状态信息，向调用者报告。如果有排队请求，就
从中选出一个，启动它并执行。如果没有排队请求，则该设备驱动程序阻塞，等待后面请求
的到来。
对于不支持中断的设备，读/ 写时需要轮询设备状态，以决定是否继续进行数据传送。例
如，打印机驱动程序在默认情况下会轮询打印机的状态。

--- Page 244 ---
223
第
7章 
输入/输出系统
7.5　与设备无关的I/O软件
为了方便用户和提高OS 的可适应性和可扩展性，在现代OS 的I/O系统中，都无一例外地增
加了与设备无关的I/O软件，以实现设备独立性（device independence），也称为设备无关性。其
基本含义是：应用程序中所用的设备不局限于使用某个具体的物理设备。为每个设备所配置的
设备驱动程序，是与硬件紧密相关的软件。为了实现设备独立性，必须再在设备驱动程序之上
设置一层软件，称之为与设备无关的I/O软件，或设备独立性软件。
7.5.1　与设备无关软件的基本概念
1．通过物理设备名使用设备
在早期OS中，应用程序在使用I/O设备时，都使用设备的物理设备名，这
使应用程序与系统中的物理设备直接相关。当应用进程运行时，如果所请求的物理设备（独占设
备类型）已分配给其他进程，而此时尽管还有几台其他的相同设备空闲可用，但系统只能根据设
备的物理名来进行分配，因而无法将另外相同的设备（仅物理设备名不同）分配给它，致使该应
用进程请求I/O失败而被阻塞。特别是，当应用程序所需要的设备在系统中已经被更新后，该应用
程序就无法再在该系统上请求到所需要的设备而继续运行了。可见，应用程序直接与物理设备相
关是非常不灵活的，会给用户带来很大的不便，且对提高I/O设备的利用率也很不利。
2．引入逻辑设备名
为了实现与I/O设备的无关性，引入了逻辑设备名和物理设备名两个概念。逻辑设备名是抽
象的设备名，如/dev/printer，该设备名只是说明用户需要使用打印机来打印输出，但并没有指定
具体是哪一台打印机。这样，如果在应用程序中通过逻辑设备名请求使用某类设备，则系统在
对它进行设备分配时会先查找该类设备中的第一台，若其已被分配，则系统可立即去查找该类
设备中的第二台，若其也被分配，则接着去查找第三台，若其尚未被分配，则可将其分配给进
程。事实上，只要系统中有一台该类设备未被分配，进程就不会被阻塞。仅当所请求的此类设
备已全部分配完毕时，进程才会因请求失败而阻塞。因此，应用进程就不会由于某台指定设备
退役而无法在本系统中运行。
与设备无关的I/O软件还可实现I/O重定向。所谓I/O重定向，是指用于I/O操作的设备可以更
换（即重定向），而不必改变应用程序。例如，我们在调试一个应用程序时，可将程序的所有
输出送往屏幕显示。而在程序调试完后，若须正式将程序的运行结果打印出来，此时便须将 I/O
重定向的数据结构——逻辑设备表中的显示终端改为打印机，而不必修改应用程序。I/O重定向
功能具有很大的实用价值，现已被广泛地引入各类OS中。
3．实现从逻辑设备名到物理设备名的转换
在应用程序中，通过逻辑设备名使用设备虽然方便了用户，但系统只识别物理设备名，因
此在实际执行时还必须使用物理设备名。为此，系统必须具有将逻辑设备名转换为某物理设备名
的功能。关于逻辑设备名和物理设备名的概念，与存储器管理中所介绍的逻辑地址和物理地址的
概念非常类似，在应用程序中所使用的是逻辑地址，而系统在分配和使用内存时必须使用物理地
址。在程序执行时，必须先将逻辑地址转换为物理地址。类似地，为实现从逻辑设备名到物理设
备名的转换，在系统中需要配置一张逻辑设备表。转换的详细情况将在7.5.4小节进行介绍。
设备无关性


--- Page 245 ---
224
计算机操作系统 （慕课版）
7.5.2　与设备无关软件的共有操作
与设备无关软件是I/O系统的最高层软件，在它下面是设备驱动程序，它们的界限因OS和设
备的不同而有所差异。例如，对于一些本应由与设备无关软件实现的功能，却放在设备驱动程
序中实现。这样的差异，主要是出于对OS、设备独立性和设备驱动程序运行效率等多方面因素
的权衡和考虑。总体来说，在与设备无关软件中包含以下几项面向设备的共有操作。
1．提供设备驱动程序的统一接口
为了使所有的设备驱动程序有着统一的接口，一方面，要求每个设备驱动程序与OS 之间都
有相同的接口，或者相近的接口，这样会使添加一个新的设备驱动程序变得很容易，同时在很
大程度上方便了开发人员对设备驱动程序的编制；另一方面，要将抽象的设备名映射到适当的
设备驱动程序上，或者说将抽象的设备名转换为具体的物理设备名，并进一步找到相应物理设
备的设备驱动程序入口。此外，还应对设备进行保护，禁止用户直接访问设备，以防止无权访
问的用户使用设备。
2．缓冲管理
无论是字符设备还是块设备，它们的运行速度都远低于CPU的速度。为了缓和CPU与 I/O设
备之间的矛盾、提高CPU的利用率，在现代OS中都无一例外地分别为字符设备和块设备配置了
相应的缓冲区。缓冲区有多种形式，如单缓冲区、双缓冲区、环形缓冲区、缓冲池等，以满足
不同情况的需要。本书在7.7节中对这部分内容进行了详细介绍。
3．差错控制
由于设备中有着许多的机械和电气部件，它们比主机更容易出现故障，这就导致I/O操作中
的绝大多数错误都与设备有关。错误可分为以下两类。
（1）暂时性错误。暂时性错误是由暂时性事件引起的，如电源电压的波动。它可以通过重
试操作来纠正。例如，在网络传输中，由于传输路途较远、缓冲区数量暂时不足等因素，会经
常发生在网络中传送的数据包丢失或延误等暂时性错误。当网络传输软件检测到这种情况后，
可以通过重新传送来纠正错误。再如，当磁盘传送发生错误后，开始时设备驱动程序并不会立
即认为传送出错，而是会令磁盘重传，只有连续多次（如10次）均出错后，才认为磁盘出错，
并向上层报告。一般来说，设备出现故障后，主要由设备驱动程序对其进行处理。而与设备无
关的I/O软件只处理那些设备驱动程序无法处理的错误。
（2）持久性错误 。持久性错误是由持久性故障引起的，如电源断电、磁盘上有一条划痕
或者在计算中发生除以零的情况等。持久性错误容易发现，有些错误是只要重复执行相同的程
序就会再现的错误。要想排除持久性错误，通常需要查清发生错误的原因。但也有某些持久性
（硬件）错误可由OS进行有效处理，而不用涉及上层软件。如磁盘上的少数盘块遭到破坏而失
效，此时无须更换磁盘，而只须将它们作为坏盘块记录下来，并放入一张坏盘块表中，以后不
再使用它们即可。
4．独占设备的分配与回收
在系统中有着两类设备：独占设备和共享设备。对于独占设备，为了避免各进程对独占
设备的争夺，必须由系统来统一分配此类设备，而不允许进程自行使用。每当进程需要使用某
独占设备时，必须先提出申请。OS接到对设备的请求后，先对进程所请求的独占设备进行检

--- Page 246 ---
225
第
7章 
输入/输出系统
查，看该设备是否空闲。若空闲，则把该设备分配给请求进程。否则，进程将被阻塞，并放入
该设备的请求队列中等待。等到其他进程释放该设备后，如果该设备的请求队列中存在进程，
则将队列中的第一个进程唤醒，该进程得到设备后继续运行；否则，将该设备的状态置为“空
闲”，实现设备回收。
5．提供独立于设备的逻辑数据块
不同类型的设备的数据交换单位是不同的，读取和传输数
据的速率也各不相同，如字符设备以单个字节（字）为单位，
块设备以一个数据块为单位。即使同一类型的设备，它们的数
据交换单位的大小也是有差异的，如不同磁盘由于扇区大小的
不同，可能会造成数据块大小的不一致。与设备无关软件应能
隐藏这些差异而使用逻辑设备，并向上层软件提供大小统一的
逻辑数据块。与设备无关软件的功能层次如图7-17所示。
7.5.3　设备分配与回收
为实现对独占设备的分配，必须在系统中配置相应的数据结构。
1．设备分配中的数据结构
在用于设备分配的数据结构中，记录了对设备或设备控制器进行控制所需的信息。在进行
设备分配时需要用到以下数据结构。
（1）设备控制表。
系统为每个设备都配置了一张设备控制表（device control table， DCT），用于记录设备的
情况，如图7-18所示。
设备类型：type
设备标识符：deviceid
设备状态：忙/闲
控制器控制表指针
重复执行次数（或时间）
设备队列的队首指针
DCT
集合
DCT1
DCT2
DCTn
图 7-18　DCT
在DCT中，除了有用于指示设备类型的字段type和设备标识符deviceid外，还应有下列字
段：①设备队列的队首指针，凡因请求本设备而未得到满足的进程，应将其PCB按照一定的
策略排成一个设备请求队列，其队首指针指向队首PCB ；②设备状态，用于表示当前设备的
状态（忙/ 闲）；③与设备连接的控制器控制表指针，该指针指向该设备所连接的控制器的控
制表；④重复执行次数（或时间），由于外部设备在传送数据时较易发生数据传送错误，因
而在许多系统中规定了设备在工作中发生错误时应重复执行的次数，在重复执行时，若能恢
复正常传送，则仍认为传送成功，仅当重复执行次数达到规定值而仍不成功时，才认为传送  
失败。
需要说明的是，当某进程释放某设备，且无其他进程请 求该设备时，系统将该设备DCT中
的设备状态改为空闲，即可实现“设备回收”。
设备驱动程序的统一接口
缓冲
错误报告
分配与释放专用设备
提供与设备无关的块大小
图 7-17　与设备无关软件的功能层次

--- Page 247 ---
226
计算机操作系统 （慕课版）
（2）控制器控制表、通道控制表和系统设备表。
① 控制器控制表（controller control table ，COCT）：系统为每个控制器都设置了用于记录
控制器情况的控制器控制表，如图7-19 （a）所示。
② 通道控制表（channel control table ，CHCT）：每个通道都有一张通道控制表，如图7-19 
（b）所示。
③ 系统设备表（system device table， SDT）：系统范围的数据结构，记录了系统中全部设
备的情况，每个设备占一个表目，其中包含设备类型、设备标识符、DCT及设备驱动程序入口
等项，如图7-19 （c）所示。
控制器标识符：controllerid
控制器状态：忙/闲
与控制器连接的通道控制表指针
控制器队列的队首指针
控制器队列的队尾指针
通道标识符：channelid
通道状态：忙/闲
与通道连接的控制器控制表指针
通道队列的队首指针
通道队列的队尾指针
表目1
……
表目i
设备类型
设备标识符
DCT
设备驱动程序入口
（a）控制器控制表 （b）通道控制表 （c）系统设备表
图 7-19　控制器控制表、 通道控制表和系统设备表
2．设备分配时应考虑的因素
系统在分配设备时，应考虑如下几个因素。
（1）设备的固有属性。
设备的固有属性可分成3种，对具有不同固有属性的设备应采取不同的分配策略：①独占设
备的分配策略，将一个设备分配给某进程后，便由该进程独占该设备，直至该进程完成或释放
该设备；②共享设备的分配策略，对于共享设备，可将其同时分配给多个进程使用，此时须注
意对这些进程访问该设备的先后次序进行合理调度；③虚拟设备的分配策略，虚拟设备属于可
共享设备，可以将它同时分配给多个进程使用。
（2）设备分配算法。
针对设备分配，通常只采用以下两种分配算法：①FCFS算法，该算法根据各进程对某设备
提出请求的先后次序，将这些进程排成一个设备请求队列，设备分配程序总会把设备首先分配
给队首进程；②最高优先级优先算法，在利用该算法形成设备队列时，优先级高的进程会排在
设备队列前面，而对于优先级相同的I/O请求，则按FCFS原则排队。
（3）设备分配中的安全性。
根据进程运行的安全性，设备分配有以下两种方式。
① 安全分配方式 。每当进程发出I/O请求后，便进入阻塞状态，直到其I/O操作完成时才被
唤醒。在采用该策略时，进程一旦获得某种设备后便会阻塞，不能再请求任何资源，而在它阻
塞时又不保持任何资源。因此，这种分配方式摒弃了造成死锁的四个必要条件之一的“请求和
保持”条件，故设备分配是安全的。其缺点是CPU与I/O设备是顺序工作的。
② 不安全分配方式。在这种分配方式中，进程在发出I/O请求后仍继续运行，需要时又会发
出第二个I/O请求、第三个I/O请求等。仅当进程所请求的设备已被另一进程占用时，才进入阻塞
状态。该策略的优点是，一个进程可同时操作多个设备，这使进程能够迅速推进。其缺点是分
配不安全，因为这种分配方式可能具备“请求和保持”条件，从而可能造成死锁。因此，在设

--- Page 248 ---
227
第
7章 
输入/输出系统
备分配程序中，应对本次的设备分配是否会发生死锁进行安全性计算，仅当计算结果表明分配
安全时，才进行设备分配。
3．独占设备的分配程序
（1）基本的设备分配程序。
这里通过一个例子来介绍设备分配过程。当某进程提出I/O请求后，系统的设备分配程序可
按下述步骤进行设备分配。
① 分配设备。首先根据I/O请求中的物理设备名，查找SDT，从中找出该设备的DCT，再根
据DCT中的设备状态字段获知该设备是否正忙。若忙，则将请求 I/O的进程的PCB挂在设备队列
上。否则，按照一定的算法计算本次设备分配的安全性。如果不会导致系统进入不安全状态，
则将设备分配给请求进程。否则，仍将其PCB插入设备等待队列。
② 分配控制器。在系统把设备分配给请求I/O的进程后，再到其DCT中找出与该设备连接的
控制器的COCT，从COCT的状态字段中可知该控制器是否正忙。若忙，则将请求I/O进程的PCB
挂在该控制器的等待队列上。否则，将该控制器分配给进程。
③ 分配通道。在该COCT中又可找到与该控制器连接的通道的CHCT。根据CHCT内的状态
信息可知该通道是否正忙。若忙，则将请求I/O的进程挂在该通道的等待队列上；否则，将该通
道分配给进程。只有在设备、控制器和通道三者都分配成功时，这次的设备分配才算成功。然
后，便可启动该I/O设备进行数据传送。
（2）设备分配程序的改进。
在上面的例子中，进程是以物理设备名提出I/O请求的。如果所指定的设备已分配给其他进
程，则分配失败；或者说上面的设备分配程序不具有与设备无关性。为获得设备的独立性，进
程应使用逻辑设备名请求 I/O。这样，系统首先会从SDT 中找出第一个该类设备的DCT 。若该设
备忙，则查找第二个该类设备的DCT，仅当所有该类设备都忙时，才把进程挂在该类设备的等
待队列上。而只要有一个该类设备可用，系统便会进一步计算分配该设备的安全性。若安全，
则把设备分配给进程。
7.5.4　逻辑设备名映射到物理设备名
为了实现与设备的无关性，当应用程序请求使用I/O设备时，应当使用逻辑设备名。但系统只
识别物理设备名，因此在系统中需要配置一张逻辑设备表，用于将逻辑设备名映射为物理设备名。
1．逻辑设备表
在逻辑设备表的每个表目中包含3项内容：逻辑设备名、物理设备名和设备驱动程序的入口
地址，如图7-20 （a）所示。当进程用逻辑设备名请求分配 I/O设备时，系统会根据当时的具体
情况为它分配一台相应的物理设备。与此同时，在逻辑设备表上会建立一个表目，填上应用程
序中使用的逻辑设备名和系统分配的物理设备名，以及该设备驱动程序的入口地址。当以后进
程再利用该逻辑设备名请求 I/O操作时，系统通过查找逻辑设备表便可找到该逻辑设备所对应的
物理设备及其设备驱动程序。
2．逻辑设备表的设置
在系统中，可采取两种方式设置逻辑设备表。

--- Page 249 ---
228
计算机操作系统 （慕课版）
逻辑设备名
/dev/tty
/dev/printer
…
/dev/tty
/dev/printer
…
3
5
…
3
5
…
1024
2046
…
物理设备名
逻辑设备名
系统设备表指针
设备驱动程序的
入口地址
                                                    （a）格式一　　　　　　　　                                   　　 （b）格式二
图 7-20　逻辑设备表
第一种方式，是在整个系统中只设置一张逻辑设备表。由于系统中所有进程的设备分配情
况都记录在同一张逻辑设备表中，因而不允许在逻辑设备表中存在相同的逻辑设备名，这就要
求所有用户都不能使用相同的逻辑设备名。在多用户系统中这通常是难以做到的，因而这种方
式主要用于单用户系统。
第二种方式，是为每个用户设置一张逻辑设备表。每当用户登录系统时，系统便会为该用
户建立一个进程，同时也会为之建立一张逻辑设备表，并将该表放入进程的PCB中。由于通常
在多用户系统中都配置了系统设备表，故此时的逻辑设备表可以采用图7-20 （b）所示的格式。
7.5.5　I/O 调度
调度一组I/O请求意味着，按照确定好的顺序来执行它们。应用程序执行系统调用的顺序
很少是最佳的。I/O调度可以改善系统整体性能，可以在进程间公平共享设备访问，可以减少
完成I/O调度所需的平均等待时间。这里通过一个简单的例子加以说明。假设磁臂位于磁盘开
头，3个应用程序对这个磁盘执行阻塞读调用。应用程序1 请求磁盘结束附近的块，应用程序2
请求磁盘开始附件的块，而应用程序3 则请求磁盘中间部分的块。OS按照2 、3、1的顺序来处
理应用程序，可以减少磁臂移动的距离。按这种方式重新排列服务顺序就是I/O调度的核心。
OS开发人员通过为每个设备维护一个请求等待队列来实现其调度。当应用程序发出阻塞I/O
的系统调用时，该请求会被添加到相应设备的队列中。I/O调度程序重新安排队列顺序，以便
提高系统的总体效率和应用程序的平均响应时间。如此一来，没有应用程序会得到特别差的访
问；或者对那些延迟敏感的请求，可以给予比较优先的服务。例如，虚拟存储器子系统的请求
可能优先于应用程序的请求。本书7.8节将详细讨论磁盘I/O的多个调度算法。
调度I/O操作是I/O系统提高计算机效率的一种方法，另外也可以通过缓冲、缓存、假脱机或
者使用内存或磁盘的存储空间来实现计算机效率的提高。
7.6　用户层的I/O软件
一般而言，大部分的I/O软件都放在OS内部，但仍有一小部分放在用户层，其中包括与用户
程序链接在一起的库函数，以及完全运行于内核之外的假脱机系统等。
7.6.1　系统调用与库函数
1．系统调用
一方面，为使各进程能有条不紊地使用I/O设备，且能保护设备的安全性，不允许运行在用
户态的应用进程直接调用运行在内核态的OS过程。另一方面，应用进程在运行时，又必须取得
OS所提供的服务，否则，应用程序几乎无法运行。为了解决此矛盾，OS在用户层中引入了一个

--- Page 250 ---
229
第
7章 
输入/输出系统
中介过程——系统调用。应用程序可以通过它间接地调用OS中的I/O过程，对I/O设备进行操作。
系统中会有许多系统调用，它们的实现方法基本相同。下面简单说明系统调用的执行过
程。当应用程序需要执行某种I/O操作时，在应用程序中必须使用相应的系统调用。当OS捕获到
应用程序中的该系统调用后，便会将CPU的状态从用户态
转换到内核态，然后转向OS中的相应过程，由该过程执行
所需的I/O操作。执行完成后，系统又将CPU状态从内核态
转换到用户态，返回应用程序继续执行。图7-21所示为系
统调用的执行过程。
事实上，由OS向用户提供的所有功能，用户进程都必
须通过系统调用来获取，或者说，系统调用是应用程序取
得OS所有服务的唯一途经。在早期的OS中，系统调用是以
汇编语言形式提供的，因此只有在用汇编语言书写的程序
中才能直接使用系统调用，这对用户是非常不方便的；后
来在C语言中，首先提供了与系统调用相对应的库函数。
2．库函数
在C语言以及UNIX系统中，系统调用（如read）与各系统调用所使用的库函数（如read）之
间，几乎是一一对应的。而微软公司定义了一组接口，称为Win32 API，程序员可以利用该接口
取得OS服务。该接口与实际的系统调用并不一一对应。用户程序通过调用对应的库函数使用系
统调用，这些库函数与调用程序连接在一起，并被嵌入在运行时装入内存的二进制程序中。
在C语言中提供了多种类型的库函数，在I/O方面，主要提供的是对文件和设备进行读/写操作
的库函数，以及控制/检查设备状态的库函数。显然这些库函数的集合也应是I/O系统的组成部分。
而且可以这样来看待内核和库函数之间的关系：内核提供了OS的基本功能，而库函数扩展了OS内
核，使用户能方便地取得OS的服务。在许多现代OS中，系统调用本身已经采用C语言编写，并以
函数形式提供，因此在使用C语言编写的用户程序中可以直接使用这些系统调用。
另外，OS在用户层中还提供了一些非常有用的程序，如7.6.2小节将要介绍的的假脱机系统，
以及在网络传输文件时经常使用的守护进程等，它们是运行在内核外的程序，但仍属于I/O系统。
7.6.2　假脱机系统
如果说，通过多道程序技术可将一台物理CPU虚拟为多台逻辑CPU，从而允许多个用户共
享一台主机，那么通过假脱机技术就可以将一台物理I/O设备虚拟为多台逻辑I/O设备，这样就可
以允许多个用户共享一台物理I/O设备。
1．假脱机技术
在20世纪50年代，为了缓和CPU的高速性与I/O设备的低速性之间的矛盾，引入了脱机输入/脱
机输出技术。该技术是利用专门的外围控制机先将低速 I/O设备上的数据传送到高速磁盘上，或
者相反。这样，当CPU需要输入数据时，便可以直接从磁盘中读取数据，极大地提高了输入速
度。反之，在CPU需要输出数据时，也能以很快的速度把数据先输出到磁盘上，然后CPU便可
去做自己的事情了。
事实上，当系统中引入多道程序技术后，系统便完全可以利用其中的一道程序来模拟脱机
输入时的外围控制机功能，进而把低速I/O设备上的数据传送到高速磁盘上；再用另一道程序
用户态
用户程序
系统调用系统调用
命令 调用
返回
内核态
图 7-21　系统调用的执行过程

--- Page 251 ---
230
计算机操作系统 （慕课版）
模拟脱机输出时外围控制机的功能，把数据从磁盘传送到低速输出设备上。这样，便可在主机
的直接控制下实现以前的脱机输入/ 脱机输出功能。此时的外围操作与CPU对数据的处理同时进
行，我们把这种在联机情况下实现的同时外围操作技术，称为SPOOLing（全称：simultaneaus 
periphernal operating online）技术，或称为假脱机技术。
2．假脱机系统的组成
如前所述，假脱机技术是对脱机输入/脱机输出系统的模拟，相应地，如图7-22（a）所示，
假脱机系统建立在通道技术和多道程序技术的基础上，以高速随机外存（通常为磁盘）为后援
存储器，其主要由4部分组成。图7-22（b）所示为假脱机系统的工作原理。
输入设备1
输入设备n
…
…
输入进程
输入进程
输入设备
作业1输入
作业1输出
作业n输入
作业n输出
…
…输出设备
假脱机
文件队列
打印缓冲区
内存
空盘块队列
满盘块队列
硬盘
假脱机
打印进程
假脱机
管理进程
共享
打印机
输出进程
输入缓冲区1
输入缓冲区2
输出缓冲区2
井管理
程序
运行的作业
输出缓冲区1
内存 内存
输入
井
输出
井
输出进程
输出设备1输入井
输出井
主机
输出设备n
通
道
通
道
通道
（a）假脱机系统的组成
（b）假脱机系统的工作原理
（c）假脱机打印机系统的组成
图 7-22　假脱机系统

--- Page 252 ---
231
第
7章 
输入/输出系统
（1）输入井和输出井。这是在磁盘上开辟出来的两个存储区域。输入井模拟脱机输入时的
磁盘，用于收容I/O设备输入的数据。输出井模拟脱机输出时的磁盘，用于收容用户程序的输出
数据。输入井/输出井中的数据一般以文件的形式组织管理，我们把这些文件称为井文件。一个
文件仅存放某一个进程的输入（或输出）数据，所有进程的数据输入（或输出）文件可链接成
为一个输入（或输出）队列。
（2）输入缓冲区和输出缓冲区。这是在内存中开辟的两个缓冲区，用于缓和CPU和磁盘之
间速度不匹配的矛盾。输入缓冲区用于暂存由输入设备传送来的数据，之后再将其传送到输入
井。输出缓冲区用于暂存从输出井传送来的数据，之后再将其传送到输出设备。
（3）输入进程和输出进程。输入进程，也称为预输入进程，用于模拟脱机输入时的外围控
制机，将用户要求的数据从输入设备传送到输入缓冲区，再存放到输入井。当CPU须输入数据
时，直接从输入井读入内存。输出进程，也称为缓输出进程，用于模拟脱机输出时的外围控制
机，把用户要求输入的数据从内存传送（并存放）到输出井，待输出设备空闲时，再将输出井
中的数据经输出缓冲区输出至输出设备。
（4）井管理程序。用于控制作业与磁盘井之间信息的交换。当作业执行过程中向某台设备
发出启动输入或输出操作请求时，由OS调用井管理程序，由该程序控制从输入井读取信息或将
信息输出至输出井。
3．假脱机系统的特点
（1）提高了I/O速度。这里对数据所执行的I/O操作，已从对低速I/O设备执行的I/O操作演
变为对磁盘缓冲区中的数据进行的存取操作，如同脱机输入/脱机输出一样，提高了I/O速度，缓
和了CPU与低速I/O设备之间速度不匹配的矛盾。
（2）将独占设备改造为共享设备。在假脱机打印机系统中，实际上并没有为任何进程分配
设备，而只是在磁盘缓冲区中为进程分配了一个空闲盘块和建立了一张 I/O请求表。这样，便把
独占设备改造成了共享设备。
（3）实现了虚拟设备功能。宏观上，虽然多个进程在同时使用一台独占设备，但对于每个
进程而言，它们都会认为自己独占了一个设备。当然，该设备只是逻辑上的设备。假脱机打印
机系统实现了将独占设备变换为若干台对应的逻辑设备的功能。
4．假脱机打印机系统
打印机是经常会被用到的输出设备，属于独占设备。利用假脱机技术可将它改造为一台可
供多个用户共享的打印设备，从而提高了设备的利用率，也方便了用户使用。共享打印机技术
已被广泛应用于多用户系统和局域网中。
假脱机打印机系统主要包含以下3部分。①磁盘缓冲区，是在磁盘上开辟的一个存储空间，
用于暂存用户程序的输出数据，在该缓冲区中可以设置几个盘块队列，如空盘块队列、满盘块
队列等。②打印缓冲区，用于缓和CPU和磁盘之间速度不匹配的矛盾，设置在内存中，用于暂
存从磁盘缓冲区发送来的数据，以后会再传送给打印设备进行打印。 ③假脱机管理进程和假脱
机打印进程。由假脱机管理进程为每个要求打印的用户数据建立一个假脱机文件，并把它放入
假脱机文件队列中，由假脱机打印进程依次对队列中的文件进行打印。图7-22 （c）所示为假脱
机打印机系统的组成。
每当用户进程发出打印输出请求时，假脱机打印机系统并不会立即把打印机分配给该用户
进程，而是会由假脱机管理进程完成两项工作：①在磁盘缓冲区中为之申请一个空闲盘块，并

--- Page 253 ---
232
计算机操作系统 （慕课版）
将要打印的数据送入其中暂存；②为用户进程申请一张空白的用户请求打印表，并将用户的打印
要求填入其中，再将该表挂到假脱机文件队列上。在这两项工作完成后，虽然还没有进行任何实
际的打印输出，但对于用户进程而言，其打印请求已经得到了满足，打印输出任务已经完成。
真正的打印输出是假脱机打印进程负责的，当打印机空闲时，该进程首先从假脱机文件队
列的队首摘取一张请求打印表，然后根据表中的要求将要打印的数据由磁盘缓冲区传送到内存
缓冲区，再交付打印机进行打印。一个打印任务完成后，假脱机打印进程将会再次查看假脱机
文件队列，若队列非空，则重复上述工作，直至队列为空。此后，假脱机打印进程会将自己阻
塞起来，仅当再次有打印请求时，其才会被重新唤醒运行。
由此可见，利用假脱机系统向用户提供共享打印机的概念是：对每个用户而言，系统并非
即时执行其程序输出数据的真实打印操作，而只是即时将数据输出到缓冲区，这时的数据并未
真正被打印，只是让用户感觉系统已为他打印；真正的打印操作，是在打印机空闲且该打印任
务在等待队列中已排到队首时进行的；而且，打印操作本身也是利用CPU的一个时间片，没有
使用专门的外围机。以上过程是对用户屏蔽的，即用户是不可见的。
5．守护进程
上一部分内容具体介绍了利用假脱机系统来实现打印机共享的一种方案，人们对该方案
进行了某些修改，如取消该方案中的假脱机管理进程，为打印机建立一个守护进程，由它实
现一部分原来由假脱机管理进程实现的功能，如为用户在磁盘缓冲区中申请一个空闲盘块，
并将要打印的数据送入其中，将该盘块的起始地址返回给请求进程。另一部分功能由请求进
程自己实现，每个要求打印的进程，首先生成一份要求打印的文件，其中包含对打印的要求
和指向装有打印输出数据盘块的指针等信息，然后将用户请求打印文件放入假脱机文件队列
（目录）中。
守护进程是允许使用打印机的唯一进程。所有需要使用打印机进行打印的进程，都需要将
一份要求打印的文件放在假脱机文件队列（目录）中。如果守护进程正在睡眠，则将它唤醒，
由它按照目录中第一个文件中的说明进行打印，打印完成后，再按照目录中第二个文件中的说
明进行打印，如此逐份文件地进行打印，直到目录中的全部文件打印完毕为止，此时守护进程
无事可做，便又去睡眠，同时等待用户进程再次发来打印请求。
除了打印机守护进程之外，还可能有许多其他的守护进程，如服务器守护进程和网络守护
进程等。事实上，凡在需要将独占设备改造为可供多个进程共享的设备时，都要为该设备配置
一个守护进程和一个假脱机文件队列（目录）。同样，守护进程是允许使用该独占设备的唯一
进程，所有其他进程都不能直接使用该设备，而只能将对该设备的使用要求写入一份文件中，
并将该文件放在假脱机目录中。由守护进程按照目录中的文件，依次来完成各进程对该设备的
请求。这样就把一台独占设备改造成了可为多个进程共享的设备。
7.7　缓冲区管理
在现代OS中，几乎所有的I/O设备在与CPU交换数据时，都使用了缓冲
区。缓冲区是一个存储区域，它可以由专门的硬件寄存器组成，但由于硬件的
成本较高，故容量较小，一般仅用于对速度要求非常高的场合，如存储器管理
中所用的联想存储器、设备控制器中用的数据缓冲区等。在一般情况下，更多
的是将内存作为缓冲区。本节所要介绍的也正是由内存组成的缓冲区。缓冲区
缓冲与假脱机
技术


--- Page 254 ---
233
第
7章 
输入/输出系统
管理的主要功能是组织好这些缓冲区，并提供获得和释放缓冲区的手段。
7.7.1　缓冲的引入
引入缓冲区的原因可能有很多，它们可归结为以下几点。
1．缓和 CPU 与 I/O 设备间速度不匹配的矛盾
事实上，凡在数据的到达速率与离去速率不同的地方，都可设置缓冲区，以缓和它们之间
速率不匹配的矛盾。众所周知， CPU的运算速率远高于 I/O设备的传输速率，如果没有缓冲区，
则在输出数据时，必然会由于打印机的速度跟不上而使CPU停下来等待；然而在计算阶段，打
印机又空闲无事。如果在打印机或控制器中设置一缓冲区，用于快速暂存程序的输出数据，以
后由打印机“慢慢地”从中取出数据打印，则可提高CPU的工作效率。类似地，在输入设备与
CPU之间设置缓冲区，也可使CPU的工作效率得以提高。
2．减少对 CPU 中断的频率，放宽对 CPU 中断响应时间的限制
在远程通信系统中，如果从远程终端发来的数据仅用一位缓冲来接收，如图7-23 （a）所
示，则必须在每收到一位数据时便中断一次CPU，这样，对于速率为9.6kbit/s的数据通信来说，
就意味着其中断CPU的频率为9.6kHz，即约每100 μs就要中断CPU一次，而且CPU必须在100 μs
内予以响应，否则缓冲区内的数据将被冲掉。倘若设置一个8 位缓冲寄存器，如图7-23 （b）所
示，则可使CPU被中断的频率降低为原来的1/8；若再设置一个8 位缓冲寄存器，如图7-23 （c）
所示，则可以把CPU对中断的响应时间从100 μs放宽到800 μs。类似地，在磁盘控制器和磁带控
制器中，都需要配置缓冲寄存器，以减少对CPU的中断频率，放宽对CPU中断响应时间的限
制。随着数据传输速率的提高，需要配置位数更多的寄存器进行缓冲。
9.6kbit/s 1位缓冲
送内存
8位缓冲寄存器
8位缓冲寄存器
送内存
9.6kbit/s
9.6kbit/s
（a）1位缓冲
（b）8位缓冲寄存器
（c）两个8位缓冲寄存器
图 7-23　利用缓冲寄存器实现缓冲
3．解决数据粒度不匹配的问题
缓冲区可用于解决在生产者和消费者之间交换的数据粒度（数据单元大小）不匹配的问
题。例如，当生产者所生产的数据粒度比消费者消费的数据粒度小时，生产者进程可以一连生
产好几个数据单元的数据，当其总和已达到消费者进程所要求的数据单元大小时，消费者便可
从缓冲区中取出数据进行消费。当生产者所生产的数据粒度比消费者消费的数据粒度大时，生
产者每次生产的数据，消费者可以分几次从缓冲区中取出消费。

--- Page 255 ---
234
计算机操作系统 （慕课版）
4．提高 CPU 和 I/O 设备之间的并行性
缓冲区的引入可显著提高CPU和 I/O设备间的并行操作程度，提高系统的吞吐量和设备的利
用率。例如，在CPU（生产者）和打印机（消费者）之间设置了缓冲区后，生产者在生产了一
批数据并将其放入缓冲区后，便可立即去进行下一次的生产。与此同时，消费者可以从缓冲区
中取出数据进行消费，这样便可使CPU与打印机处于并行工作状态。
7.7.2　单缓冲区和双缓冲区
如果在生产者与消费者之间未设置任何缓冲区，则生产者与消费者之间在时间上会相互限
制。例如，生产者已经完成了数据的生产，但消费者尚未准备好接收，生产者就无法把所生产
的数据交付给消费者，此时生产者必须暂停并等待，直到消费者就绪。如果在生产者与消费者
之间设置了一个缓冲区，那么生产者无须等待消费者就绪便可把数据输出到缓冲区。
1．单缓冲区
在单缓冲区（single buffer）情况下，每当用户进程发出一个I/O请求时，OS便会在内存中
为之分配一缓冲区，如图7-24（a）所示。在块设备输入时，假定从I/O设备把一块数据输入缓冲
区的时间为T，OS将该缓冲区中的数据传送到工作区的时间为M，而CPU对这一块数据进行处理
（计算）的时间为C。由于T和C是可以并行的（见图7-24（b）），当T＞C时，系统对每块数据的
处理时间为M+T；反之则为M+C。因此可把系统对每块数据的处理时间表示为Max (C, T )+M。
（a）分配缓冲区
用户进程
处理（C） 传送（M） 输入（T）
工作区
T1
M1
C1 C2 C3
t
M2 M3
T2 T3 T4
缓冲区
I/O设备
（b）操作并行示意
图 7-24　单缓冲区工作示意
在字符设备输入数据时，缓冲区用于暂存用户输入的一行数据，在输入期间，用户进程被
挂起以等待数据输入完毕；在输出时，用户进程将一行数据输入缓冲区后，继续进行处理。当
用户进程已有第二行数据输出时，如果第一行数据尚未被提取完毕，则此时用户进程应阻塞。
2．双缓冲区
由于缓冲区是共享资源，生产者与消费者在使用缓冲区时必须互斥。如果消费者尚未取走
缓冲区中的数据，则即使生产者又生产出新的数据，也无法将它送入缓冲区，此时生产者需要
等待。如果为生产者与消费者设置了两个缓冲区，便能解决这一问题。
为了加快输入和输出速度，提高设备利用率，人们又引入了双缓冲区（double buffer）
机制，也称为缓冲对换（buffer swapping）。在设备输入数据时，先将数据送入第一缓冲
区，装满后便转向第二缓冲区。此时OS可以从第一缓冲区中移出数据，并送入用户进程
（见图7-25（ a）），接着由CPU对数据进行计算。在双缓冲区情况下，系统处理一块数据

--- Page 256 ---
235
第
7章 
输入/输出系统
的时间可以认为是Max ( C+M, T )，如果 C+M＜T，则可使块设备连续输入；如果 C+M＞T，
则可使CPU不必等待设备输入。对于字符设备，在行输入方式下，若采用双缓冲区，则通常
能消除用户的等待时间，即用户在输入完第一行数据后，在CPU执行第一行中的命令时，用
户可以继续向第二缓冲区输入下一行数据。
（a）引入双缓冲区
用户进程
缓冲1 缓冲1缓冲2 缓冲2
工作区
T1
M1
C1 C2 C3 C4
t
M2 M3 M4
T2 T3 T4
缓冲区1
缓冲区2
I/O设备
（b）操作并行示意
图 7-25　双缓冲区工作示意
如果在实现两台机器之间的通信时仅为它们设置了单缓冲区，如图7-26（a）所示，那么它们
之间在任一时刻都只能实现单方向的数据传输。例如，只允许把数据从A机传送到B机，或者从B
机传送到A机，而绝不允许双方同时向对方发送数据。为了实现双向数据传输，必须在两台机器
中都设置两个缓冲区，一个用作发送缓冲区，另一个用作接收缓冲区，如图7-26（b）所示。
A机
（a）单缓冲区 （b）双缓冲区
缓冲区 缓冲区
发送
缓冲区
发送
缓冲区
接收
缓冲区
接收
缓冲区
B机 A机 B机
图 7-26　双机通信时缓冲区的设置
7.7.3　环形缓冲区
当输入与输出的速度基本匹配时，采用双缓冲区能获得较好的效果，可使生产者和消费者
基本上实现并行操作。但若两者的速度相差甚远，则双缓冲区的效果不会太理想，不过可以随
着缓冲区数量的增加而使情况有所改善。因此，又引入了多缓冲区机制，可将多个缓冲区组成
环形缓冲区的形式。
1．环形缓冲区的组成
（1）多个缓冲区。在环形缓冲区中包含多个缓冲区，各缓冲区的大小相同。作为输入的多
缓冲区可分为 3种类型：用于装输入数据的空缓冲区 R、已装满数据的缓冲区G 、计算进程正在
使用的现行工作缓冲区C，如图7-27所示。
（2）多个指针 。作为输入的缓冲区可设置3 个指针：用于指示计算进程下次可用缓冲区G
的指针Nextg，用于指示输入进程下次可用空缓冲区R 的指针Nexti，以及用于指示计算进程正在

--- Page 257 ---
236
计算机操作系统 （慕课版）
使用的缓冲区C的指针Current。
R
G
1
2
3
4
5
6
Nextg
Current
Nextg
Nexti
Nexti
G
G
G
R
R
G
1
2
3
4
5
6
G
C
G
R
图 7-27　环形缓冲区
2．环形缓冲区的使用
计算进程和输入进程可利用下述两个过程来使用形环缓冲区。
（1）Getbuf过程。当计算进程要使用缓冲区中的数据时，可调用Getbuf过程。该过程将由
指针Nextg所指示的缓冲区提供给进程使用，相应地，须把它改为现行工作缓冲区，并令Current
指针指向该缓冲区的第一个单元，同时将Nextg移向下一个可用缓冲区G 。类似地，每当输入进
程要使用空缓冲区来装入数据时，也调用Getbuf过程，由该过程将指针Nexti所指示的缓冲区提
供给输入进程使用，同时将Nexti指针移向下一个空缓冲区R。
（2）Releasebuf过程 。当计算进程把C 缓冲区中的数据提取完毕时，便调用Releasebuf过
程，将缓冲区C 释放。此时，把该缓冲区由当前（现行）工作缓冲区C 改为空缓冲区R 。类似
地，当输入进程把缓冲区装满时，也应调用Releasebuf过程，将该缓冲区释放，并将其改为可用
缓冲区G。
3．进程间的同步问题
使用输入循环缓冲，可使输入进程和计算进程并行执行。相应地，指针Nexti和指针Nextg将
不断地沿着顺时针方向移动，这样就可能出现下述两种情况。
（1）Nexti指针追赶上Nextg指针。这意味着输入进程输入数据的速度大于计算进程处理数
据的速度，已把全部可用的空缓冲区装满，再无缓冲区可用。此时，输入进程应阻塞，直到计
算进程把某个缓冲区中的数据全部提取完，使之成为空缓冲区R ，并调用Releasebuf过程将它释
放后，才可将输入进程唤醒。这种情况被称为“系统受计算限制”。
（2）Nextg指针追赶上Nexti指针 。这意味着输入数据的速度小于计算进程处理数据的速
度，使装有输入数据的缓冲区都被抽空，再无装有数据的缓冲区供计算进程提取数据。这时，
计算进程只能阻塞，直至输入进程又装满某个缓冲区，并调用Releasebuf过程将它释放后，才可
将计算进程唤醒。这种情况被称为“系统受I/O限制”。
7.7.4　缓冲池
前述缓冲区是专门为特定的生产者与消费者设置的，它们属于专用缓冲。当系统较大时，
应该有许多循环缓冲，这不仅要消耗大量的内存空间，而且缓冲区利用率不高。为了提高缓冲
区的利用率，引入并广泛应用既可用于输入、又可用于输出的（公用）缓冲池（buffer pool），
该池中设置了多个可供若干进程共享的缓冲区。缓冲池与缓冲区的区别在于：缓冲区仅是一

--- Page 258 ---
237
第
7章 
输入/输出系统
组内存块的链表，而缓冲池则是包含了一个用于管理自身的数据结构和一组操作函数的管理机
制，用于管理多个缓冲区。
1．缓冲池的组成
缓冲池管理着多个缓冲区，每个缓冲区由用于标志和管理的缓冲首部以及用于存放数据的
缓冲体两部分组成。缓冲首部一般包括缓冲区号、设备号、设备上的数据块号、同步信号量以
及队列链接指针等。为了管理上的方便，一般将缓冲池中具有相同类型的缓冲区链接成一个队
列，于是可形成3 个队列。 ①空白缓冲队列emq ：这是由空缓冲区所链成的队列，其队首指针
F(emq)和队尾指针L(emq)分别指向该队列的首缓冲区和尾缓冲区。 ②输入队列inq：这是由装满
输入数据的缓冲区所链成的队列，其队首指针F(inq)和队尾指针L(inq)分别指向输入队列的队首
缓冲区和队尾缓冲区。 ③输出队列outq：这是由装满输出数据的缓冲区所链成的队列，其队首
指针F(outq)和队尾指针L(outq)分别指向该队列的队首缓冲区和队尾缓冲区。
除了上述3个队列外，还应具有4种工作缓冲区：用于收容输入数据的工作缓冲区、用于提取
输入数据的工作缓冲区、用于收容输出数据的工作缓冲区以及用于提取输出数据的工作缓冲区。
2．Getbuf 过程和 Putbuf 过程
在数据结构课程中，曾介绍过队列和对队列进行操作的两个过程，第一个是Addbuf(type，
number)过程，该过程用于将由参数number所指示的缓冲区B 挂在type队列上；第二个是
Takebuf(type)过程，该过程用于从type所指示的队列的队首摘下一缓冲区。这两个过程能否用于
对缓冲池中的队列进行操作呢？答案是否定的。因为缓冲池中的队列本身是临界资源，多个进
程在访问一个队列时，既应互斥，又应同步。为此，需要对这两个过程加以改造，以形成可用
于对缓冲池中的队列进行操作的Getbuf过程和Putbuf过程。
为使各进程能互斥地访问缓冲池队列，可为每一队列设置一个互斥信号量MS(type)。此
外，为了保证各进程同步地使用缓冲区，可为每个缓冲队列设置一个资源信号量RS(type)。既可
实现互斥又可保证同步的Getbuf过程和Putbuf过程描述如下。
1　　void Getbuf(unsigned type){
2　　　  Wait(RS(type))；
3　　　  Wait(MS(type))；
4　　　  B(number) =Takebuf(type)；
5　　　  Signal(MS(type))；
6　　}
7　　void Putbuf(type，number){
8　　　  Wait(MS(type))；
9　　　  Addbuf(type，number)；
10　　　  Signal(MS(type))；
11　　　  Signal(RS(type))；
12           }
3．缓冲池的工作方式
缓冲池可以工作在如下4种工作方式下，如图7-28所示。
（1）收容输入。输入进程可调用Getbuf (emq)过程，从空缓冲区队列emq的队首摘下一空缓
冲区，并把它作为收容输入工作缓冲区hin。然后，把数据输入其中，装满后再调用Putbuf(inq，

--- Page 259 ---
238
计算机操作系统 （慕课版）
hin)过程，将它挂在输入队列inq上。
缓冲池
hin
sout
sin
hout
收容输入
提取输出
提取输入
收容输出
用户程序
图 7-28　缓冲池的 4 种工作方式
（2）提取输入。计算进程可调用Getbuf (inq)过程，从输入队列inq的队首取得一缓冲区，
并将它作为提取输入工作缓冲区sin，计算进程从中提取数据。计算进程用完该数据后，再调用
Putbuf(emq，sin)过程，将它挂到空缓冲区队列emq上。
（3）收容输出 。计算进程可调用Getbuf (emq)过程，从空缓冲区队列emq的队首取得一空
缓冲区，并将它作为收容输出工作缓冲区 hout。当其中装满输出数据后，再调用 Putbuf (outq ，
hout)过程，将它挂在输出队列outq末尾。
（4）提取输出。输出进程可调用Getbuf (outq)过程，从输出队列的队首取得一装满输出数
据的缓冲区，并将它作为提取输出工作缓冲区sout 。在数据提取完后，再调用Putbuf(emq， sout)
过程，将它挂在空缓冲区队列emq末尾。
7.7.5　缓存
缓存（cache）是保存数据副本的高速内存区域。现代计算机系统中有多种类型的缓存，如
CPU缓存、磁盘缓存、光驱缓存等。访问缓存副本比访问其原版更加有效。例如，正在运行进程
的指令保存在磁盘上，缓存在物理内存上，并被再次复制到了CPU的二级缓存和一级缓存中。
CPU缓存先于内存同CPU交换数据，速率很快，故也称为高速缓存。它主要是为了缓和CPU运行
速率与内存读/写速率不匹配的矛盾。其工作原理是：当CPU要读取一个数据时，首先从CPU缓存
中进行查找，找到就立即读取并将其送给CPU处理；若没有找到，则从速率相对较慢的内存中读
取并将其送给CPU处理，同时把这个数据所在的数据块调入缓存中，这可以使得以后对整块数据
的读取都从缓存中进行，而不必再调用内存。正是这样的读取机制使CPU读取缓存的命中率变得
非常高（大多数CPU可达90%左右），这大大节省了CPU直接读取内存的时间，也使CPU读取数据
时基本无须等待。
缓存和缓冲的区别：缓冲可以保存数据项的唯一的现有版本；而根据定义，缓存只提供一
个位于其他地方的数据项的更快存储副本。
缓存和缓冲的功能不同，但是有时一个内存区域可以用于两个目的。例如，为了保留复制
语义和有效调度磁盘I/O，OS会采用内存中的缓冲区来保存磁盘数据。这些缓冲区也用作缓存，
以便提高文件的I/O效率；这些文件可被多个程序共享，或者快速地写入和重读。当内核收到文
件I/O请求时，内核首先会访问缓冲区缓存，以便查看文件区域是否已经在内存中可用。如果
是，则可以避免或延迟物理磁盘 I/O。此外，磁盘写入在数秒内会累积到缓冲区缓存中，以汇集
大量传输，进而实现允许高效写入调度。
7.8　磁盘性能概述和磁盘调度
磁盘存储器是计算机系统中最重要的存储设备，其中存放了大量的文件。对文件的读/ 写操

--- Page 260 ---
239
第
7章 
输入/输出系统
作都将涉及对磁盘的访问。磁盘 I/O速度的高低和磁盘系统的可靠性将直接影响系统的性能。可
以通过多种途经来改善磁盘系统的性能：第一可以选择好的磁盘调度算法，以减少磁盘的寻道
时间；第二可以提高磁盘I/O速度，以提高对文件的访问速度；第三可以采取冗余技术，以提高
磁盘系统的可靠性，建立高度可靠的文件系统。第二点和第三点将在第9 章“磁盘存储器管理”
中进行具体介绍。
7.8.1　磁盘性能概述
磁盘是一种相当复杂的机电设备，在此仅对其某些性能（如数据的组织与格式、磁盘的类
型、磁盘的访问时间等）做扼要阐述。
1．数据的组织与格式
磁盘可包括一个或多个物理盘片，每个盘片有一个或两个盘面（surface ），如图7-29（a）
所示，每个盘面上有若干条磁道（track），磁道之间留有必要的间隙。为使处理简单起见，
在每条磁道上可存储相同数目的二进制位。这样，针对磁盘密度，即每英寸中所存储的位
数，显然是内层磁道的密度较外层磁道的密度高。每条磁道又从逻辑上被划分成若干个扇区
（sectors），软盘大约为8至32个扇区，硬盘则可多达数百个扇区，图7-29（b）显示了一个磁道
被分成8个扇区。一个扇区称为一个盘块（或数据块）。各扇区之间保留一定的间隙。
盘面9
盘面8
盘面7
盘面6
盘面5
盘面4
盘面3
盘面2
盘面1
盘面0
主杆
读/写磁头
轴心
   
扇区
磁道
磁道间隔
扇区间隔
                           （a）磁盘的结构                                                                                （b）磁盘的布局
图 7-29　磁盘的结构和布局
一个物理记录存储在一个扇区上，磁盘上能存储的物理记录数目是由扇区数、磁道数以及
磁盘面数所决定的。例如，一个10GB容量的磁盘，有 8个双面可存储盘片，共 16个存储面（盘
面），每面有16 383个磁道（也称柱面），每个磁道含63个扇区。
为了提高磁盘的存储容量，充分利用磁盘外面磁道的存储能力，现代磁盘不再把内外磁
道划分为相同数目的扇区，而是利用外层磁道容量较内层磁道大的特点，将盘面划分成若干
条环带，同一环带内的所有磁道具有相同的扇区数，显然外层环带的磁道拥有较内层环带的

--- Page 261 ---
240
计算机操作系统 （慕课版）
磁道更多的扇区。为了减少这种磁道和扇区在盘面分布的几何形式的变化对驱动程序的影
响，大多数现代磁盘都隐藏了这些细节，仅向OS提供虚拟几何的磁盘规格，而不是实际的物
理几何的磁盘规格。
为了在磁盘上存储数据，必须先将磁盘低级格式化。图7-30所示为一种温盘（温切斯特）
中一条磁道格式化的情况。其中每条磁道含有30个固定大小的扇区，每个扇区容量为600B，其
中512B存放数据，其余字节用于存放控制信息。每个扇区包括两个字段：①标识符字段，其中
一个字节的Synch具有特定的位图像，其作为该字段的定界符，可利用磁道号、磁头号及扇区号
三者来标志一个扇区，CRC字段用于段校验；②数据字段，存放512B的数据。
Byte
Sector
Byte
17
7
41
515
20
17
7
40
515
20
17
7
41
600Byte/Sector
515
20
Physical Sector 0
Gap
1
Synch
Byte
Synch
Byte
Track
#
Head
#
Sector
#
CRC
CRC
Data
Gap
1
Gap
1
Gap
2
Gap
2
Gap
2
Gap
3
Gap
3
Gap
3
ID
Field
0
ID
Field
29
Data
Field
29
Data
Field
29
ID
Field
29
Data
Field
0
Physical Sector 1
Physical Sector 29
1
1
1
3
1
512
2
2
图 7-30　磁盘的格式化
在磁盘格式化完成后，一般要对磁盘进行分区。在逻辑上，每个分区就是一个独立的逻辑
磁盘。每个分区的起始扇区和大小都记录在磁盘0 扇区的主引导记录所包含的分区表中。在这个
分区表中必须有一个分区被标记成是活动的（即引导块），以保证能够从硬盘引导系统。
但是，在真正可以使用磁盘前，还需要对磁盘进行一次高级格式化，即设置一个引导块、
空闲存储管理、根目录和一个空文件系统，同时在分区表中标记该分区所使用的文件系统。
2．磁盘的类型
可以从不同的角度对磁盘进行分类，最常见的有将磁盘分成硬盘和软盘、单片盘和多片
盘、固定头磁盘和移动头磁盘等。下面仅介绍固定头磁盘和移动头磁盘。
（1）固定头磁盘 。这种磁盘在每条磁道上都有一个读/ 写磁头，所有的磁头都被装在一刚
性磁臂中。通过这些磁头可访问所有磁道，并进行并行读/写，以有效地提高磁盘的I/O速度。这
种结构主要用于大容量磁盘。
（2）移动头磁盘。每个盘面仅配有一个磁头，其也被装入磁臂中。为能访问该盘面上的所
有磁道，该磁头必须能移动以进行寻道。可见，移动磁头仅能以串行方式读/ 写，这致使其I/O速
度较慢；但由于其结构简单，故其结构仍被广泛应用于中、小型磁盘。在微机上配置的温盘和
软盘都采用了移动磁头结构，因此本节主要介绍采用此类结构的磁盘的I/O。
3．磁盘的访问时间
磁盘设备在工作时，以恒定转速旋转。为了读/ 写，磁头必须能移动到所指定的磁道上，并
等待所指定的扇区的开始位置旋转到磁头下，然后再开始读/ 写数据。因此，可把对磁盘的访问
时间分成以下3部分。
（1）寻道时间Ts。这是指把磁臂（磁头）移动到指定磁道上所经历的时间，该时间是启动
磁臂的时间k与磁头移动n条磁道所花费的时间之和，即：

--- Page 262 ---
241
第
7章 
输入/输出系统
Ts = m × n + k，
其中，m是一个常数，其与磁盘驱动器的速度有关，对于一般的磁盘， m=0.2；对于高速磁盘，
m≤0.1；磁臂的启动时间约为2ms。这样，对于一般的温盘，其寻道时间将随寻道距离的增大而
增加，为5ms～30ms。
（2）平均旋转延迟时间 Tτ。这是指某扇区移动到磁头下面所经历的时间，在不同类型的磁
盘中，旋转速度至少相差一个数量级，如软盘为300r/min，硬盘一般为7 200r/min到 15 000r/min
甚至更高。对于磁盘的 Tτ而言，如果是硬盘，则旋转速度为15 000r/min，每转耗时4ms， Tτ为
2ms；而如果是软盘，则旋转速度为300r/min或 600r/min，这样，Tτ为50ms～100ms。Tτ的具体表
达如下：
，
其中，r为磁盘每秒的转数。
（3）传输时间Tt。这是指从磁盘读出数据或向磁盘写入数据所经历的时间。 Tt的大小与每
次所读/写的字节数b和旋转速度有关，关系如下：
Tt=
 ，
其中，N为一条磁道上的字节数，当一次读/写的字节数相当于半条磁道上的字节数时， Tt与Tτ相
同，因此，可将访问时间Ta表示为：
Ta=Ts+
 +
 。
由上式可以看出，在访问时间中，寻道时间和平均旋转延迟时间基本上都与所读 /写数据
的多少无关，而且它们通常占据了访问时间中的大头。例如，假定寻道时间和平均旋转延迟
时间为20ms，而磁盘的传输速率为10MB/s，如果要传输10KB数据，则此时总的访问时间为
21ms，可见传输时间所占比例是非常小的。当传输 100KB 数据时，其访问时间也只是 30ms，
即当传输的数据量增大10倍时，访问时间只增加约50%。目前磁盘的传输速率已达80MB/s以
上，数据传输时间所占的比例更低。可见，适当地集中数据（不要太零散）进行传输有利于
提高传输效率。
7.8.2　早期的磁盘调度算法
为了减少对文件的访问时间，应采用一种最佳的磁盘调度算法，以使各
进程对磁盘的平均访问时间最小。由于访问磁盘的时间中大部分是寻道时间，
因此，磁盘调度的目标是使磁盘的平均寻道时间最短。目前常用的磁盘调度算
法有：FCFS调度算法、最短寻道时间优先（shortest seek time ﬁrst， SSTF）调
度算法等。下面逐一进行介绍。
1．FCFS 调度算法
FCFS调度算法是最简单的磁盘调度算法。它根据进程请求访问磁盘的先后次序进行调度。
此算法的优点是公平、简单，且每个进程的请求都能依次得到处理，不会出现某一进程的请求
长期得不到满足的情况。但此算法由于未对寻道进行优化，平均寻道时间可能较长。图7-31所
示为有9 个进程先后提出磁盘I/O请求时，按FCFS调度算法进行调度的情况。这里，将进程号
（请求者）按它们发出请求的先后次序排队。这样，平均寻道距离为55.3条磁道，与后面即将讲
到的SSTF调度算法相比，其平均寻道距离较大。因此FCFS调度算法仅适用于请求磁盘I/O的进
程数目较少的场合。
磁盘调度


--- Page 263 ---
242
计算机操作系统 （慕课版）
平均寻道长度：55.3
（从100号磁道开始）
被访问的
下一个磁道号
55
58
39
18
90
160
150
38
184
45
3
19
21
72
70
10
112
146
移动距离
（磁道数）
      
图 7-31　按 FCFS 调度算法进行调度                       
2．SSTF 调度算法
SSTF调度算法会选择这样的进程，其要求访问的磁道与当前磁头所在的磁道距离最
近，以使每次的寻道时间最短，但这种算法不能保证平均寻道时间最短。图 7-32 所示为按
SSTF调度算法进行调度时，各进程被调度的次序、每次磁头移动的距离以及9 次磁头平均移
动的距离。通过比较图7-31和图7-32发现，SSTF调度算法对应的磁头平均移动距离明显低于
FCFS 调度算法，即SSTF 调度算法较FCFS调度算法有更好的寻道性能，故其过去曾一度被广
泛采用。
（从100号磁道开始）
被访问的
下一个磁道号
90
58
55
39
38
18
150
160
184
10
32
3
16
1
20
132
10
24
移动距离
（磁道数）
平均寻道长度：27.6
图 7-32　按 SSTF 调度算法进行调度
7.8.3　基于扫描的磁盘调度算法
1．SCAN 调度算法
SSTF调度算法的实质是基于优先级进行调度，因此可能导致优先级低的进程出现“饥饿”
现象。因为只要不断有新进程的请求到达，且其所要访问的磁道距离磁头当前所在的磁道较

--- Page 264 ---
243
第
7章 
输入/输出系统
近，这种新进程的I/O请求就必然会被优先满足。在对SSTF调度算法略加修改后，即可防止低优
先级进程出现“饥饿”现象。
SCAN调度算法不仅会考虑欲访问的磁道与当前磁道间的距离，还会优先考虑磁头当前的移
动方向。例如，当磁头正在自里向外移动时，SCAN调度算法所考虑的下一个访问对象，应是其
欲访问的、既在当前磁道之外、又是距离最近的磁道。这样自里向外访问，直至再无更外的磁
道需要访问时，才将磁臂换向为自外向里移动。此时，同样也是每次选择这样的进程来调度，
即要访问的磁道为当前位置距离最近者，这样，磁头又会逐步地自外向里移动，直至再无更里
面的磁道要访问，从而避免出现“饥饿”现象。由于在这种调度算法中磁头移动的规律颇似电
梯的运行规律，因而其又常被称为电梯调度算法。图7-33 所示为按SCAN调度算法对9 个进程进
行调度的情况。
（从100号磁道开始，向磁道号
增加方向访问）
被访问的
下一个磁道号
移动距离
（磁道数）
150
160
184
90
58
55
39
38
18
50
10
24
94
32
3
16
1
20
平均寻道长度：27.8
图 7-33　按 SCAN 调度算法进行调度
2．CSCAN 调度算法
SCAN调度算法既能获得较好的寻道性能，又能防止出现“饥饿”现象，故被广泛应用于
大、中、小型计算机和网络中的磁盘调度中，但也存在这样的问题：当磁头刚自里向外移动而
越过某一磁道后，恰好又有一进程请求访问此磁道，这时，该进程必须等待，待磁头继续自里
向外、然后再自外向里扫描完处于外面的所有要访问的磁道后，才处理该进程的请求，这致使
该进程的请求被大大地推迟。为了减少这种影响，人们提出了CSCAN调度算法。CSCAN调度
算法规定磁头单向移动，如只是自里向外移动，当磁头移到最外的磁道并完成访问后，磁头立
即返回到最里的欲访问磁道，亦即将最小磁道号紧接最大磁道号以构成循环，进而实现循环扫
描。采用循环扫描方式后，上述请求进程的请求时延将从原来的2 T减为T+S
max，其中T为自里向
外或自外向里单向扫描完要访问的磁道所需的寻道时间，而 Smax是将磁头从最外面被访问的磁道
直接移到最里面欲访问的磁道（或相反）所需的寻道时间。图7-34所示为按CSCAN调度算法对9
个进程调度的次序及每次磁头移动的距离。
3．NStepSCAN 调度算法和 FSCAN 调度算法
（1）NStepSCAN调度算法 。采用SSTF、 SCAN及 CSCAN这几种调度算法，都可能出现
磁臂停留在某处不动的情况，例如，有一个或几个进程对某一磁道有较高的访问频率，即这
个（些）进程反复请求对某一磁道进行I/O操作，从而垄断了整个磁盘设备。我们把这一现象

--- Page 265 ---
244
计算机操作系统 （慕课版）
称为“磁臂粘着”（armstickiness），在高密度磁盘上容易出现此现象。 N步SCAN调度算
法（NStep SCAN调度算法）是将磁盘请求队列分成若干个长度为 N的子队列，磁盘调度将按
FCFS调度算法依次处理这些子队列。而每处理一个子队列时又采用SCAN调度算法，处理完一
个子队列后，再处理其他子队列。当正在处理某个子队列时，如果又出现新的磁盘I/O请求，
则将新请求进程放入其他子队列，这样就可避免出现磁臂粘着现象。当 N值取得很大时，会使
NStepSCAN调度 算法的性能接近于SCAN调度算法的性能；当N =1时，NStepSCAN 调度算法便
蜕化成了FCFS调度算法。
（从100号磁道开始，向磁道号
增加方向访问）
被访问的
下一个磁道号
移动距离
（磁道数）
150
160
184
18
38
39
55
58
90
50
10
24
166
20
1
16
3
32
平均寻道长度：35.8
图 7-34　按 CSCAN 调度算法进行调度
（2）FSCAN调度算法。FSCAN调度算法实质上是NStepSCAN调度算法的简化，即FSCAN
调度算法只将磁盘请求队列分成两个子队列。一个是由当前所有请求磁盘 I/O的进程所形成的队
列，由磁盘调度按SCAN调度算法进行处理。在扫描期间，将新出现的所有请求磁盘I/O的进程
放入另一个等待处理的请求队列。这样，所有的新请求都将被推迟到下一次扫描时进行处理。
如何根据计算机对磁盘进行 I/O 请求的方式和次数选择磁盘调度算法？
思考题
7.9　本章小结
各种I/O设备是整个计算机系统的重要组成部分。由于I/O设备种类繁多，因此设备管理很复
杂。任何OS都有很大一部分代码与I/O有关。
本章首先介绍了I/O系统的功能、模型和接口。I/O系统的功能是：管理和控制I/O操作和I/O
设备。其次，描述了I/O设备、设备控制器、中断机构等I/O硬件。再次，详细讨论了I/O软件，
包括中断处理程序、设备驱动程序、与设备无关的I/O软件和用户层I/O软件等。设备驱动程序负
责处理设备工作中的所有细节，并面向OS的其他部分提供统一接口，在该部分介绍了控制I/O的
方式，最主要的是程序轮询I/O方式、中断驱动I/O方式、DMA方式和I/O通道方式。与设备无关
的I/O软件负责完成如提供接口、缓冲管理、差错控制、独立设备的分配与回收等工作。用户层
I/O软件中的假脱机系统是个典型的虚拟设备系统，能够把独占设备模拟成共享设备。最后，详
细介绍了缓冲、缓存和磁盘调度等知识点。在缓冲区管理中，介绍了引入缓冲的原因和缓冲区

--- Page 266 ---
245
第
7章 
输入/输出系统
的各种组成方式。在磁盘调度中，首先概述了磁盘的性能，并在此基础上详细介绍了磁盘的各
种调度算法，包括FCFS调度算法、SSTF调度算法、SCAN调度算法和CSCAN调度算法等。
习题7（含考研真题）
一、简答题
1．试说明I/O系统的基本功能。
2．I/O软件一般分为用户层软件、设备独立性软件、设备驱动程序和中断处理程序这4 个层
次，它们的基本功能分别是什么？请说明下列工作分别是在哪一层完成的?
（1）向设备寄存器写命令。
（2）检查用户是否有权使用设备。
（3）将二进制整数转换成ASCII的格式打印。
（4）缓冲管理。
3．设备控制器由哪几部分组成？为了实现CPU与设备控制器之间的通信，设备控制器应具
备哪些功能？
4．（考研真题）什么是通道？通道经常采用图7-35所示的交叉连接方式，为什么？
存储器
设备控制器1
设备控制器2
I/O设备
I/O设备
I/O设备
通道1
通道2
I/O设备
图 7-35　通道交叉连接图
5．设备中断处理程序通常须完成哪些工作？它对中断进行处理的过程包含哪些步骤？
6．（考研真题）为什么要有设备驱动程序？用户进程是如何通过设备驱动程序来控制设备
工作的？
7．推动I/O控制方式发展的主要因素是什么?
8．请说明中断驱动I/O方式和DMA方式有什么不同。
9．设备无关性的基本含义是什么？为什么要设置设备无关性软件？
10．设备分配过程中可能会出现死锁吗？为什么？
11．假脱机系统由哪几部分组成？以打印机为例说明如何利用假脱机技术实现多个进程对
打印机的共享？
12． （考研真题 ）在单缓冲区情况下，为什么系统对一块数据的处理时间为max( C, 
T )+M？
二、计算题
13．（考研真题）设系统缓冲区和用户工作区均采用单缓冲区，从外设读入1个数据块到系
统缓冲区的时间为100，从系统缓冲区读入1 个数据块到用户工作区的时间为5，对用户工作区中

--- Page 267 ---
246
计算机操作系统 （慕课版）
的1个数据块进行分析的时间为90（见图7-36）。进程从外设读入并分析2 个数据块的最短时间
是多少？
用户工作区
系统缓冲区
外设
90
5
100
图 7-36　单缓冲区处理数据过程图
14．假定把磁盘上一个数据块中的信息输入一单缓冲区的时间 T为100μs，将缓冲区中的数
据传送到用户区的时间 M为50μs，CPU对这一块数据进行计算的时间 C为50μs。请问，系统对
一块数据的处理时间为多少？如果将单缓冲区改为双缓冲区，则系统对一块数据的处理时间为  
多少？
15． （考研真题 ）某磁盘的转速为10 000r/min，平均寻道时间为6ms，磁盘传输速率为
20MB/s，磁盘控制器时延为0.2ms，读取一个4KB的扇区所需的平均时间约为多少？
16．某磁盘有40个柱面，查找每个柱面需要5ms，若文件信息块凌乱存放，则相邻逻辑块
平均间隔9个柱面。文件信息块经优化分布后，相邻逻辑块平均间隔2 个柱面。假设磁盘时延为
100ms，传输速率为20ms/块。请问在信息块非优化存放和优化存放两种情况下，传输100块文件
信息各需多长时间？
17． （考研真题 ）假设有11 个进程先后提出磁盘I/O请求，当前磁头正在110 号磁道处，
并预向磁道序号增加的方向移动。请求队列的顺序为30、 145、120、78、82、140、20、42、
165、65，分别用FCFS调度算法和SCAN调度算法完成上述请求，写出磁道访问顺序和每次磁头
移动的距离，并计算平均移动磁道数。
18．（考研真题）磁盘请求服务队列中要访问的磁道分别为38、 6、37、100、14、124、
65、67，磁头上次访问了20号磁道，当前处于30号磁道上，试采用FCFS、 SSTF和SCAN调度算
法，分别计算磁头移动的磁道数。
三、综合应用题
19．（考研真题）目前，个人计算机上使用的外部存储设备的速度都相当快，例如，刻录
一张DVD（单面单层DVD的容量通常大约为4.7GB）需要几分钟到十几分钟时间。与DVD相
比，硬盘的速度更快。请问：这样的高速设备使用的大概是什么样的I/O控制方式?请说出你的推
断理由。
20．除了FCFS算法外，所有磁盘调度算法都不公平，例如会造成有些请求“饥饿”，试
分析：
（1）为什么不公平？
（2）如何构建一种公平性调度算法？
（3）为什么公平性在分时系统中是一个很重要的指标？
21．假设有4 个记录（A、B、C、D）被存放在磁盘的某个磁道上，该磁道被划分成4 块，
每块存放1个记录，其布局如表7-1所示。

--- Page 268 ---
247
第
7章 
输入/输出系统
表7 -1　记录存放布局情况
块号 记录号
1 A
2 B
3 C
4 D
现在要顺序处理这些记录。假定磁盘转速为20ms/r，处理程序每次从磁盘读出一个记录后
要花5ms对其进行处理，若磁头现在处于首个逻辑记录的始点位置，则请问：
（1）处理程序处理完这4个记录所花费的时间是多少?
（2）按最优化分布重新安排这4个逻辑记录，写出记录的安排，并计算处理所需要的时间。
22．假定磁盘的磁臂现在处于6 号柱面上，有表7-2所示的6个请求进程等待访问磁盘，试列
出最省时间的响应次序。
表7 -2　请求进程等待访问磁盘位置
请求进程序号 柱面号 磁头号 块号
1 7 6 2
2 5 5 6
3 15 20 6
4 7 4 4
5 20 9 5
6 5 15 2

--- Page 269 ---
由于计算机中的内存是易失性设备，断电后其所存储的信息即会丢失，容量又十分有限，
因此在现代计算机系统中，都必须配置外存，目的是将系统和用户需要用到的大量程序和数
据，以“文件”的形式存放在其中，待需要的时候再随时将它们调入内存，或将它们打印出
来。如果由用户来直接管理存放在外存上的文件，则不仅要求用户熟悉外存的特性，了解各种
文件的属性，以及它们在外存上的位置，而且在多用户环境下，还必须保持数据的安全性和一
致性。显然，这是用户所不能胜任的。于是在OS中又增加了文件管理功能，专门负责管理外
存中的文件，并把对文件的存取、共享和保护等手段提供给用户。这不仅方便了用户，保证了
文件的安全性，还可有效提高系统资源的利用率。本章知识导图如图8-1所示。
文件管理
文件和文件系统
文件的逻辑结构
文件目录
文件的共享与保护
文件
文件系统
文件操作
无结构文件
有结构文件
利用有向无环图
保护域
访问矩阵
文件共享
文件保护
单级文件目录
两级文件目录
树形目录
无环图目录
文件控制块
和索引节点
顺序文件
索引文件
索引顺序文件
直接文件
哈希文件
利用符号链接
图8-1　第8章知识导图
文件管理

第8章
第8 章导读


--- Page 270 ---
249
第
8章 
文件管理
8.1　文件和文件系统
文件系统是OS的一部分，它提供了一种管理机制，以便OS对自身及所有
用户的数据与程序进行在线存储和访问。文件系统由两部分组成：文件集合和
目录。文件系统的管理功能是通过将其管理的程序和数据组织成一系列文件的
方式实现的，而文件则是指具有文件名的若干相关元素的集合。元素通常是
记录，而记录又是一组有意义的数据项的集合。由此可见，基于文件系统的概
念，可以把数据的组成分为文件、记录和数据项三级。
8.1.1　文件、记录和数据项
1．数据项
在文件系统中，数据项是最低级的数据组织形式，它可被分成两种类型。①基本数据项，
是用于描述一个对象的某种属性的字符集，是数据组织中可以命名的最小逻辑数据单位，又称
为字段。例如，用于描述一个学生的基本数据项有学号、姓名、年龄、班级等。②组合数据
项，是由若干个基本数据项所组成的，简称组项。例如，工资是个组项，它可由基本工资、工
龄工资和奖励工资等基本数据项组成。
基本数据项除了数据名外，还应有数据类型，因为基本数据项用于描述某个对象的属性，
根据属性的不同，需要用不同的数据类型来实现其描述。例如，在描述学生的学号时，应使用
整数；描述学生的姓名时，应使用字符串（含汉字）；描述学生的性别时，可用逻辑变量或汉
字。可见，基本数据项的名字和数据类型这两者共同定义了一个基本数据项的“型”，而表征
一个实体在基本数据项上的数据则称为“值”，如学号/30211、姓名/王某某、性别/男等。
2．记录
记录是一组相关数据项的集合，用于描述一个对象在某方面的属性。一个记录应包含哪些
数据项取决于需要描述对象的哪个方面。由于对象所处的环境不同，可将对象作为不同的存在。
例如，一个少年，当把他作为班上的一名学生时，对他的描述应使用学号、姓名、年龄及所在班
级，也可能还包括他所学过的课程的名称、成绩等数据项；但若把学生作为一个医疗对象，对他
的描述则应使用诸如病历号、姓名、性别、出生年月、身高、体重、血压及病史等数据项。
在诸多记录中，为了能唯一地标志一个记录，必须在其各个数据项中确定出一个或几个数
据项，并把它们的集合称为关键字（key）。换言之，关键字是唯一能标志一个记录的数据项。
通常，只须将一个数据项作为关键字。例如，前面例子中提及的学号或病历号，便可用来从诸
多记录中标志出唯一的一个记录。然而有时找不到这样的数据项，这时就只好把几个数据项定
为能在诸多记录中唯一地标志某个记录的关键字。
3．文件
文件是指由创建者所定义的、具有文件名的一组相关元素的集合，可分为有结构文件和无
结构文件两类。在有结构文件中，文件由若干个相关记录组成，而无结构文件则被看成一个字
节流。文件在文件系统中是一个最大的数据单位，它描述了一个对象集。例如，可将一个班的
学生的记录作为一个文件。
文件的主要属性有4个。①文件类型。可以从不同的角度来规定文件的类型，如源文件、目
文件和文件系统


--- Page 271 ---
250
计算机操作系统 （慕课版）
标文件及可执行文件等。 ②文件长度，指文件的当前长度，长度的单位可以是字节、字或块，
也可以是允许的最大长度。 ③文件的物理位置，通常用于指示文件所在的设备及文件在该设备
中地址的指针。④文件的建立时间，亦指文件最后一次的修改时间。图 8-2所示为文件、记录和
数据项之间的层次关系。
文件
数据项1
记录1
数据项n
数据项2
记录n
记录2
…
…
图 8-2　文件、 记录和数据项之间的层次关系
8.1.2　文件名和文件类型
1．文件名和扩展名
（1）文件名。不同的系统对文件名的规定是不同的，在一些早期的OS中，文件名的长度
受到了系统限制。例如，MS -DOS系统最多支持8 个字符，老版的UNIX 系统支持14个字符。另
外，一些特殊字符（如空格）因常被用作分隔命令、参数和其他数据项的分隔符，故被规定不
能用于文件名。近年推出的不少OS已放宽了这种限制，如Windows NT及以后的Windows 2000/
XP/Vista/7/8/10等所采用的新技术文件系统（new technology file system， NTFS），便可以很好
地支持长文件名，即支持255个字符。另外，在早期的OS（如MS-DOS和Windows 95等系统）中
是不区分大小写字母的，如MYFILE、 MYf ile和myf ile都是指同一个文件。但在UNIX和Linux系
统中是区分大小写的，因此，上面的3个文件名会被用于标志不同的文件。
（2）扩展名。扩展名是添加在文件名后面的若干个附加字符，又称为后缀名，用于指示文
件的类型，它可以方便系统和用户了解文件的类型，是文件名中的重要组成部分。在大多数系
统中，是用圆点“.”将文件名和扩展名分隔开的。例如，myf ile.txt中的扩展名.txt，表示该文件
是文本文件；myprog.bin中的扩展名.bin，表示该文件是可执行的二进制文件。扩展名的长度一
般是1～4个字符。
2．文件类型
为了便于管理和控制文件，将文件分成了若干类。由于不同的系统针对文件的管理方式不
同，因此它们针对文件的分类方法也有很大差异。下面是常用的几种文件分类方法。
（1）按性质和用途分类。
根据文件的性质和用途的不同，可将文件分为3 类。①系统文件，指由系统软件构成的文
件。大多数的系统文件只允许用户调用，但不允许用户去读，更不允许用户修改；有的系统文
件不直接对用户开放。②用户文件，指由用户的源代码、目标文件、可执行文件或数据等所构
成的文件。用户将此类文件委托给系统进行保管。③库文件，这是由标准子例程及常用的例程
等所构成的文件。此类文件允许用户调用，但不允许用户修改。
（2）按文件中数据的形式分类。
按这种方式分类，也可把文件分为3类。①源文件，指由源程序和数据构成的文件。通常，
由终端或输入设备输入的源程序和数据所形成的文件都属于源文件，它通常是由美国信息交换

--- Page 272 ---
251
第
8章 
文件管理
标准代码（American standard code for information interchange ，ASCII）或汉字所组成的。②目标
文件，指由“把源程序经过编译程序编译后、但尚未经过链接程序链接的目标代码”所构成的
文件，其后缀名是“.obj”。③可执行文件，指源程序经过编译程序编译后所产生的目标代码，
再经过链接程序链接后所形成的文件，在Windows系统中，其后缀名是.exe或.com。
（3）按存取控制属性分类。
根据系统管理员或用户所规定的存取控制属性，可将文件分为3 类：①可执行文件，该类文
件只允许被核准的用户调用执行，不允许读和写；②只读文件，该类文件只允许文件拥有者及被
核准的用户去读，不允许写；③读/写文件，指允许文件拥有者和被核准的用户去读/写的文件。
（4）按组织形式和处理方式分类。
根据文件的组织形式和系统对其处理方式的不同，可将文件分为3 类：①普通文件，是指
由ASCII或二进制码所组成的字符文件，通常，用户建立的源程序文件、数据文件以及OS自身
的代码文件、实用程序等都属于普通文件；②目录文件，是指由文件目录所组成的文件，通过
目录文件可以对其下属文件的信息进行检索，对其可执行的文件进行（与普通文件一样的）操
作；③特殊文件，特指系统中的各类I/O设备，为了便于统一管理，系统将所有的I/O设备都视为
文件，并按文件的使用方式提供给用户使用，如目录的检索、权限的验证等操作都与普通文件
相似，只是对这些文件的操作将由设备驱动程序来完成。
8.1.3　文件系统的层次结构
如图8-3所示，文件系统的模型可分为3 个层次：最低层是对象及其属性，中间层是对对象
进行操纵和管理的软件集合，最高层是文件系统（提供给用户的）接口。
用户（程序）
对象及其属性
对对象进行操纵和管理的软件集合
文件系统接口
图 8-3　文件系统模型
1．对象及其属性
文件系统所管理的对象有3 类。①文件，在文件系统中有着各种不同类型的文件，它们都
作为文件系统的直接管理对象。②目录，为了方便用户对文件进行存取和检索，在文件系统中
必须配置目录，且目录的每个目录项中必须含有文件名、对文件属性的说明以及该文件所在的
物理地址（或指针）。对目录的组织和管理，是方便用户和提高文件存取速度的关键。③磁盘
（磁带）存储空间，文件和目录必定会占用磁盘存储空间，对这部分空间进行有效管理，不仅
能提高外存的利用率，而且能提高文件存取速度。
2．对对象进行操纵和管理的软件集合
该层是文件系统的核心部分，文件系统的功能大多是在这一层实现的，其中包括：①文件
存储空间管理功能；②文件目录管理功能；③用于将文件的逻辑地址变换为物理地址的机制；
④文件读/写管理功能；⑤文件的共享与保护功能等。在实现这些功能时，OS通常会采取层次组
织结构，即在每一层中都包含一定的功能，处于某个层次的软件只能调用同层或更低层中的功

--- Page 273 ---
252
计算机操作系统 （慕课版）
能模块。关于OS层次结构的介绍参见本书第1章。
一般地，把与文件系统有关的软件分为4 个层次： ①I/O控制层 ，是文件系统的最低层，
主要由磁盘驱动程序等组成，也可称为设备驱动程序层； ②基本文件系统，主要用于实现内存
与磁盘之间数据块的交换； ③文件组织模块 ，也称为基本I/O管理程序，该层负责完成与磁盘  
I/O有关的事务，如将文件逻辑块号变换为物理块号、管理磁盘中的空闲盘块、指定I/O缓冲等；
④逻辑文件系统，用于处理并记录同文件相关的操作，如允许用户和应用程序使用符号文件名
访问文件和记录、保护文件和记录等。因此，整个文件系统可用图8-4所示的层次结构表示。
应用程序
逻辑文件系统
文件组织模块
基本文件系统
I/O控制层
设备
图 8-4　文件系统的层次结构
3．文件系统接口
为方便用户使用，文件系统以接口的形式提供了一组对文件和记录进行操作的方法和手
段。常用的两类接口是： ①命令接口，指用户与文件系统直接进行交互的接口，用户可通过该
类接口输入命令（如通过键盘终端键入命令），进而获得文件系统的服务； ②程序接口，指用
户程序与文件系统的接口，用户程序可通过系统调用获得文件系统的服务，例如，通过系统调
用Creat创建文件，通过系统调用Open打开文件等。
8.1.4　文件操作
用户可以通过文件系统提供的系统调用对文件进行操作。最基本的文件操作包括创建、删
除、读、写和设置文件的读/写位置等。实际上，一般的OS都提供了更多针对文件的操作，如打
开和关闭一个文件以及改变文件名等。
1．最基本的文件操作
最基本的文件操作介绍如下。 ①创建文件。在创建一个新文件时，要为新文件分配必要的
外存空间，并在文件目录中为之建立一个目录项；目录项中应记录新文件的文件名及其在外存
中的地址等属性。 ②删除文件。在删除文件时，应先从目录中找到要删除文件的目录项，并使
之成为空项，然后回收该文件所占用的存储空间。 ③读文件。在读文件时，根据用户给出的文
件名去查找目录，从中得到被读文件在外存中的地址；在目录项中，还有一个指针用于对文件
进行读操作。④写文件。在写文件时，根据文件名查找目录，找到指定文件的目录项后，再利
用目录中的写指针进行写操作。 ⑤设置文件的读/写位置 。前面所述的文件读/ 写操作，都只提
供了对文件顺序存取的手段，即每次都是从文件的始端开始读或写；设置文件读/ 写位置的操

--- Page 274 ---
253
第
8章 
文件管理
作，通过设置文件读/写指针的位置，使得在读/写文件时不必每次都从其始端开始操作，而是可
以从所设置的位置开始操作，因此可以改顺序存取为随机存取。
2．文件的“打开”和“关闭”操作
当用户要求对一个文件实施多次读/ 写或其他操作时，每次都要从检索目录开始。为了避
免多次重复地检索目录，在大多数OS中都引入了“打开”（Open）这一文件系统调用。当用
户第一次请求对某文件进行操作时，须先利用系统调用Open将该文件打开。所谓“打开”，
是指系统将指定文件的属性（包括该文件在外存中的物理位置），从外存复制到内存中的打开
文件表的一个表目中，并将该表目的编号（或称为索引号）返回给用户。换言之，“打开”就
是在用户和指定文件之间建立一个连接。此后，用户可通过该连接直接得到文件信息，从而避
免再次通过目录检索文件，即当用户再次向系统发出文件操作请求时，系统可以根据用户提供
的索引号，直接在打开文件表中查找到文件信息。这样不仅节省了大量的检索开销，还显著地
提高了对文件的操作速度。如果用户已不再需要对该文件实施相应的操作，则可利用“关闭”
（Close）系统调用来关闭此文件，即断开此连接，而后OS将会把此文件从打开的文件表中的表
目上删除。
3．其他文件操作
OS为用户提供了一系列面向文件操作的系统调用，最常用的一类是关于对文件属性进行操
作的，即允许用户直接设置和获得文件的属性，如改变已存文件的文件名、改变文件的拥有者
（文件拥有者）、改变对文件的访问权以及查询文件的状态（包括文件类型、大小、拥有者以
及对文件的访问权）等；另一类是关于目录的，如创建一个目录、删除一个目录、改变当前目
录和工作目录等；此外，还有用于实现文件共享的系统调用，以及用于对文件系统进行操作的
系统调用等。
针对有些系统，当文件第一次被引用时，其会自动打开文件，结束时又会自动关闭文件。
请思考这种方案与传统的由用户显式地打开和关闭文件的方案相比，有什么优缺点。
思考题
8.2　文件的逻辑结构
用户所看到的文件称为逻辑文件，它是由一系列的逻辑记录所组成的。
从用户的角度来看，文件的逻辑记录是能够被存取的基本单位。在进行文件系
统高层设计时，所涉及的关键点是文件的逻辑结构，即如何用这些逻辑记录来
构建一个逻辑文件。在进行文件系统低层设计时，所涉及的关键点是文件的物
理结构，即如何将一个文件存储在外存上。由此可见，系统中的所有文件都存在着以下两种形
式的文件结构。
（1）文件的逻辑结构（file logical structure ），是指从用户角度出发所观察到的文件组织形
式，即文件是由一系列的逻辑记录所组成的，是用户可以直接处理的数据及其结构，它独立于
文件的物理特性，又称为文件组织（file organization）。对应的文件通常称为逻辑文件。
（2）文件的物理结构，又称为文件的存储结构，是指系统将文件存储在外存上所形成的一
文件的逻辑结构


--- Page 275 ---
254
计算机操作系统 （慕课版）
种存储组织形式，是用户所看不见的。文件的物理结构不仅与存储介质的存储性能有关，而且
与所采用的外存分配方式也有关。无论是文件的逻辑结构，还是文件的物理结构，都会影响系
统对文件的检索速度。
8.2.1　文件逻辑结构的类型
对文件逻辑结构所提出的基本要求，首先是有助于提高系统对文件的检索速度，即在将大
批记录组成文件时，应采用一种有利于提高检索记录速度和效率的逻辑结构；然后是该结构应
方便用户对文件进行维护，即便于用户在文件中增加、删除、修改一个或多个记录；最后是降
低文件存放在外存上的存储费用，即尽量减少文件所占用的存储空间，使其不要求系统为其提
供大片的连续存储空间。
按文件是否有结构来分，可将文件分为两类：一类是有结构文件，指由一个以上的记录所
构成的文件，故又将其称为记录式文件；另一类是无结构文件，指由字节流所构成的文件，故
又将其称为流式文件。按文件的组织方式来分，有结构文件又可被分为顺序文件、索引文件和
索引顺序文件等。
1．按文件是否有结构来分
（1）有结构文件。
在记录式文件中，每个记录都用于描述实体集中的一个实体，各记录有着相同或不同数目
的数据项。记录的长度可分为定长和变长两类。
① 定长记录，是指文件中所有记录的长度都是相同的，所有记录中的各数据项都处在记录
中相同的位置，具有相同的顺序和长度。文件的长度用记录数目表示。定长记录能有效地提高
检索记录的速度和效率，用户能方便地对文件进行处理，因此定长记录是目前较常用的一种记
录格式，被广泛应用于数据处理中。
② 变长记录，是指文件中各记录的长度不一定相同。产生变长记录的原因，可能是一个记
录中所包含的数据项（如书的著作者、论文中的关键词等）数目并不相同，也可能是数据项本
身的长度不定，例如，病历记录中的病因与病史、科技情报记录中的摘要等。不论是哪一种原
因导致记录的长度不同，在处理前，每个记录的长度都是可知的。对变长记录的检索速度慢，
这不便于用户对文件进行处理。但由于变长记录很适合于某些场合的需要，因此其也是目前较
常用的一种记录格式，被广泛应用于许多商业领域。
（2）无结构文件。
如果说在大量的信息管理系统和数据库系统中，广泛采用了有结构的文件形式的话，即文
件是由定长或变长记录构成的，那么在系统中运行的大量源程序、可执行文件、库函数等，所
采用的就是无结构的文件形式，即流式文件。此类文件的长度是以字节为单位的。对流式文件
的访问，则是指利用读/ 写指针来指出下一个要访问的字节。可以把流式文件看作记录式文件的
一个特例：一个记录仅有一个字节。
2．按文件的组织方式来分
根据文件的组织方式，可把有结构文件分为3类：①顺序文件，指由一系列记录按某种顺序
排列所形成的文件，其中的记录可以是定长记录或可变长记录； ②索引文件，为可变长记录文
件建立一张索引表，为每个记录设置一个索引表项，以加速对记录的检索速度； ③索引顺序文
件，是顺序文件和索引文件相结合的产物，这里，在为每个文件建立一张索引表时，并不是为

--- Page 276 ---
255
第
8章 
文件管理
每个记录建立一个索引表项，而是为一组记录中的第一个记录建立一个索引表项。
8.2.2　顺序文件
文件的逻辑结构中记录的组织方式，来源于用户和系统在管理上的目标和需求。不同的目
标和需求产生了不同的组织方式，从而形成了逻辑结构相异的多种文件。其中，最基本也是最
常见的文件就是顺序文件（sequential file）。
1．顺序文件的排列方式
顺序文件中的记录可以按照不同的结构进行排列，一般可分为两种情况。
（1）串结构。串结构文件中的记录，通常是按存入文件的先后时间进行排序的，各记录之
间的顺序与关键字无关。在对串结构文件进行检索时，每次都必须从头开始逐个地查找记录，
直至找到指定的记录或者查完所有的记录为止。显然，对串结构文件进行检索是比较费时的。
（2）顺序结构。由用户指定一个字段作为关键字，它可以是任意类型的变量，其中最简单
的是正整数，如0到N-1。为了能唯一地标志每个记录，必须使每个记录的关键字值在文件中具
有唯一性。这样，文件中的所有记录就可以按关键字来排序，如按关键字值的大小或其对应英
文字母的顺序进行排序。在对顺序文件进行检索时，还可以利用某种有效的查找算法（如折半
查找法、插值查找法、跳步查找法等）来提高检索效率。因此，顺序文件可以有更高的检索速
度和效率。
2．顺序文件的优缺点
顺序文件的最佳应用场合是在对文件中的记录进行批量存取时，即每次要读/ 写一大批记
录时。在所有逻辑文件中，顺序文件的存取效率是最高的。此外，对于顺序存储设备（如磁
带），也只有顺序文件才能被存储并有效地工作。
在交互应用的场合中，如果用户（程序）要求查找或修改单个记录，则系统需要在文件的
记录中逐个地进行查找，此时，顺序文件所表现出的性能就可能很差。尤其是当文件较大时，
情况更为严重。例如，对于一个含有10
4
个记录的顺序文件，如果采用顺序查找法查找到一个指
定的记录，则平均需要查找5 ×10
3
次。如果顺序文件中存放的是变长记录，则须付出更大的查
找代价，这也限制了顺序文件的长度。
顺序文件的另一个缺点是，不论是想增加还是删除一个记录，都比较困难。为了解决这
一问题，可以为顺序文件配置一个运行记录文件（log file）或称之为事务文件（transaction 
file），把试图增加、删除或修改的信息记录于其中，规定每隔一定时间（例如4 小时）就将运
行记录文件与原来的主文件加以合并，产生一个按关键字排序的新文件。
8.2.3　顺序文件记录寻址
为了访问顺序文件中的一条记录，首先应找到该记录的地址。查找记录地址的方式有两
种：隐式寻址方式和显式寻址方式。
1．隐式寻址方式
对于定长记录的顺序文件，如果已知当前记录的逻辑地址，便很容易确定下一个记录的逻
辑地址。在读一个文件时，为了读文件，在系统中应设置一个读指针Rptr（见图8-5），令它指
向下一个记录的始址；每当读完一个记录，便执行Rptr=Rptr+ L操作，使之指向下一个记录的始

--- Page 277 ---
256
计算机操作系统 （慕课版）
址，其中的L为记录长度。类似地，为了写文件，也应设置一个写指针Wptr，使之指向要写的记
录的始址。同样，在每写完一个记录时，须执行Wptr=Wptr+L操作。
Rptr
∑
i
k=0
（Lk+1）
∑
i-1
k=0
（Lk+1）
0
（a）定长记录顺序文件 （b）变长记录顺序文件
R0
L0
L0
L0+L1+2
L0+1
L1
L1
R0
R1
L
L
0
L
2L
3L
4L
iL
（i+1）L
L
L
R1
} }
}
}
}
}
}
L}
R2
R3
Ri
Li
Li
Ri
…
……
…
Wptr
图 8-5　定长和变长记录顺序文件
对于变长记录的顺序文件，在顺序读/ 写时的情况与定长记录的顺序文件相似，只是每次都
需要从正在读/写的记录中读出该记录的长度。同样需要分别为它们设置读/写指针，但在每次读/
写完一个记录后，均须将读/ 写指针加上Li，Li是刚读/写完的记录的长度。这种顺序访问的方式
可用于所有文件类型，其主要问题是：访问一个指定记录 i，必须扫描或读取前面第0 ～i-1个记
录。这实际上是顺序访问，因此访问速度比较慢。
2．显式寻址方式
该方式可用于对定长记录顺序文件实现直接访问或随机访问，因为任何记录的位置都很容易
通过记录长度计算出来，而对于变长记录的顺序文件，则不能利用显式寻址方式实现直接访问或
随机访问，而必须增加适当的支持机构方能实现。下面通过两种方式对定长记录实现随机访问。
（1）利用文件中记录的位置。在该方式下，文件中的每个记录均可用从0到N-1的整数来标
志，即用一个整数来唯一地标志一个记录。对于定长记录的顺序文件，如果要查找第 i个记录，
则可直接根据下式计算获得第i个记录相对于第1个记录起始地址的地址：
Ai=i×L，
由于获得任何记录地址的时间都非常短，因此可利用这种方式对定长记录实现随机访问。
然而对于变长记录，则不能利用显式寻址方式对一个文件实现随机访问，因为在查找其中
的第i个记录时，须首先计算出该记录的起始地址。为此，须顺序地查找每个记录，并从中获得
相应记录的长度Li，然后才能计算出第i个记录的起始地址Ai。假定在每个记录前用一个字节指明
该记录的长度，则有：
，
可见，用直接存取方式来访问变长记录顺序文件中的一个记录是十分低效的，其检索时间也很
难令人接受，因此不能利用这种方式对变长记录实现随机访问。
（2）利用关键字。在该方式下，用户必须指定一个字段作为关键字，通过指定的关键字来
查找该记录。当用户给出要检索记录的关键字时，系统将利用该关键字顺序地从第1 个记录开始
比较指定关键字和每个记录的关键字，直至找到相匹配的记录。
值得一提的是，基于关键字的变长记录在商业领域很重要，应用很广泛，但因为在专门的
数据库系统中已经实现了对它们的支持，并能从不同的角度来管理、组织和显示数据，所以只
有一些现代OS的文件系统对它们提供了支持。但是文件目录是个例外，因为对目录的检索是基

--- Page 278 ---
257
第
8章 
文件管理
于关键字来进行的。其中，关键字是符号文件名，相关内容将会在8.3节中进行介绍。
8.2.4　索引文件
1．按关键字建立索引
定长记录顺序文件很容易通过简单的计算实现随机查找，但变长记录顺序文件查找一个记
录则必须从第一个记录查起，一直顺序查找到目标记录为止，耗时很长。我们为变长记录顺序
文件建立一张索引表，为主文件中的每个记录在索引表中分别设置一个索引表项，用于记录指
向记录的指针（即记录在逻辑地址空间的起始地址）以及记录的长度。索引表按关键字排序，
因此其本身也是一个定长记录的顺序文件，这样就把对变长记录顺序文件的顺序检索，转变
成了对定长记录索引文件（index file ）的随机检索，从而加快了记录检索速度，实现了直接存
取。图8-6所示为索引文件的组织形式。
完全
索引
完全
索引
（a）具有单个索引表的索引文件 （b）具有多个索引表的索引文件
部分
索引
索引号
索引表
逻辑文件
原始文件
（长度可变的记录）
0 m0
R0
R1
Ri
m1
mi
1
i
…
…
…
…
长度m 指针ptr
图 8-6　索引文件的组织形式
由于是按关键字建立的索引，因此在对索引文件进行检索时，可以根据用户（程序）提供的
关键字，利用折半查找法检索索引表，从中找到相应的表项；再利用该表项中所给出的指向记录
的指针去访问所需的记录。每当要在索引文件中增加一个新记录时，便须对索引表进行修改。由
于索引文件具有较快的检索速度，其主要应用于对信息处理的及时性有较高要求的场合。
2．具有多个索引表的索引文件
按关键字建立索引表的索引文件与顺序文件一样，都只能按该关键字进行检索。而实际应
用情况往往是：不同的用户为了不同的目的，希望能按不同的属性（或不同的关键字）来检索
一条记录。为实现此要求，需要为顺序文件建立多个索引表，即为每种可能成为检索条件的域
（属性或关键字）都配置一张索引表。每张索引表都按相应的一种属性或关键字进行排序。例
如，有一个图书文件，为每本书建立了一个记录，此时可以为该图书文件建立多个索引表，其
中第一个索引表所用的关键字是图书编号，第二个索引表所用的关键字是书名，第三个索引表
所用的关键字是作者姓名，第四个索引表所用的关键字是出版时间等。这样，用户就可以根据
自己的需要，用不同的关键字来对该图书文件进行检索。
索引文件的主要优点是，它将一个需要顺序查找的文件，改造成了一个可随机查找的文

--- Page 279 ---
258
计算机操作系统 （慕课版）
件，极大地提高了用户（程序）对文件的查找速度，同时也便于进行记录插入与删除，故索
引文件成为了当今应用最为广泛的一种文件形式。只是它除了有主文件外，还须配置一张索引
表，而且每个记录都要有一个索引项，因此增加了存储开销。
8.2.5　索引顺序文件
1．索引顺序文件的特征
索引顺序文件（index sequential file ）是对顺序文件的一种改进，它基本上克服了变长记
录的顺序文件不能被随机访问以及不便于删除和插入记录等缺点，但同时保留了顺序文件的关
键特征，即记录是按关键字的顺序组织起来的。它又增加了两个特征：一个是引入了文件索引
表，通过该表可以实现对索引顺序文件的随机访问；另一个是增加了溢出（overflow）文件，用
它来记录新增加的、删除的和修改的记录。可见，索引顺序文件是顺序文件和索引文件相结合
的产物，能有效克服变长记录顺序文件的缺点，而且所付出的代价也不算太大。
2．一级索引顺序文件
最简单的索引顺序文件只使用了一级索引。其具体的建立方法是，首先将变长记录顺序文
件中的所有记录分为若干组，如50个记录为一组；然后为文件建立一张索引表，并为每组中的
第一个记录在索引表中建立一个索引项，其中包含该记录的关键字和指向该记录的指针。索引
顺序文件是最常见的一种逻辑文件形式，如图8-7所示。
键
逻辑地址
姓名
其他属性
An Qi
An Qi
An Kang
Bao Rong
…
m0
m1
Bao Rong
Chen Lin
逻辑文件
图 8-7　索引顺序文件
在对索引顺序文件进行检索时，首先也是利用用户（程序）所提供的关键字以及某种查找
算法检索索引表，找到该记录所在记录组中第一个记录的表项，从中获知该记录组第一个记录
在主文件中的位置；然后，利用顺序查找法查找主文件，从中找到所要的记录。
如果一个顺序文件中所含有的记录的数量为 N，则为了检索到具有指定关键字的记录，平
均须查找N/2个记录。但对于索引顺序文件，为了检索到具有指定关键字的记录，平均仅须查找
个记录数，因而其检索效率比顺序文件约高了
 /2倍。例如，有一个顺序文件，如果其含
有10 000个记录，则平均须查找的记录数为5 000； 但如果其是一个索引顺序文件，则平均仅须
查找100个记录。可见，索引顺序文件的检索效率是顺序文件的50倍。
3．两级索引顺序文件
不能忽视的是，对于一个非常大的文件，为找到一个记录而须查找的记录数目仍然很多。
例如，对于一个含有10
6
个记录的顺序文件，当把它作为索引顺序文件时，为找到一个记录，平

--- Page 280 ---
259
第
8章 
文件管理
均须查找1 000个记录。为了进一步提高检索效率，可以为顺序文件建立多级索引，即为索引顺
序文件再建立一张索引表，从而形成两级索引表。例如，对于一个含有10
6
个记录的顺序文件，
可先为该文件建立一张低级索引表，每100个记录为一组，故低级索引表应含有10
4
个表项，在
每个表项中存放顺序文件中每组第一个记录的记录键值和指向该记录的指针；然后再为低级索
引表建立一张高级索引表，这时，也同样令每100个索引表为一组，故具有10
2
个表项。这里的
每个表项中存放的是低级索引表每组第一个表项中的关键字，以及指向该表项的指针。此时，
为找到一个具有指定关键字的记录，所须查找的记录数平均为50+50+50=150，或者可表示为
(3/2)
 ，其中，N是顺序文件中的记录个数。注意：对于未建立索引表的顺序文件，所须查找
的记录数平均为500 000个；对于建立了一级索引的顺序文件，平均须查找1 000次；对于建立了
两级索引的顺序文件，平均仅须查找150次。
8.2.6　直接文件和哈希文件
1．直接文件
采用前述几种文件结构对记录进行存取时，都须利用给定的记录键值先对线性表或链表进
行检索，以找到指定记录的物理地址。然而对于直接文件，则可根据给定的关键字直接获得指
定记录的物理地址。换言之，关键字本身决定了记录的物理地址。这种由关键字（的值）到记
录的物理地址的变换，被称为键值变换（key to address transformation）。组织直接文件的关键
在于，通过什么方法进行从关键字的值到记录的物理地址的变换。
2．哈希文件
哈希（Hash）文件是目前应用最为广泛的一种直接文件。它利用Hash函数（或称散列函
数）可将关键字变换为相应记录的地址。但为了实现文件存储空间的动态分配，利用Hash函数
所求得的结果通常并不是相应记录的地址，而是指向某一目录表相应表目的指针，该表目的内
容指向了相应记录所在的物理块，如图8-8所示。例如，若令 K为记录键值， A为通过Hash函数
H()的变换而形成的该记录在目录表中对应表目的位置，则有关系 A=H（K）。通常，把Hash函
数作为标准函数存于系统中，供存取文件时调用。
目录表
键值
Hash函数
…
f
图 8-8　Hash 文件的逻辑结构
8.3　文件目录
通常，在现代计算机系统中，都要存储大量的文件。为了能对这些文件实施有效的管理，
必须对它们加以妥善组织，这主要是通过文件目录来实现的。文件目录也是一种数据结构，用
于标志系统中的文件及其物理地址，供检索时使用。对目录管理的要求如下。
文件目录


--- Page 281 ---
260
计算机操作系统 （慕课版）
（1）实现“按名存取”，即用户只须向系统提供所须访问文件的名字，便能快速准确地找
到指定文件在外存中的存储位置。这是目录管理中最基本的功能，也是文件系统向用户提供的
最基本的服务。
（2）提高对目录的检索速度，通过合理地组织目录结构，可加快对目录的检索速度，从而
提高对文件的存取速度。这是在设计一个大、中型文件系统时所追求的主要目标。
（3）文件共享，在多用户系统中，应允许多个用户共享一个文件。这样，只须在外存中保
留一份该文件的副本供不同用户使用即可，如此便可节省大量的存储空间，同时还可以方便用
户使用和提高文件利用率。
（4）允许文件重名，系统应允许不同用户对不同文件采用相同的名字，以便用户按照自己
的习惯给文件命名和使用文件。
8.3.1　文件控制块和索引节点
为了能对一个文件进行正确的存取，必须为文件设置用于描述和控制文件的数据结构，称
之为文件控制块（file control block，FCB）。文件管理程序可借助于FCB中的信息对文件施以各
种操作。文件与FCB一一对应，而人们把FCB的有序集合称为文件目录，即一个FCB就是一个文
件目录项。通常，一个文件目录也被看作一个文件，称为目录文件。
1．FCB
为了能对系统中的大量文件施以有效的管理，在FCB中，通常应含有3 类信息，即基本信息
类、存取控制信息类及使用信息类。
（1）基本信息类。基本信息类包括：①文件名，指用于标志一个文件的符号名，在每个系
统中，每个文件都必须有唯一的名字，用户利用该名字进行存取；②文件物理位置，指文件在
外存中的存储位置，它包括存放文件的设备名、文件在外存上的起始盘块号、指示文件所占用
的盘块数或字节数的文件长度；③文件逻辑结构，指示文件是流式文件还是记录式文件、文件
中的记录数、文件是定长记录还是变长记录等；④文件的物理结构，指示文件在外存中的组织
方式，如连续组织方式、链接组织方式或索引组织方式等。
（2）存取控制信息类。存取控制信息类包括文件拥有者的存取权限、核准用户的存取权限
以及一般用户的存取权限。
（3）使用信息类。使用信息类包括：文件的建立日期和时间，文件上一次修改的日期和时
间，以及当前使用的信息，这些信息包括当前已打开该文件的进程数、是否被其他进程锁住、
文件在内存中是否已被修改但尚未复制到盘上等。应该说明，对于不同OS的文件系统，由于功
能不同，它们可能只含有上述信息中的部分信息。
图8-9所示为MS-DOS系统中的FCB，其中含有文件名、扩展名、文件属性、文件建立日期
和时间、文件所在的第一盘块号以及盘块数等。FCB的长度为32B，对于容量为360KB的软盘，
其总共可包含112个FCB，共占4KB（而非3.5KB）的存储空间。
文件建立时间
文件建立日期
第一盘块号
盘块数
文件名
扩展名
文件属性
备用
图 8-9　MS-DOS 系统中的 FCB

--- Page 282 ---
261
第
8章 
文件管理
2．索引节点
（1）索引节点的引入。
文件目录通常存放在磁盘上。当文件有很多时，文件目录可能要占用大量的盘块。在查
找目录的过程中，必须先将存放目录文件的第一个盘块中的目录调入内存，然后将用户所指定
的文件名与目录项中的文件名逐一比较。若未找到指定文件，则须将下一盘块的目录项调入内
存。假设目录文件所占用的盘块数为 N，按此方法查找，则查找一个目录项平均需要调入盘块
(N+1)/2次。假如一个FCB为64B，盘块大小为1KB，则每个盘块中只能存放16个 FCB。若一个文
件目录中共有640个FCB，则须占用40个盘块，因此平均查找一个文件须启动磁盘20次。
稍加分析可以发现，在检索目录文件的过程中只用到了文件名，仅当找到一个目录项（即
其中的文件名与指定要查找的文件名相匹配）时，才须从该目录项中读出该文件的物理地址。
而其他对该文件进行描述的信息，在检索目录时一概不用。显然，这些信息在检索目录时无须
调入内存。为此，在有的系统（如UNIX系统）中便采用了把文件名与文件描述信息分开的办
法，亦即，使文件描述信息单独形成一个称为索引节点（iNode）的数据结构，简称为i节点。文
件目录中的每个目录项，仅由文件名和指向该文件所对应的索引节点的指针所构成。在 UNIX系
统中，一个目录仅占16B，其中14B为文件名，2B为索引节点指针。在1KB的盘块中可容纳64个
目录项，这样，为找到一个文件，可使平均启动磁盘次数减少到原来的1/4，大大节省了系统开
销。图8-10所示为UNIX系统的文件目录。
文件名
文件名1
文件名2
…
…
索引节点编号
0
13
14
15
图 8-10　UNIX 系统的文件目录
（2）磁盘索引节点。
磁盘索引节点是指存放在磁盘上的索引节点。每个文件都有唯一的一个磁盘索引节点，
它主要包括以下内容：①文件拥有者标识符，即拥有该文件的个人或小组的标识符；②文件
类型，包括正规文件、目录文件或特别文件；③文件存取权限，指各类用户对该文件的存取
权限；④文件物理地址，每个索引节点中均含有 13个地址项，即 i.addr(0) ～i.addr(12) ，它们
以直接或间接方式给出数据文件所在盘块的编号；⑤文件长度，指以字节为单位的文件长
度；⑥文件连接计数，表明在本文件系统中，所有指向该（文件的）文件名的指针计数；   
⑦文件存取时间，指出本文件最近被进程存取的时间、本文件最近被修改的时间以及索引节
点最近被修改的时间。
（3）内存索引节点。
内存索引节点是指存放在内存中的索引节点。当文件被打开时，要将磁盘索引节点复制
到内存索引节点中，便于以后使用。在内存索引节点中又增加了以下内容：①索引节点编号，
用于标志内存索引节点；②状态，指示索引节点是否上锁或被修改；③访问计数，每当有一进
程要访问此索引节点时，就将该访问计数加1 ，访问完再减1 ；④文件所属文件系统的逻辑设备
号；⑤链接指针，设置有分别指向空闲链表和散列队列的指针。

--- Page 283 ---
262
计算机操作系统 （慕课版）
8.3.2　简单的文件目录
目录结构的组织，关系到文件系统的存取速度，也关系到文件的共享性和安全性。因此，
组织好文件的目录，是设计好文件系统的重要环节。目前，最简单的文件目录形式是单级文件
目录和两级文件目录。
1．单级文件目录
单级文件目录是最简单的文件目录，在整个文件系统中只建立一张目录表，每个文件占
一个目录项，目录项中含有文件名、扩展名、文件长度、文件类型、物理地址、文件说明以及
其他文件属性。此外，为表明每个目录项是否空闲，又设置了一个状态位。单级文件目录如图
8-11所示。
文件名
扩展名
文件长度
物理地址
文件类型
文件说明
状态位
文件名1
文件名2
…
图 8-11　单级文件目录
每当要建立一个新文件时，都必须先检索所有的目录项，以保证新文件名在目录中是唯一
的。然后再从目录表中找出一个空白目录项，填入新文件的文件名及其他信息，并置状态位为
1。在删除文件时，先从目录中找到要删除文件的目录项，回收该文件所占用的存储空间，然后
再清除该目录项。
单级文件目录的优点是简单，但它只能实现目录管理中最基本的功能——按名存取，不能
满足对文件目录的其他3 方面的要求，具体说明如下。①查找速度慢。对于稍具规模的文件系
统，为找到一个指定的目录项要花费较多的时间。对于一个具有N个目录项的单级文件目录，为
检索出一个目录项，平均须查找N/2个目录项。②不允许重名。在一个目录表中，所有文件都不
能与另一个文件具有相同的名字。然而，重名问题在多用户环境下，却又是难以避免的；即使
在单用户环境下，当文件数超过数百个时，也会由于不易记忆而难以避免。③不便于实现文件
共享。通常，每个用户都有自己的名字空间或命名习惯。因此，应当允许不同用户使用不同的
文件名来访问同一个文件。然而，单级文件目录却要求所有用户都只能用同一个名字来访问同
一个文件。简而言之，单级文件目录只能满足对目录管理的四点要求中的第一点，因此，它只
适用于单用户环境。
2．两级文件目录
为了克服单级文件目录所存在的缺点，可以为每个用户再建立一个单独的用户文件目录
（user file directory， UFD）。这些UFD具有相似的结构，它们由用户所有文件的FCB组成。此
外，在系统中再建立一个主文件目录（master file directory， MFD）；在MFD中，每个用户都占
有一个目录项，其目录项中包括用户名和指向相应UFD的指针。如图8-12所示，MFD中含有3 个
用户名，即Wang、Zhang和Gao。
在两级文件目录中，用户如果希望有自己的UFD，则可以请求系统为自己建立一个UFD；
如果自己不再需要UFD，则也可以请求系统管理员将它撤销。在有了UFD 后，用户可以根据自
己的需要创建新文件。每当此时， OS只须检查该用户的UFD，并判定在该UFD中是否已有同名
的另一个文件即可。若有，则用户必须为新文件重新命名。若无，则在UFD中建立一个新目录

--- Page 284 ---
263
第
8章 
文件管理
项，将新文件名及其有关属性填入该目录项中，并置其状态位为“1 ”。当用户要删除一个文件
时，OS也只须查找该用户的UFD，从中找出指定文件的目录项，在回收该文件所占用的存储空
间后，将该目录项删除。两级文件目录已基本能够满足系统对文件目录的4 方面的要求，现对能
满足第2、3、4方面的要求做进一步的说明。
Alpha
Test
Report Report
Test
Beta Beta
Device
用户名
Wang
Zhang
Gao
Wang用户目录
Zhang用户目录
Gao用户目录
Misx
Misx
Alpha
Test
Test
Device
指向子目录指针
图 8-12　两级文件目录
（1）提高了检索目录的速度。如果在MFD中有 n个子目录，每个UFD 最多含m个目录项，
则为了查找一指定的目录项，最多只须检索 n+m个目录项。但如果采用单级文件目录，则最多
须检索n×m个目录项。假定n=m，可以看出，采用两级文件目录可使检索效率提高n/2倍。
（2）在不同的UFD中，可以使用相同的文件名，只要在用户自己的UFD中每个文件名都是
唯一的即可。例如，用户Wang可以用Test来命名自己的一个测试文件，用户Zhang也可以用Test
来命名自己的一个（不同于Wang的Test测试文件的）测试文件。
（3）不同用户还可以使用不同的文件名来访问系统中的同一个共享文件。采用两级文件目
录也存在一些问题。该目录结构虽能有效地将多个用户隔开，在各用户之间完全无关时，这种
隔离是一个优点，但当多个用户之间要相互合作去完成一个大任务，且一个用户又须去访问其
他用户的文件时，这种隔离便成了一个缺点，因为这种隔离会使各用户之间不便于共享文件。
8.3.3　树形目录
1．树形目录简介
在现代OS中，最通用且实用的文件目录无疑是树形目录（tree-structured directory）。它可
以明显地提高对目录的检索速度和文件系统的性能。MFD在这里被称为根目录，在每个文件目
录中，只能有一个根目录，每个文件和每个目录都只能有一个父目录。把数据文件称为树叶，
其他的目录均作为树的节点，或称它们为子目录。图8-13所示为树形目录，图中，方框代表目
录文件，圆圈代表数据文件。在该树形目录中，根目录中有3 个用户的总目录项A、B、C。在B
项所指出的B 用户的总目录B 中，又包括3 个分目录F、E、D，其中每个分目录中又包含多个文
件。如B目录中的F分目录中，包含J和N两个文件。为了提高文件系统的灵活性，应允许在一个
目录文件中的目录项既是目录文件的FCB，又是数据文件的FCB，这可以通过用目录项中的一
位来指示它属于哪一种FCB加以实现。例如，在图8-13中，在A 用户的总目录中，目录项A 是目

--- Page 285 ---
264
计算机操作系统 （慕课版）
录文件的FCB，而目录项B和目录项D则是数据文件的FCB。
1
A
B
C
2
A
B
D
A
14
21
20
19
18
17
16
15
12
13
11
6
7
8
9
3
4
b
H
F
5
10
A
C
J
N
K
J
M
K
F
E
D
G
A
图 8-13　树形目录
2．路径名和当前目录
（1）路径名（path name） 。在树形目录中，从根目录到任何数据文件都只有一条唯一的
通路。在该路径上，从树的根（即主目录）开始，把全部目录文件名与数据文件名依次用“/ ”
连接起来，即可构成该数据文件的路径名。系统中的每个文件都有唯一的路径名。例如，在图
8-13中，用户B若要访问文件J，则应使用其路径名/B/F/J来实现。
（2）当前目录（current directory） 。当一个文件系统含有许多级时，每访问一个文件，
都要使用从树根开始到树叶（数据文件）为止的、包括各中间节点（目录）名的全路径名，
这是相当麻烦的一件事。同时，由于一个进程在运行时其所访问的文件大多仅局限于某个范
围，因而每次从根目录开始访问文件非常不便。基于这一点，可为每个进程设置一个“当前目
录”，又称为“工作目录”。进程对各文件的访问都是相对于当前目录而进行的。此时各文件
所使用的路径名，只须从当前目录开始，逐级经过中间的目录文件，最后到达要访问的数据文
件。把这一路径上的全部目录文件名与数据文件名用“/ ”连接起来，即可形成路径名，如用户
B的当前目录是F ，则此时文件J 的相对路径名仅是J 本身。这样，把从当前目录开始到数据文件
为止所构成的路径名称为相对路径名（relative path name），而把从树根开始的路径名称为绝对
路径名（absolute path name）。
较两级文件目录而言，树形目录的查询速度更快，同时其层次结构更加清晰，能够更加
有效地进行文件的管理和保护。在多级文件目录中，不同性质、不同用户的文件，可以构成不
同的目录子树。不同层次、不同用户的文件，分别呈现在系统目录树中的不同层次或不同子树
中，可以很容易地赋予文件不同的存取权限。但是若想在树形目录中查找一个文件，则须按路
径名逐级访问中间节点，这样就增加了磁盘访问次数，无疑会影响查询速度。目前，大多数OS
（如UNIX、Linux和Windows系列）均采用了树形目录。
3．目录操作
（1）创建目录。在树形目录中，用户可为自己建立UFD，并可再创建子目录。当用户要创
建一个新文件时，只须查看在自己的UFD及其子目录中有无与新建文件相同的文件名。若无，
便可在UFD或其某个子目录中增加一个新目录项。

--- Page 286 ---
265
第
8章 
文件管理
（2）删除目录 。对于一个已不再需要的目录，应如何删除其目录项，须视情况而定。如
果所要删除的目录是空的，即在该目录中已不再有任何文件，则可简单地将该目录项删除，使
它在其上一级目录中对应的目录项为空。如果要删除的目录不空，即其中尚有几个文件或子目
录，则可采用下述两种方法进行处理。①不删除非空目录。当目录（文件）不空时，不能将其
删除；若要删除一个非空目录，则必须先删除目录中的所有文件，使之成为空目录，然后再予
以删除。如果目录中还包含有子目录，则必须采取递归调用方式来将其删除，在MS -DOS系统
中就采用了这种删除方式。②删除非空目录。当要删除一个目录时，如果在该目录中还包含有
文件，则目录中的所有文件和子目录也会同时被删除。上述两种方法实现起来都比较容易，第
二种方法比较方便，但却比较危险，因为整个目录结构虽然用一条命令即能删除，但如果是一
条错误的命令，则后果可能会很严重。
（3）改变目录。使用绝对路径名对用户来说是比较麻烦的。用户可利用改变目录的命令，
通过指定目录的绝对或相对路径名来设置当前目录。如果在使用改变目录的命令时没有明确指
明任何目录，则在默认的情况下当前目录通常会自动地改变到主目录（与指定用户相关的最顶
层目录）。
（4）移动目录。到了一个阶段，通常需要对目录组织进行调整，即将文件或子目录在不同
的父目录之间移动。文件或子目录经移动后，它们的路径名将随之改变。
（5）链接操作。对于树形目录，每个文件和每个目录都只允许有一个父目录，这样不利于
文件共享，但可以通过链接操作让指定文件具有多个父目录，从而方便了文件共享。关于链接
操作，将在8.4节（文件共享）中做详细介绍。
（6）查找操作。当文件目录非常庞大时，要查找一个指定文件是比较困难的。因此在所有
的OS中都支持以多种方式进行查找，例如，可以从根目录或当前目录位置开始进行查找，查找
方式可选用精确匹配或局部匹配等。
假如有 10 万个文件，请思考如何把这些文件存放到一个树形目录中，以使平均的目录检
索性能最佳（每个文件的 FCB 占 4KB，文件名长度最大为 256B，物理块大小为 4KB） 。
思考题
8.3.4　无环图目录
假设两个程序员正在合作开发一个项目，与该项目关联的文件可以保存在一个子目录中，
以区分两个程序员的其他项目文件，但是，两个程序员都希望该子目录在自己的目录中。在这
种情况下，公共子目录应该共享。一个共享的目录或文件可同时位于文件系统的两个（或多
个）地方。
在严格的树形目录中，每个文件只允许有一个父目录，父目录可以有效地拥有该文件，其
他用户要想访问它，都必须经过其所属主目录来实现。这就是说，对文件的共享是不对称的，
或者说，树形目录是不适合文件共享的。假设允许一个文件可以有多个父目录，即有多个属于
不同用户的目录同时指向同一个文件，这样虽会破坏树的特性，但这些用户可用对称的方式实
现文件共享，而不必再通过其所属主目录来进行访问。
有向无环图，即没有循环的有向图，它允许目录共享子目录或文件。同一个文件或子目录
可出现在两个或多个目录中。无环图目录是树形目录的自然扩展，如图8-14所示，图中文件F
8

--- Page 287 ---
266
计算机操作系统 （慕课版）
有3个父目录，分别是D 5、D6、D3，其中D5和D3还使用了相同的名字p ；目录D6有两个父目录D2 
和D1。
根
F10
F5 F6 F7 F8
F9
F4 D7
D4 D5 D6
D2
D1 a z b
D3
F1 F2 F3
F11
l r c n a
pt
n m k h k e f
p
b c
图 8-14　无环图目录
8.3.5　目录查询技术
当用户要访问一个已保存的文件时，系统首先会利用用户提供的文件名对目录进行查询，
找出该文件的FCB或对应的索引节点。然后，根据FCB或索引节点中记录的文件物理地址（盘
块号），换算出文件在磁盘上的物理位置。最后，通过磁盘驱动程序将所需文件读入内存。目
前，对目录进行查询的方法主要有两种：线性检索法和Hash方法。
1．线性检索法
线性检索法又称为顺序检索法。在单级文件目录中，基于用户提供的文件名，可以利用顺
序查找法直接从文件目录中找到指定文件的目录项。在树形目录中，用户提供的文件名是由多
个文件分量名所组成的路径名，此时须对多级文件目录进行查找。假设用户指定的文件路径名
是/usr/ast/mbox，则查找/usr/ast/mbox的过程如图8-15所示。
根目录
结点是
/usr的目录
在结点6中查找
usr字段
132号盘块是
/usr的目录
结点26是
/usr/ast的目录
496号盘块是
/usr/ast的目录
1 ·
··1
4
7
14
9
6
6
1
19
30
51
26
45
8
bin
132 496dev
lib
etc
usr
·
··
dick
erik
jim
ast
bal
26
6
64
92
60
81
17
·
··
grants
books
mbox
minik
src
tmp
图 8-15　查找 /usr/ast/mbox 的过程
上述查找过程具体说明如下。

--- Page 288 ---
267
第
8章 
文件管理
首先，系统应读入第一个文件分量名usr，用它与根目录文件（或当前目录文件）中各目录
项中的文件名依次进行比较，从中找出匹配项，并得到匹配项的索引节点编号为6 ；再从6号索
引节点中得知usr目录文件放在132号盘块中，将该盘块内容读入内存。
然后，系统读入路径名中的第二个分量名ast，用它与放在132号盘块中的第二级目录文件
中各目录项的文件名依次进行比较，从中找到匹配项，并得知ast的目录文件放在26号索引节点
中，再从26号索引节点中得知/usr/ast存放在496号盘块中，将该盘块的内容读入内存。
最后，系统读入该文件的第三个分量名 mbox，用它与第三级目录文件/usr/ast 中各目录项中
的文件名依次进行比较，得知/usr/ast/mbox的索引节点编号为60，即在60号索引节点中存放了指
定文件的物理地址。目录查询操作到此结束。如果在顺序查询过程中发现有一个文件分量名不
能被找到，则应停止查询，并返回“文件未找到”信息。
2．Hash 方法
在8.2.6小节中曾介绍了Hash文件。如果我们建立了一张Hash索引文件目录，则可利用Hash
方法进行查询，即系统将用户提供的文件名变换为文件目录的索引值，再利用该索引值到目录
中去查询，这样会显著提高检索速度。
顺便指出，在现代OS中，通常会提供模式匹配功能，即在文件名中使用了通配符，如
“*”“？ ”等。对于使用了通配符的文件名，系统无法利用Hash方法查询目录，此时，系统还
是需要利用线性查找法来查询目录。
在进行文件名的转换时，有可能把 n个不同的文件名转换为相同的Hash值，即出现所谓的
“冲突”。一种处理此类“冲突”的有效规则介绍如下。
（1）在利用Hash方法查询目录时，如果目录表中相应的目录项是空的，则表示系统中并无
指定文件。
（2）如果目录项中的文件名与指定文件名相匹配，则表示该目录项正是所要寻找的文件所
对应的目录项，故而可从中找到该文件的物理地址。
（3）如果在目录表的相应目录项中的文件名与指定文件名并不匹配，则表示发生了“冲
突”，此时须将其Hash值再加上一个常数（该常数应与目录的长度值互质）以形成新的索引
值，然后返回第一步重新开始查询。
8.4　文件共享
在现代计算机系统中，必须提供文件共享手段，即指系统应允许多个用户（进程）共享同
一份文件。这样，在系统中只须保留该共享文件的一份副本即可。如果系统不能实现文件共享
功能，则意味着凡是需要该文件的用户，都须各自备有此文件的副本，显然这会造成对存储空
间的极大浪费。随着计算机技术的发展，文件共享的范围也在不断扩大，从单处理机系统中的
共享扩展为多处理机系统中的共享，进而又扩展为计算机网络中的共享，甚至是全世界范围内
的共享。
早在20世纪60— 70年代，就已经出现了不少实现文件共享的方法，如绕弯路法、连访法以
及利用基本文件实现文件共享的方法；而现代的一些文件共享方法，也是在早期的这些方法的
基础上发展起来的。下面仅介绍当前常用的两种文件共享方法，它们是在树形目录的基础上经
适当的修改而形成的。

--- Page 289 ---
268
计算机操作系统 （慕课版）
8.4.1　利用有向无环图实现文件共享
1．有向无环图
在8.3.4小节中介绍了无环图目录，该目录是树形目录的一个自然扩展，基于该目录可以实
现文件共享。图8-14所示的无环图目录中，文件F 8有3个父目录，分别是D5、D6、D3，其中D5和
D3还使用了相同的名字p ；目录D6有2个父目录D2和D1。当有多个用户要共享一个子目录或文件
时，必须将共享文件或子目录链接到多个用户的父目录中，这样才能方便地找到该文件。
现在的问题是，如何建立父目录 D5与共享文件F8之间的链接？如果在文件目录中所包含的
是文件的物理地址，即文件所在盘块的盘块号，则在建立链接时，必须将文件的物理地址复
制到D5目录中。但如果以后 D5或D6还要继续向该文件中添加新内容，则必然要相应地再增加
新的盘块，这将会由附加操作Append来完成。而这些新增加的盘块，也只会出现在执行了操
作的目录中。可见，这种变化对其他用户而言是不可见的，因而新增加的这部分内容已不能
被共享。
2．利用索引节点解决文件共享问题
为了解决上述问题，可以引用索引节点，即诸如文件的物理地址及其他文件属性等信息不
再放入目录项中，而是放在索引节点中。在文件目录中只设置文件名及指向相应索引节点的指
针，如图8-16所示。该方法在UNIX系统中被称为硬链接（hard link）。在图8-16中的用户Wang
和Lee的文件目录中，都设置有指向共享文件的索引节点指针。此时，由任何用户对共享文件所
进行的Append操作或修改，都将引起相应索引节点内容的改变（如增加了新的盘块号和文件长
度等），这些改变是其他用户可见的，从而也就可以将该文件提供给其他用户来共享。
Wang用户文件目录
Lee用户文件目录
索引节点
count=2
文件物理地址
Test
Test r
Test r
图 8-16　设置指向索引节点的指针
在索引节点中还应有一个链接计数count，用于表示链接到本索引节点（亦即文件）上的用
户目录项的数目。例如，count=2表示有2 个用户目录项链接到了本文件上，或者说有2 个用户共
享着此文件。
当用户C创建一个新文件时，它便是该文件的所有者，此时将count置 1。当用户B要共享此
文件时，在用户B 的目录中增加一目录项，并设置一指针指向该文件的索引节点，此时，文件
拥有者仍是C ，count=2。如果用户C 不再需要此文件，那么是否能将此文件删除呢？回答是否
定的。因为若删除了此文件，则必然会删除此文件的索引节点，这样便会使B 的指针悬空，而B
则可能正在此文件上执行写操作，此时将因此半途而废。但如果C 不删除此文件而等待B继续使

--- Page 290 ---
269
第
8章 
文件管理
用，则由于文件拥有者是C ，因此倘若系统要记账收费，则C 必须为B使用此共享文件而付账，
直至B不再需要。图8-17所示为用户B建立链接前后的情况。
C的目录
（a）建立链接前 （b）建立链接后 （c）拥有者删除文件后
C的目录B的目录 B的目录
owner=C
count=1
owner=C
count=1
owner=C
count=2
图 8-17　用户 B 建立链接前后的情况
8.4.2　利用符号链接实现文件共享
1．利用符号链接实现文件共享的基本思想
利用符号链接（symbolic link）实现文件共享的基本思想是，允许一个文件或子目录有多
个父目录，但其中仅有一个作为主（属主）父目录，其他父目录都是通过符号链接方式与之相
链接的，故将它们简称为链接父目录。图8-18与图8-14基本相同，差别仅在于将图8-14中的某些
实线改为了虚线，如在图8-14中有三条实线指向了文件F8，而在图8-18中仅有D6指向F8的一条实
线，另外两条指向F8的实线都已成为虚线。这表示F 8仍然有3个父目录，但只有D6才是其主父目
录，而D5和D3都是其链接父目录。类似地，D 6的主父目录是D2，D1是其链接父目录。这样做的
最大好处是，属主结构（用实线连接起来的结构）仍然是简单树，这对于文件的删除、查找等
操作而言都更为方便。
根
F4
F10 F11
D2
D4 D5 D6
D7 F5 F6 F7 F8
F9
D1 a z b
D3
F1 F2 F3
l
n m k
r t c n a p
h k p
e
f
b c
图 8-18　利用符号链接的目录层次

--- Page 291 ---
270
计算机操作系统 （慕课版）
2．利用符号链接实现文件共享的具体过程
为使链接父目录D 5能共享文件F ，可以由系统创建一个LINK类型的新文件，也取名为F ，
并将F 写入链接父目录D 5中，以实现D 5与文件F 8的链接。在新文件F 的内容中只包含被链接文
件F8的路径名。这样的链接方法被称为符号链接或软链接。新文件F 中的路径名被看作符号
链。当用户通过D 5访问被链接的文件F 8且正要读LINK类型的新文件时，此要求将被OS截获，
OS会根据新文件中的路径名去查询文件F 8，然后对它进行读/ 写操作，这样就实现了用户D 5对
文件F的共享。
3．利用符号链接实现文件共享的优点
在利用符号链接实现文件共享时，只是文件拥有者才拥有指向其索引节点的指针，而共享
该文件的其他用户则只有该文件的路径名，并不拥有指向其索引节点的指针。这样，也就不会
发生在文件拥有者删除一个共享文件后留下一个悬空指针的情况。当文件的拥有者把一个共享
文件删除后，如果其他用户又试图通过符号链接去访问一个已被删除的共享文件，则会因系统
找不到该文件而使访问失败，此时再将符号链接删除，则不会产生任何影响。
值得一提的是，在计算机网络中，Web浏览器所使用的文件是HTML类型的文件。在HTML
文件中有着许多链接符，通过这些链接符能够（通过计算机网络）链接到世界上任何地方的机
器中的文件。在利用符号链接实现文件共享时，同样可以通过网络来链接到分布在世界各地的
计算机系统中的文件。
4．利用符号链接实现文件共享的缺点
利用符号链接实现文件共享也存在着一些问题：当其他用户去读共享文件时，系统会根
据给定的文件路径名逐个分量（名）地去查找目录，直至找到该文件的索引节点。因此，在每
次访问共享文件时都可能要多次读盘。这使每次访问文件的开销甚大，且增加了启动磁盘的频
率。此外，要为每个共享用户建立一条符号链接，而由于链接本身实际上是一个文件（尽管该
文件非常简单），因此要为它配置一个索引节点，这也要耗费一定的磁盘空间。
需要说明的是，上述链接方式存在一个问题，即每个共享文件都有多个文件名，换言之，每
增加一条符号链接，就增加一个文件名。这在实质上就是每个用户都会使用自己的路径名去访问
共享文件。当我们试图去遍历（traverse）整个文件系统时，将会多次遍历到该共享文件。例如，
当有一个程序员要将一个目录中的所有文件都转存到磁盘上时，就可能会使一个共享文件产生多
个复制。
8.5　文件保护
在现代计算机系统中，存放了越来越多的宝贵信息供用户使用，这给用户带来了极大的好
处和方便，但同时也有着潜在的不安全性。影响文件安全性的主要因素有： ①人为因素，人们
有意或无意的行为会使文件系统中的数据遭到破坏或丢失； ②系统因素，系统的某部分出现异
常情况会造成数据的破坏或丢失，特别是作为存储数据的主要介质——磁盘，其一但出现故障将
会产生难以估量的影响；③自然因素，随着时间的推移，存放在磁盘上的数据会逐渐消失。
为了确保文件系统的安全性，可针对上述因素而采取3 个方面的措施：①通过存取控制机
制，防止人为因素导致文件不安全；②采取系统容错技术，防止系统某部分的故障导致文件不
安全；③建立后备系统，防止自然因素导致文件不安全。本节主要介绍第一方面的措施——存

--- Page 292 ---
271
第
8章 
文件管理
取控制机制，第二方面和第三方面的措施将会在第12章中进行介绍。
8.5.1　保护域
在现代OS中，几乎都配置了用于对系统中资源进行保护的保护机制，并引入了“保护域”
和“访问权”的概念，规定每一个进程仅能在保护域（protection domain）内执行操作，而且只
允许进程访问它们具有“访问权”的对象。
1．访问权
为了对系统中的对象加以保护，应由系统来控制进程对对象的访问。对象可以是硬件对
象，如磁盘驱动器、打印机等；也可以是软件对象，如文件、程序等。进程对对象所施加的
操作也有所不同，如对文件可以进行读操作，也可以进行写或执行操作。我们把一个进程
能对某对象进行操作的权力，称为访问权（access right）。每个访问权都可以用一个有序对
（对象名，权集）来表示，例如，某进程有对文件F
1进行读和写操作的权力，则可将该进程
的访问权表示成（F 1, {RW}）。
2．保护域
为了对系统中的资源进行保护，引入了保护域的概念。保护域简称为“域”，是进程对一
组对象的访问权的集合。进程只能在指定域内执行操作，这样，“域”也就规定了进程所能访
问的对象和所能执行的操作。图8-19所示为3个保护域。在域1中有两个对象，即文件F1和F2，只
允许进程对F1读，而允许其对F 2读和写；而对象Printer1同时出现在域2 和域3中，这表示在这两
个域中运行的进程，都能使用打印机。
域1
F1[R] F3[R]
F4[RWE]
F5[RW]
F6[RWE]
Ploter 2[W]
Printer 1[W]F2[RW]
域2 域3
图 8-19　3 个保护域
3．进程和域间的静态联系
进程和域之间可以一一对应，即一个进程只联系着一个域。这意味着，在进程的整个生命期
中，其可用资源是固定的，我们把这种进程联系的域称为“静态域”。在这种情况下，进程运行
的全过程都受限于同一个域，这将会使赋予进程的访问权超过实际需要。例如，某进程在运行开
始时需要用磁带机输入数据，而在进程快结束时，又需要用打印机打印数据。在一个进程只联系
着一个域的情况下，需要在该域中同时设置磁带机和打印机这两个对象，这将超过进程运行的实
际需要。
4．进程和域间的动态联系
在进程和域之间，也可以是一对多的关系，即一个进程可以联系着多个域。在此情况
下，可将进程的运行分为若干个阶段，每个阶段联系着一个域，这样便可根据运行的实际需
要来规定在运行的每个阶段中进程所能访问的对象。同样针对上面第3 部分中的例子，我们可
以把进程的运行分成3 个阶段：进程在开始运行的阶段联系着域D 1，其中包括用磁带机输入数
据；在运行快结束的第3 阶段联系着域D 3，其中包括用打印机打印数据；中间运行阶段联系

--- Page 293 ---
272
计算机操作系统 （慕课版）
着域D2，其中既不含磁带机，也不含打印机。我们把这种一对多的联系方式称为动态联系方
式，在采用这种联系方式的系统中，应增设保护域切换功能，以使进程能在不同的运行阶段
从一个保护域切换到另一个保护域。
8.5.2　访问矩阵的概念
1．基本的访问矩阵
我们可以利用一个矩阵来描述系统的访问控制，并把该矩阵称为访问矩阵（access 
matrix）。访问矩阵中的行代表域，列代表对象，矩阵中的每一项都是由一组访问权所组成的。
因为对象已由列显式地定义，故可以只写出访问权而不必写出是对哪个对象的访问权，每一项
访问权access（i, j）都定义了在域D
i中执行的进程能对对象Q j所施加的操作集。
访问矩阵中的访问权，通常是由资源的拥有者或者管理者所决定的。当用户创建一个新文
件时，创建者便是授权者，系统会在访问矩阵中为新文件增加一列，然后由用户决定在该列的
某个项中应具有哪些访问权，而在另一项中又应具有哪些访问权。当用户删除此文件时，系统
也要相应地在访问矩阵中将该文件对应的列撤销。
图8-19对应的访问矩阵如图8-20所示，它是由3个域和8个对象所组成的。当进程在域D1中运
行时，它能读文件F 1、读和写文件F 2；在域D2中运行时，它能读文件F 3、F4、F5，写文件F4、F5
以及执行文件F4，此外还可以使用打印机1；只有在域D3中运行时，才可使用绘图仪2。
域
域D1
域D2
域D3
对象 F1
R
R W
W W
R，W
R，WR，W，E
R，W，E
F2 F3 F4 F5 F6 打印机1 绘图仪2
图 8-20　访问矩阵
2．具有域切换权的访问矩阵
为了实现进程和域之间的动态联系，应能将进程从一个保护域切换到另一个保护域。为
了能对进程进行控制，同样应将切换作为一种权力，仅当进程有切换权时，才能进行切换。
为此，在访问矩阵中又增加了几个对象，分别把它们作为访问矩阵中的几个域；当且仅当
switch∈access（i, j）时，才允许进程从域i切换到域j。例如，在图8-21中，由于域D1和域D2所对
应的项目中有一个S（即switch），故而允许在域D 1中运行的进程切换到域D 2中。类似地，在域
D2和域D3所对应的项中也有一个S，这表示在域D2中运行的进程可以切换到域D3中，但不允许该
进程再从域D3返回域D1。
域
对象 打印机1 域D3域D2域D1
域D1
域D2
域D3
F1 F2 F3 F4 F5 F6 绘图仪2
R
R
R，W
R，W W
W W
S
S
R，W，E
R，W，E
图 8-21　具有切换权的访问矩阵

--- Page 294 ---
273
第
8章 
文件管理
8.5.3　访问矩阵的修改
在系统中建立起访问矩阵后，随着系统的发展及用户的增加和改变，必然要对访问矩阵进
行修改。因此，应当允许系统或用户可控性地修改访问矩阵中的内容，这可通过在访问权中增
加复制权、所有权及控制权的方法来实现。
1．复制权
我们可利用复制权（copy right）将某个域所拥有的访问权access（ i, j）扩展到同一列的其
他域中，亦即，为进程在其他域中也赋予对同一对象的访问权access（k, j），如图8-22所示。
域
域D1
F1
E
E ER’
W’
E
F2 F3
域D2
域D3
对象
域
域D1
F1
E
E ER’
R W
W’
E
F
2 F3
域D2
域D3
对象
（a）增加复制权前的访问矩阵 （b）增加复制权后的访问矩阵
图 8-22　具有复制权的访问矩阵
在图8-22中，凡是在访问权access（ i, j）上加单引号“’”者，都表示在域 i中运行的进程
能将其对对象j的访问权复制成在任何域中对同一对象的访问权。例如，在域D 2中对文件F2的读
访问权加上“’”号时，表示运行在域 D2中的进程可以将它对文件F 2的读访问权扩展到域 D3中
去。再如，在域 D1中对文件F3的写访问权加上“’”号时，表示运行在域D 1中的进程可以将它
对文件F3的写访问权扩展到域D3中去，使在域D3中运行的进程也具有对文件F3的写访问权。
应该注意的是，把带有“’”号的复制权，如R ’，由access（ i, j）复制成access（ k, j）
后，其所建立的访问权只是R 而不是R ’，这使得域D k上运行的进程不能再将其复制权进行扩
散，从而限制了访问权的进一步扩散。这种复制方式被称为限制复制。
2．所有权
人们不仅要求能将已有的访问权进行有控制的扩散，而且要求能增加某种访问权，或者
能删除某种访问权。此时，可利用所有权（owner right）来实现这些操作。如图8-23所示，如
果在access（ i, j）中包含所有访问权，则在域D i上运行的进程可以增加或删除其在 j列上任何项
中的访问权。换言之，进程可以增加或删除在任何其他域中运行的进程对对象 j的访问权。
例如，在图 8-23 （a）中，在域 D1中运行的进程（用户）是文件 F1的所有者，它能增加或删
除在其他域中运行的进程对文件F 1的访问权；类似地，在域D 2中运行的进程（用户）是文件
F2和F3的拥有者，该进程可以增加或删除在其他域中运行的进程对这两个文件的访问权。图
8-23（ b）所示为在域D 1中运行的进程删除了在域D 3中运行的进程对文件F 1的执行权；在域
D2中运行的进程增加了在域D 3中运行的进程对文件F 2和F3的写访问权。图8-23中的“O ”表
示所有权。
3．控制权
复制权和所有权都是用于改变矩阵内同一列的各项访问权的，或者说，是用于改变在不
同域中运行的进程对同一对象的访问权的。控制权（control right）则可用于改变矩阵内同一行
（域）中的各项访问权，亦即，用于改变在某个域中运行的进程对不同对象的访问权。如果在

--- Page 295 ---
274
计算机操作系统 （慕课版）
access（i, j）中包含了控制权，则在域Di中运行的进程可以删除在域Dj中运行的进程对各对象的
任何访问权。例如在图8-24中，若在access（ D2, D 3）中包括了控制权，则一个在域D 2中运行的
进程能够改变在域D3中运行的进程对各对象的访问权。通过比较图8-21和图8-24可知，在域D3中
已无对文件F6的写访问权。
域
域D1
F1 F2 F3
域D2
域D3
对象
R’，O
O，E
E
W
R’，O，W
（a）增加所有权前的访问矩阵 （b）增加所有权后的访问矩阵
域
域D1
F1 F2 F3
域D2
域D3
对象
O，R’，W’
O，E
WW
R’，O，W
图 8-23　具有所有权的访问矩阵
域
对象 打印机1 域D3域D2域D1
域D1
域D2
域D3
F1 F2 F3 F4 F5 F6 绘图仪2
R
R
R，W
R，W W
W W
ControlR，W，E
R，E
图 8-24　具有控制权的访问矩阵
8.5.4　访问矩阵的实现
访问矩阵虽然在概念上是简单的（极易理解），但在具体实现上，却有一定的困难，因为
在稍具规模的系统中，域的数量和对象的数量都可能很大，例如，在系统中有100个域，10
6
个
对象，此时在访问矩阵中便会有10
8
个表项，即使每个表项只占一个字节，此时也须占用100MB
的存储空间来保存这个访问矩阵。另外，对这个矩阵（表）进行访问，必然是十分费时的。简
言之，访问该矩阵所花费的时空开销是令人难以接受的。
事实上，每个用户（进程）所须访问的对象通常很有限，例如只有几十个，因而在这个访
问矩阵中的绝大多数项都会是空项，或者说，这是一个非常稀疏的矩阵。目前针对这一问题的
解决方法是，将访问矩阵按列或按行划分，以分别形成访问控制表或访问权限表。
1．访问控制表
对访问矩阵按列（对象）进行划分，并为每一列建立一张访问控制表。在该表中，已把
矩阵中属于该列的所有空项删除，此时的访问控制表由一有序对（域，权集）组成。由于在大
多数情况下矩阵中的空项远多于非空项，因而使用访问控制表可以显著地减少所占用的存储空
间，并能提高查找速度。在不少系统中，当对象是文件时，便把访问控制表存放在该文件的文
件控制表中，或存放在文件的索引节点中，作为该文件的存取控制信息使用。
域是一个抽象的概念，可用各种方式实现。最常见的一种情况是，每个用户是一个域，而
对象则是文件。此时，用户能够访问的文件集和访问权限取决于用户的身份。通常，在一个用
户退出而另一个用户进入（即用户发生改变）时，要进行域的切换；另一种情况是，每个进程
是一个域，此时，进程能够访问的对象集中的各访问权取决于进程的身份。
访问控制表也可用于定义默认的访问权集，即在该表中列出了各个域对某对象的默认访问

--- Page 296 ---
275
第
8章 
文件管理
权集。在系统中配置了这种表后，当某用户（进程）要访问某资源时，通常是首先由系统到默
认的访问控制表中去查找该用户（进程）是否具有对指定资源进行访问的权力，如果找不到，
则再到相应对象的访问控制表中去找。
2．访问权限表
对访问矩阵按行（即域）进行划分，并为每一行建立一张访问权限表，该表是由一个域对
每个对象可以执行的一组操作所构成的表。表中的每一项即该域对某对象的访问权限。当域为
用户（进程）、对象为文件时，访问权限表便可用于描述一个用户（进程）对每个文件所能执
行的一组操作。
表8-1所示为对应于图8-21中域D
2的访问权限表。在该表中共有3个字段，其中类型字段用于
说明对象的类型；权力字段是指域D 2对该对象所拥有的访问权限；对象字段是一个指向相应对
象的指针，对于UNIX系统而言，它就是索引节点的编号。由该表可以看出，域D 2可以访问的对
象有4个，即文件3、文件4、文件5和打印机，对文件3 的访问权限是只读，对文件4 的访问权限
是读、写和执行等。
表8 -1　访问权限表
类型 权力 对象
文件 R- - 指向文件3的指针
文件 RWE 指向文件4的指针
文件 RW- 指向文件5的指针
打印机 -W- 指向打印机1的指针
应当指出，仅当访问权限表安全时，由它所保护的对象才可能是安全的。因此，访问权限
表不能允许直接被用户（进程）访问。通常会将访问权限表存储到系统区内的一个专用区中，
只供通过访问合法性检查的程序对该表进行访问，以实现对访问控制表的保护。
目前，大多数系统都同时采用访问控制表和访问权限表，在系统中为每个对象配置一张访
问控制表。当一个进程第一次试图去访问一个对象时，必须先检查访问控制表，检查进程是否
具有对该对象的访问权。如果无权访问，则会由系统来拒绝进程的访问，并构成一个例外（异
常）事件；否则（有权访问），允许进程对该对象进行访问，并为该进程建立一个访问权限，
以将之连接到该进程。以后，该进程便可直接利用这一访问权限去访问该对象，这样，便可快
速地验证其访问的合法性。当进程不再需要对该对象进行访问时，便可撤销该访问权限。
8.6　Linux文件系统实例
Linux系统保留了UNIX标准文件系统模型。在UNIX系统中，文件不必存储在本地磁盘上，
UNIX系统可以通过网络从远程服务器上获取文件。实际上，UNIX文件可以是能够处理数据
流I/O的任何实体。例如，设备驱动程序可以被当作文件，进程间的通信信道或网络连接对用户
而言也是文件。
Linux系统内核通过在虚拟文件系统的软件层之后隐藏任何单个文件类型的实现细节，来
实现对所有类型文件的处理。下面，首先概述虚拟文件系统，然后讨论标准的Linux ext2文件
系统。

--- Page 297 ---
276
计算机操作系统 （慕课版）
8.6.1　实例 1 ： 虚拟文件系统
在Linux ext2文件系统中，提供了一个虚拟文件系统（virtual file system， VFS）。VFS隐藏
了各种硬件的具体细节，包括本地存储设备和远程网络存储设备等，并且把文件系统的相关操
作和不同文件系统的具体细节分离开，为所有的设备提供了统一的接口。 VFS使得Linux系统可
以支持多达数十种不同的文件系统。
在Linux系统中，用户程序在需要访问文件时，首先会调用文件系统提供的系统调用，如
open()、read()、write()、close()等，这些系统调用会访问VFS的数据结构，以确定要访问的文件
属于哪个文件系统；然后通过存储在VFS数据结构中的函数指针实现对该文件系统相关操作的
调用。图8-25所示为VFS文件访问过程，即在VFS中访问文件的过程。
应用程序
系统调用
通用块设备层
设备驱动程序
本地硬盘 网络存储
VFS
ext2 ext3 FAT NFS…
用户空间
硬件
内核空间
图 8-25　VFS 文件访问过程
VFS支持的4 个主要文件系统对象为超级块superblock、目录项dentry、索引节点iNode、文
件file。其中，超级块superblock是对一个文件系统的描述；索引节点iNode是对一个文件物理属
性的描述；目录项 dentry是对一个文件逻辑属性的描述；文件 file 是对当前进程打开的文件的描
述。它们具体介绍如下。
（1）超级块superblock：表示一个文件系统。它包含管理文件系统所需的信息，包括文件
系统名称（如ext2）、文件系统的大小和状态、块设备的引用和元数据信息（如空闲列表等）。
超级块通常存储在存储介质上，但是如果超级块不存在，则可以实时地创建它。
（2）索引节点iNode：文件系统处理文件所需要的所有信息都保存在索引节点中。iNode代
表的是物理意义上的文件，记录的是文件物理上的属性，如索引节点编号、文件大小、访问权
限、修改日期、数据位置等。索引节点和文件一一对应，它跟文件内容一样，都会被持久化地
存储到磁盘中。
（3）目录项dentry：每个文件除了需要有一个结构体（struct iNode）外，还需要有一个目
录项，用于描述文件逻辑上的属性，其没有对应的磁盘数据结构。目录项是由内核维护的一个
内存数据结构，根据字符串形式的路径名现场创建而成，记录文件名、索引节点指针以及与其
他目录项的关联关系。多个关联的目录项即会构成文件系统的目录结构。

--- Page 298 ---
277
第
8章 
文件管理
（4）文件file：存放打开的文件与进程之间进行交互的相关信息。
8.6.2　实例 2 ： Linux ext2 文件系统
Linux 系统最早采用的文件系统是 MINIX，该文件系统由 MINIX系统定义，有一定的局限
性，如文件名最长为 14个字符，文件最大为 64MB。第一个专门为Linux系统而设计的文件系
统是扩展文件系统（ extended file system ），通常亦称ext文件系统。该文件系统发展至今衍生
出了许多新版本，其中第二版（即ext2文件系统）的设计最为成功，目前流传最广的是ext4文
件系统。
ext2文件系统功能强大、易扩充，是所有Linux系统所安装的标准文件系统模型。ext2文件
系统将自身所占用的逻辑分区划分成块组（block group），每个块组的结构如图8-26所示。
引导块
超级块
组描述符
块位图
索引节点位图
索引节点表
数据块
块组0
块组1
块组n
…
图 8-26　ext2 文件系统逻辑分区块组结构示意
通常，一个文件在磁盘中除了存储文件实际内容外，还需要存储很多属性，如文件的权限
与文件属性（如所有者、群组、时间参数等）。文件系统通常会将这两部分数据放在不同的块
组，权限和属性放在索引节点中，至于实际的数据则放在数据块中。另外，还有一个超级块会
记录文件系统的整体信息，包括索引节点与数据块的总量、使用量、剩余量等。
在文件系统的整体规划中，文件系统最前面有一个启动扇区（boot sector），这个启动扇区
可以安装引导装载程序，这样就能够将不同的引导装载程序安装到个别的文件系统最前端，而
不用覆盖整块硬盘唯一的主引导记录（master boot record，MBR）扇区，进而即可制作出多重引
导环境。
同时，为了方便管理，ext2文件系统在格式化的时候基本上被区分为多个块组，每个块组
都有独立的iNode/block/superblock系统，该系统包括6 个组成部分：超级块、组描述符、块位
图、索引节点位图、索引节点表、数据块。
（1）超级块（superblock）：记录整个文件系统的信息。
（2）组描述符（group description）：即描述每个组块的开始与结束时的数据块号码。
（3）块位图 （block bitmap）：即数据块位示图，用一个二进制位来表示数据块是否空
闲。通过块位图可以知道并快速找到空的数据块，进而进行文件的添加操作。
（4）索引节点位图（iNode bitmap）：类似数据块位示图，用一个二进制位来表示索引节
点是否被使用。通过索引节点位图可以快速找到未被使用的索引节点编号。
（5）索引节点表（iNode table）：每个索引节点的固定大小为128B，每个文件仅占用一个
索引节点，文件系统能够创建的文件数量与索引节点的数量有关。系统读取文件时需要先找到
索引节点，并分析索引节点所记录的权限与用户权限是否符合，若符合，才能开始实际读取数
据块的内容。
（6）数据块 （data block）：ext2文件系统中支持的数据块的大小有1KB、 2KB、 4KB三
种，每个数据块中只能放一个文件的数据，而不能将多个文件的数据放在一个数据块中，如果
文件的数据大于数据块的大小，则该文件将会占用多个数据块，但是一般只有一个索引节点。
在分配文件时，ext2文件系统首先会为这个文件选择块组。对于数据块，它会试图分配文

--- Page 299 ---
278
计算机操作系统 （慕课版）
件到与文件索引节点相同的块组。对于索引节点，它会选择文件的父目录驻留在非目录文件中
的块组。目录文件并不会被放在一起，而是会被分散到整个可用块组。这些策略的应用，不仅
可以实现在同一块组中保存相关信息，而且可以将磁盘负荷分散到盘块组中，以减少任何区域
的磁盘碎片。
8.7　本章小结
本章主要介绍了文件和文件系统的基本概念、文件逻辑结构的类型、文件目录、文件的共
享与保护等内容。
文件是由OS定义和实现的抽象数据类型。它是逻辑记录的一个序列，而逻辑记录可以是字
节、记录或更为复杂的数据项。
文件的逻辑结构是指从用户角度所看到的文件组织形式，分为有结构文件和无结构文件两
种。有结构文件可分为顺序文件、索引文件和索引顺序文件；无结构文件又称为流式文件。
文件目录是用来管理文件的数据结构，可分为单级文件目录、两级文件目录、树形目录、
无环图目录等。
为了防止浪费存储空间，系统提供文件共享功能显得尤为必要。文件的共享取决于系统
所提供的语义，可以在单处理机系统、多处理机系统甚至计算机网络中进行文件共享。因为文
件是大多数计算机存储信息的主要机制，其如果处于不安全状态，则可能会产生难以估量的影
响，所以需要进行文件保护。文件保护可以通过存取控制机制或其他技术来实现。
习题8（含考研真题）
一、简答题
1．何谓数据项、记录和文件？
2．一个比较完善的文件系统应具备哪些功能？
3．为什么在大多数OS中都引入了“打开”这一文件系统调用？打开的含义是什么？
4．什么是文件的逻辑结构？逻辑文件有哪几种组织形式？
5．如何提高变长记录顺序文件的检索速度？
6．什么叫“按名存取”？文件系统如何实现文件的按名存取？
7．UNIX系统把文件描述信息从文件目录项中分离出来的原因是什么？
8．目前广泛采用的目录结构是哪种？它有什么优点？
9．试说明在树形目录中线性检索法的检索过程，并画出相应的流程图。
10．在树形目录中，利用链接方式共享文件有何好处？
11．什么是保护域？进程与保护域之间存在着怎样的动态联系？
12．什么是访问控制表和访问权限表？系统如何利用它们来实现对文件的保护？
二、计算题
13．一个文件系统中，FCB占64B，一个盘块大小为1KB，采用单级文件目录，假如文件目
录中有3 200个目录项，则检索一个文件平均需要访问磁盘大约多少次？

--- Page 300 ---
279
第
8章 
文件管理
14．在某个文件系统中，每个盘块占512B， FCB占64B，其中文件名占8B。如果索引节点
编号占2B，则针对一个存放在磁盘上的、具有256个目录项的目录，请分别计算引入索引节点前
后，为找到某个文件的FCB而平均启动磁盘的次数。
15．（考研真题）设文件F 1的当前引用计数值为1 ，先建立F 1的符号链接（软链接）文件
F2，再建立F1的硬链接文件F3，然后删除F1。此时，F2和F3的引用计数值分别是多少？
16．（考研真题）索引顺序文件可能是最常见的一种逻辑文件组织形式，其不仅有效克服
了变长记录文件不便于直接存取的缺点，且付出的额外存储开销也不算大，对于包含40 000条记
录的主数据文件，为了能检索到指定关键字的记录，采用索引顺序文件组织方式，平均检索效
率可提高到顺序文件组织方式的多少倍（假定主数据文件和索引表均采用顺序查找法）？
17．（考研真题）某文件系统的目录由文件名和索引节点编号构成。若每个目录项的长度
均为64B，其中4B存放索引节点编号，60B存放文件名。文件名由小写英文字母构成，则该文件
系统能创建的文件数量上限为多少？
三、综合应用题
18．针对图8-27所示的文件系统目录结构，若C和D分别是两个用户的目录，则请问：
（1）C用户在当前目录“/C”下欲共享文件f2，应具备什么条件?
（2）若C用户需要经常访问文件，则其应如何操作才会更简单、更快捷?
（3）若D用户不愿意别人访问其文件f3，则其应如何操作?
19．有一共享文件，它具有下列文件名: /usr/Wang/test/report、 /usr/Zhang/report、  /usr/Lee/
report，试填写图8-28中的A、B、C、D、E。
A
E F G
I
J K
B
C
D
H
根目录
f1 f3f2
f4
      
A
B
Wang
Zhang
C
E
D
                                    图 8-27　文件系统目录结构                                       图 8-28　文件共享示意
20．（考研真题）假设某系统的目录管理采用了索引节点方式。如果用户需要打开文件/
usr/student/myproc.c，则请简要阐述目录检索的大致过程（假设根目录内容已经读入内存且该文
件存在）。

--- Page 301 ---

第9章
磁盘存储器不仅容量大、存取速度快，而且可以实现随机存取，是当前实现虚拟存储
器和文件存放最理想的外存，因此在现代计算机系统中都无一例外地配置了磁盘存储器。
磁盘存储器管理的目的和要求如下。 ①有效利用存储空间：采取合理的文件分配方式，为
文件分配必要的存储空间，使每个文件都能“各得其所”，并能有效地减少磁盘碎片，
改善存储空间的利用率。 ②提高磁盘的I/O速度： 通过各种途径（包括采用磁盘高速缓存
等）来提高磁盘的I/O速度，以提高系统对文件的访问速度，从而改善文件系统的性能。  
③提高磁盘系统的可靠性：采取多种技术，包括必要的冗余措施和后备系统，来提高磁盘
系统的可靠性。本章知识导图如图9-1所示。
磁盘存储器管理
外存的组织方式
文件存储空间的管理
提高磁盘I/O速度的途径
提高磁盘可靠性的技术
存储新技术
数据一致性控制
后备系统
连续组织方式
链接组织方式
索引组织方式
隐式链接组织方式
显示链接组织方式
FAT文件系统
磁盘高速缓存
其他方法
廉价磁盘冗余阵列
空闲区表法
空闲链表法
位示图法
成组链接法
第一级容错技术
第二级容错技术
基于集群系统的
容错技术
图9-1　第9章知识导图
磁盘存储器管理
第9 章导读


--- Page 302 ---
281
第
9章 
磁盘存储器管理
9.1　外存的组织方式
如第8章所述，文件的物理结构直接与外存的组织方式有关。不同的外存组织方式，将形成
不同的文件物理结构。目前常用的外存组织方式有3种。
（1）连续组织方式：在对外存采取连续组织方式时，须为每个文件分配一个连续的磁盘空
间，由此所形成的文件物理结构是顺序式文件结构。
（2）链接组织方式：在对外存采取链接组织方式时，可以为每个文件分配不连续的磁盘空
间；通过链接指针可以将一个文件的所有盘块链接在一起，由此所形成的文件物理结构是链接
式文件结构。
（3）索引组织方式：在对外存采取索引组织方式时，所形成的文件物理结构是索引式文件
结构。
在传统的文件系统中，通常仅采用上述组织方式中的一种来组织外存。在现代OS中，由
于存在多种类型（特别是实时类型）的多媒体文件，因此，对外存可能会采取多种类型的组
织方式。
9.1.1　连续组织方式
1．连续组织方式简介
连续组织方式又称为连续分配方式，要求为每个文件分配一组相邻的盘
块。例如，第一个盘块的地址为b，第二个盘块的地址为b+1，第三个盘块的地
址为b+2，……。通常，它们都位于一条磁道上，在进行读/ 写操作时不必移动
磁头。在采用连续组织方式时，可把逻辑文件中的记录顺序地存储到邻接的各个物理盘块中，
这样所形成的文件结构称为顺序式文件结构，此时的物理文件称为顺序文件。
连续组织方式保证了逻辑文件中的记录顺序与存储器中文件占用盘块顺序的一致性。为使
系统能找到文件存放的地址，应在目录项的“文件物理地址”字段中记录该文件第一个记录所
在的盘块号和文件长度（以盘块为单位）。图 9-2所示为磁盘空间的连续组织方式，图中假定了
记录与盘块的大小相同，count文件的第一个盘块号为0 ，文件长度为2，因此会在盘块号为0和1
的两个盘块中存放count文件的数据。
如同内存的动态分区分配一样，随着文件建立时空间的分配和文件删除时空间的回收，
磁盘空间将被分割成许多小块，这些小块已难以用来存储文件，此即外部碎片。同样，我们
也可以利用紧凑的方法使盘上所有的文件紧靠在一起，将所有的碎片拼接成一大片连续的存储
空间。但是，将外存空闲空间进行一次紧凑所花费的时间远比将内存进行一次紧凑所花费的时  
间多。
2．连续组织方式的主要优点
（1）顺序访问容易。访问顺序文件非常容易，系统可从目录中找到该顺序文件所在的第
一个盘块号，从此开始逐个盘块地往下读/ 写即可。连续组织方式也支持对定长记录的文件进
行随机存取。
（2）顺序访问速度快。采取连续组织方式所装入的文件，其所占用的盘块可能位于一条或
几条相邻的磁道上，磁头的移动距离最少，因此，连续组织方式下访问文件的速度是几种外存
连续组织方式


--- Page 303 ---
282
计算机操作系统 （慕课版）
组织方式中最快的一种。
count
list
mail
目录
file
count
tr
mail
list
f
0
14
19
28
6
2
3
3
3
2
start
length
0
4
8
12
16
20
24
28
1
5
9
13
17
21
25
29
2
6
10
tr
f
14
18
22
26
30
3
7
11
15
19
23
27
31
图 9-2　磁盘空间的连续组织方式
3．连续组织方式的主要缺点
（1）要求为一个文件分配连续的存储空间。由内存的连续组织方式得知，为一个文件分配
连续的存储空间会产生许多外部碎片，严重降低了外存空间的利用率。如果定期利用紧凑方法
来消除外部碎片，则又会花费大量的机器时间。
（2）必须事先知道文件的长度。要将一个文件装入一个连续的存储区中，必须事先知道文
件的大小。获知文件的大小有时只能靠估算，如果估算的文件大小比实际的小，则会因存储空
间不足而终止文件的复制，并要求用户重新估算后再次复制。这会促使用户将文件长度估算得
比实际的大，进而就会造成浪费。
（3）不能灵活地删除和插入记录。为保持文件的有序性，在删除和插入记录时，不仅需要
对相邻的记录做物理上的移动，还需要动态地改变文件的大小。
（4）对于动态增长的文件，采用连续组织方式可能会覆盖物理上相邻的后续文件，因此无法满
足文件动态增长的要求。另外，由于事先很难知道文件的最终大小，因此很难为其分配空间；即使事
先知道文件的最终大小，在采用预分配存储空间这一方法时，也会使大量的存储空间长期空闲。
9.1.2　链接组织方式
如果可以将文件装到多个离散的盘块中，则可消除连续组织方式的上述
缺点。在采用链接组织方式时，可为文件分配多个不连续的盘块，再通过每个
盘块上的链接指针，将同属于一个文件的多个离散的盘块链接成一个链表，由
此所形成的物理文件称为链接文件。链接组织方式的主要优点是：①消除了外
部碎片，提高了外存的利用率；②非常容易插入、删除和修改记录；③能适应
文件的动态增长，而无须事先知道文件的大小。链接组织方式可分为隐式链接组织方式和显式
链接组织方式两种。
1．隐式链接组织方式
在采用隐式链接组织方式时，在文件目录的每个目录项中，都须含有指向链接文件第一个
链接组织方式


--- Page 304 ---
283
第
9章 
磁盘存储器管理
盘块和最后一个盘块的指针。图 9-3所示为磁盘空间的链接组织方式，其中所展示的链接文件占
用了5个盘块。在相应的目录项中，指示了其第一个盘块号是9 ，最后一个盘块号是25。而每个
盘块中都含有一个指向下一个盘块的指针，如在第一个盘块9 中设置了第二个盘块的盘块号16；
在第二个盘块16中又设置了第三个盘块的盘块号1 。如果指针占用4B，则对于盘块大小为512B
的磁盘，每个盘块中只有508B可供用户使用。
目录
file
jeep
9
25
start
end
count
list
mail
0
4
8
12
16
1
20
24
28
1
10
16
-1
25
5
9
13
17
21
25
29
2
6
10
tr
f
14
18
22
26
30
3
7
11
15
19
23
27
31
图 9-3　磁盘空间的链接组织方式
隐式链接组织方式的主要问题在于，它只适用于顺序访问，而对随机访问是极其低效的。
如果要访问文件所在的第i个盘块，则必须先读出文件的第1个盘块，以此类推进行顺序查找，直
至找到第i个盘块。当i=100时，须启动100次磁盘去实现读盘块操作，平均每次都要花费几十毫
秒。可见，随机访问的速度很低。此外，只通过链接指针将一大批离散的盘块链接起来，其可
靠性较差，因为其中的任何一个指针出现问题都会导致整个链断开。
为了提高检索速度和减小指针所占用的存储空间，可以将几个盘块一起组成一个簇。例
如，一个簇可包含4 个盘块，在进行盘块分配时是以簇为单位进行的，链接文件中的每个元素
也是以簇为单位的。这样将会大幅减少查找指定块的时间，而且也可减小指针所占用的存储空
间；但是增大了内部碎片，同时这种改进的效果也是非常有限的。
2．显式链接组织方式
显式链接组织方式是指把用于链接文件各物理盘块的指针，显式地存放在内存的一张链接
表中。该表在整个磁盘中仅设置一张，如图9-4所示。表的序号是物理盘块号，从0 开始，直至
N-1，N为盘块总数。在每个表项中存放指向下一个盘块的链接。在该表中，凡是属于某一文件
的第一个盘块号，或者说是每一条链的链首指
针所对应的盘块号，均作为文件地址被填入相
应文件的FCB的“物理地址”字段中。由于查
找记录的过程是在内存中进行的，因而链接表
不仅显著地提高了检索速度，而且大大减少了
访问磁盘的次数。由于分配给文件的所有盘块
链接指针都存放在该表中，因此把该表称为文
件分配表（file allocation table，FAT）。
FCB目录
物理盘块号
2
FAT
0
1
2
3
4
0
4
5
15
图 9-4　链接表结构示意

--- Page 305 ---
284
计算机操作系统 （慕课版）
3．FAT 文件系统
微软公司早、中期推出的OS一直都是采用的FAT技术，即利用FAT来记录每个文件中所有盘
块之间的链接。在MS-DOS系统中，最早使用的是12 位的FAT12，后来使用的是16位的FAT16。
在Windows 95和 Windows 98系统中则升级为32位的FAT32。 Windows NT/2000/XP以及之后的
Windows系统将FAT32进一步发展为NTFS。
在FAT中引入了“卷”（volume）的概念后，其便支持将一个物理磁盘分成四个逻辑磁
盘，每个逻辑磁盘就是一个卷（也称为分区），换言之，每个卷都是一个能够被单独格式化和
使用的逻辑单元，供文件系统分配空间时使用。一个卷中包含文件系统信息、一组文件以及空
闲空间。每个卷都专门划出一个单独区域来存放自己的目录、FAT以及逻辑驱动器字母。针对仅
有一个硬盘的计算机，通常最多可将其硬盘分为“C：”“D：”“E：”“F：”四个卷。需要
说明的是，在现代OS中，一个物理磁盘可以被划分为多个卷，一个卷也可以由多个物理磁盘组
成。下面具体介绍FAT文件系统。
（1）以盘块为单位的FAT文件系统。
早期的 FAT12以盘块为基本分配单位。由于FAT 是文件系统中最重要的数据结构，为了
安全起见，在每个分区中都配有两张相同的文件分配表，即FAT1 和FAT2。在FAT的每个表
项中均存放下一个盘块号，它实际上是用于盘块之间进行链接的指针，通过它可以将一个文
件的所有盘块链接起来；另外，FAT 会将文件的第一个盘块号放在自己的FCB中。图9-5所示
为MS-DOS系统的文件物理结构，图中给出了两个文件，其中文件A 占用三个盘块，盘块号
依次为4 、6、11；文件B 也占用三个盘块，盘块号依次为9 、10、 5。每个文件的第一个盘块
号均放在自己的FCB中。对于1.2MB的软盘，每个盘块的大小为512B，在每个FAT 中共含有
2.4K（ 1.2MB÷ 512B）个表项；由于每个FAT 表项占12bit（即1.5B），因此FAT 表占用3.6KB
（2.4K×1.5B）存储空间。
FCB 0
1
2
3
4
5
6
6
11
10
5
EOF
EOF
7
8
9
4
FCB
FAT
9
10
11
图 9-5　MS-DOS 系统的文件物理结构
接下来计算以盘块为分配单位时所允许的最大磁盘容量。由于每个FAT 表项为12bit，因
此，在FAT中最多允许有4 096 （2
12
）个表项。如果以盘块为基本分配单位，每个盘块（也称扇
区）的大小一般是512B，那么每个磁盘分区的容量就是2MB （4 096× 512B），一个物理磁盘
能支持4个逻辑磁盘分区，因此相应的磁盘最大容量仅为8MB （2MB×4）。FAT12可以应付最
早时期的容量未超过8MB的磁盘，但很快磁盘的容量就超过了8MB，此时，FAT12是否还可继
续使用呢？回答虽然是肯定的，但需要引入一个新的分配单位——簇（cluster）。

--- Page 306 ---
285
第
9章 
磁盘存储器管理
（2）以簇为单位的FAT文件系统。
稍加分析便可得知，如果把每个盘块（扇区）的容量均增大 n倍，则磁盘的最大容量便可
增加n倍。但要增加盘块的容量是不方便和不灵活的。为此，引入了簇的概念。簇是一组相邻
的扇区，其在FAT中被视作一个虚拟扇区。在进行盘块分配时，以簇为基本分配单位。簇的大
小一般是2
n
（n为整数）个盘块。在实际运用中，簇的容量可以是一个盘块（512B）、两个盘块
（1KB）、四个盘块（2KB）、八个盘块（4KB）等，FAT16支持多达64个盘块。一个簇应包含
扇区的数量与磁盘容量的大小直接相关。例如，在FAT12中，当一个簇仅有一个扇区时，磁盘的
最大容量为8MB；当一个簇包含八个扇区时，磁盘的最大容量便可达到64MB。而在FAT16中，
由于FAT表项的位数为 16，因此最大表项数为 65 536 （ 2
16
），此时便能将一个磁盘分区分为  
65 536 （2
16
）个簇；如果每个簇中最多有64个盘块，那么可以得出FAT16可以管理的最大分区
空间为2 048MB （512B×65 536×64）。
以簇为基本分配单位的好处是，可使系统能够适应磁盘容量不断增大的情况，还可以减少
FAT中的项数（在相同的磁盘容量下，FAT的项数与簇的大小成反比），使FAT占用更少的存储
空间，并且可以减少访问FAT的开销。但也会造成更大的簇内碎片（它与存储器管理中的页内零
头相似），即簇的容量越大，簇内碎片也越大。例如，在 FAT16中，当要求磁盘分区的大小为
8GB时，每个簇的大小可达128KB，这意味着内部碎片最大可达（128K-1）B。一般而言，对于
容量为1GB～4GB的硬盘来说，其会导致浪费10% ～20%的存储空间。为了解决这一问题，微软
公司推出了FAT32。
FAT32是FAT系列文件系统的最后一个产品。FAT32的每个簇在FAT中的表项均占据4B，其
允许管理比FAT16更多的簇，允许采用较小的簇。FAT32在分区大小为2GB～8GB时，簇的大小
为4KB；分区大小为8GB ～16GB时，簇的大小为8KB；分区大小为16GB ～32GB时，簇的大小
则达到了16KB。当每个簇为4KB时，FAT32分区格式理论上可以管理的单个最大磁盘空间可达
4KB×2
32
=16TB。但是，由于引导扇区只使用4B来记录磁盘的扇区总数，即最多只支持4G个扇区
（2
32
），每个扇区512B，因此支持的磁盘容量最大值为（2
32
）×512B=2TB。另外，由于FAT32表
项的32位中的高4位不用，因此表项数最多为2
28
个，在簇的大小为4KB时，支持的最大分区大小为
2
28
×4KB=1TB。三种FAT文件系统中簇的大小与最大分区的对应关系如表9-1所示。
表9 -1　三种 FAT 文件系统中簇的大小与最大分区的对应关系
簇的大小
最大分区
FAT12 FAT16 FAT32
0.5KB 2MB — —
1KB 4MB — —
2KB 8MB 128MB —
4KB 16MB 256MB 1TB
8KB — 512MB 2TB
16KB — 1 024MB 2TB
32KB — 2 048MB 2TB
FAT32支持更小的簇，这使其具有更高的存储器利用率。例如，两个磁盘的容量都为2GB，
一个磁盘采用了FAT16，簇的大小为32KB；另一个磁盘采用了FAT32，簇的大小为4KB，则在通
常情况下，FAT32的存储器利用率相比FAT16可以提高15%。FAT32主要应用于Windows 98以及
后续的Windows系统，同时支持长文件名，能够有效地节省硬盘空间。

--- Page 307 ---
286
计算机操作系统 （慕课版）
但是，FAT32亦存在明显的不足之处。首先，由于文件分配表的扩大，其运行速度比FAT16
要慢；其次，FAT32有最小管理空间的限制，FAT32卷必须至少包含 65 537个簇，因此FAT32不
支持容量小于512MB的分区，对于小分区，仍然需要使用FAT16或 FAT12；再次，FAT32的单个
文件的长度不能大于4GB；最后，FAT32有兼容性方面的限制（最大限制），即FAT32不能保证
向下兼容。因此，微软公司又引入了NTFS。
9.1.3　索引组织方式
1．单级索引组织方式
链接组织方式虽然解决了连续组织方式所存在的问题，但又出现了另外
两个问题：①不能支持高效的直接存取，若想对一个较大的文件进行存取，则
须在FAT中顺序查找许多盘块号；②FAT须占用较大的内存空间，由于一个文件所占用盘块的盘
块号随机分布在FAT中，因此只有将整个FAT调入内存，才可保证在FAT中能够找到一个文件的
所有盘块号。当磁盘容量较大时，FAT可能要占用数MB甚至更多的内存空间。
事实上，在打开某个文件时，只须把该文件占用的盘块的编号调入内存即可，完全没有必
要将整个FAT调入内存。为此，应将每个文件所对应的盘块号集中地放在一起，在访问到某个文
件时，将该文件所对应的盘块号一起调入内存即可。索引组织方式就是基于这一思想所形成的
一种外存组织方式。它为每个文件分配一个索引块（表），把分配给该文件的所有盘块号都记
录在该索引块中。在建立一个文件时，只须在为之建立的目录项中填上指向该索引块的指针即
可。图9-6所示为磁盘空间的索引组织方式。
目录
索引块号
file
jeep
19
0
4
8
12
16
20
24
28
1
5
9
13
17
21
25
29
2
6
10
14
18
22
26
30
3
7
11
15
1919
23
27
31
9
16
1
10
25
-1
-1
-1
图 9-6　磁盘空间的索引组织方式
索引组织方式的主要优点是支持直接访问。当要读文件的第 i个盘块时，可以方便地直接从
该文件的索引块中找到第 i个盘块的盘块号；此外，索引组织方式也不会产生外部碎片。当文件
较大时，索引组织方式无疑要优于链接组织方式。
索引组织方式的主要问题是，每当建立一个索引文件时，都须为该文件分配一个索引块，
并将分配给该文件的所有盘块号记录于其中。在每个索引块中可存放数百个盘块号。但对于
中、小型文件，其本身通常只占数十个到数个盘块，甚至更少，此时该方式仍会为之分配一个
索引组织方式


--- Page 308 ---
287
第
9章 
磁盘存储器管理
索引块。可见，针对中、小型文件，当采用索引组织方式时，索引块的利用率将会很低。
2．多级索引组织方式
在为一个大文件分配磁盘空间时，如果所分配出去的盘块的盘块号已装满一个索引块，则OS
须再为该文件分配另一个索引块，用于将以后继续为之分配的盘块的盘块号记录于其中。依此类
推，再通过链指针将各索引块按序链接起来。显然，当文件太大而索引块太多时，这种方法是低
效的。此时，应为这些索引块再建立一级索引，称之为第二级索引，即系统再分配一个索引块，
作为第一级索引的索引块，将第一块、第二块等索引块的盘块号填入该索引块中，这样便形成了
两级索引组织方式。如果文件非常大，则还可以采用三级、四级甚至更多级的索引组织方式。
图9-7所示为两级索引组织方式下各索引块之间的链接情况。如果每个盘块的大小为1KB，
每个盘块号占4B，则在一个索引块中可存放256个盘块号。这样，在两级索引时，最多可包含的
存放文件的盘块的盘块号总数N=256×256=64K。由此可以得出结论：采用两级索引时，所允许
的文件最大长度为64MB。倘若盘块的大小为4KB，则在采用单级索引时所允许的最大文件长度
为4MB，而在采用两级索引时所允许的最大文件长度可达4GB。
主索引
360
105
106
254
740
356
357
1 125
985
磁盘空间
第二级索引
0
1
2
105
106
254
356
357
985
360
740
1 125
…
…
…
…
…
…
…
…
图 9-7　两级索引组织方式
多级索引的主要优点是大大加快了系统对大型文件的查找速度。其主要缺点是，系统在
访问一个盘块时，所须启动磁盘的次数会随着索引级数的增加而增多，即使对于小文件也是如
此。实际情况通常是以中、小文件居多，而大文件较少。因此，如果在文件系统中仅采用多级
索引组织方式，则并不能获得理想的效果。
3．增量式索引组织方式
（1）增量式索引组织方式的基本思想。
为了能较全面地照顾到小、中、大及特大型作业，可以采取多种组织方式来构成文件的物

--- Page 309 ---
288
计算机操作系统 （慕课版）
理结构。如果盘块的大小为1KB或 4KB，则对于小文件（如大小为1KB ～10KB或4KB～40KB）
而言，它最多只会占用10个盘块，为了能提高对数量众多的小型作业的访问速度，最好能将它们
的每个盘块地址都直接放入FCB（或索引节点）中，这样就可以直接从索引节点中获得该文件的
盘块地址。一般把这种寻址方式称为“直接寻址”。对于中型文件（如大小为11KB ～256KB或
5KB～4MB），可以采用单级索引组织方式，此时为了获得该文件的盘块地址，只须从索引节点
中找到该文件的索引表，即可从中获得该文件的盘块地址，可将该地址称为“一次间址”。对于
大型和特大型文件，可以采用两级和三级索引组织方式，此时可将所获得的文件的盘块地址称为
“二次间址”和“三次间址”。所谓增量式索引组织方式，就是基于上述思想来组织外存，它既
采用了直接寻址方式，又采用了单级和多级索引组织方式（间接寻址方式）。通常又可将这种组
织方式称为混合索引组织方式，在UNIX系统中所采用的就是这种组织方式。
（2）UNIX System V的组织方式。
在UNIX System V的索引节点中，设有13个地址项，即i.addr(0)～i.addr(12)，如图9-8所示。
mode
owners（2）
time stamps（3）
size
block count
single indirect
double indirect
triple indirect
i.addr（0）
i.addr（1）
direct blocks
…
…
…
… …
data
data
data
data
data
data
data
data
data
data
图 9-8　混合索引组织方式
上述13个地址项的具体介绍如下。
① 直接地址。为了提高进程对文件的检索速度，在索引节点中可设置10个直接地址项，即
用i.addr(0) ～i.addr(9)来存放直接地址。换言之，在这10个直接地址项中所存放的都是该文件数
据所在盘块的盘块号或盘块地址。假如每个盘块的大小为 4KB，当文件不大于40KB时，便可直
接从索引节点中读出该文件的全部盘块号。
② 一次间接地址。对于大、中型文件，只采用直接地址是不现实的。为此，可再利用索引
节点中的地址项i.addr(10)来提供一次间接地址。这种方式的实质就是一级索引组织方式。图9-8
中的一次间接地址块也就是索引块，系统将分配给文件的多个盘块号记入其中。在一次间接地
址块中可存放1K个盘块号，因而允许文件长达4MB。
③ 多次间接地址 。当文件长度大于4MB+40KB时，使用一次间接地址与10个直接地址项
仍不足，系统还须采用二次间接地址，即用地址项i.addr(11)提供二次间接地址。该方式的实质
是两级索引组织方式。系统此时是在二次间接地址块中记入所有一次间接地址块的盘块号。在
采用两级索引组织方式时，文件的最大长度可达4GB。同理，地址项i.addr(12)作为三次间接地

--- Page 310 ---
289
第
9章 
磁盘存储器管理
址，其所允许的文件最大长度可达4TB。
假设有一个含有 100 万条记录的文本文件，每条记录均包括 ： 姓名（长度为 2～64 个汉字，
平均长度为 4 个汉字） 、年龄、性别、家庭地址和身份证号码。对该文件的操作主要是根据姓
名进行记录查询，请思考为该文件设计哪种组织方式可使其具有访问效率高和所需存储空间少
的优点。
思考题
9.2　文件存储空间的管理
为了实现9.1节中所提的任何一种外存组织方式，都需要为文件分配盘块，
因此必须知道磁盘上哪些盘块是可用于分配的。在为文件分配盘块时，除了需
要文件分配表外，系统还应为可分配存储空间设置相应的数据结构，即设置一
个磁盘分配表（disk allocation table），用于记住可供分配的存储空间情况。此
外，还应提供对盘块进行分配和回收的手段。不论哪种分配和回收方式，存储
空间的基本分配单位都是盘块而非字节。下面介绍几种常用的文件存储空间管理方法。
9.2.1　空闲区表法和空闲链表法
1．空闲区表法
（1）空闲区表。空闲区表法属于连续组织方式，它与内存的动态分配方式类似，会为每个
文件分配一块连续的存储空间。此外，系统也会为外存上的所有空闲区建立一张空闲表，每个
空闲区对应一个空闲表项，其中包括表项序号、该空闲区的第一空闲盘块号、该空闲区的空闲
盘块数等信息。将所有空闲区按它们的起始盘块号递增的次序排列，即可形成空闲盘块表，如
表9-2所示。
表9 -2　空闲盘块表
序号 第一空闲盘块号 空闲盘块数
1 2 4
2 9 3
3 15 5
… … …
（2）存储空间的分配与回收。空闲区的分配与内存分区的动态分配方式类似，同样是采用
首次适应算法和最佳适应算法等，它们对存储空间的利用率大体相当，都优于最坏适应算法。
在系统为某新创建的文件分配空闲盘块时，先顺序地检索空闲表的各表项，直至找到第一个大
小能满足要求的空闲区，然后将该空闲区分配给用户（进程），同时修改空闲盘块表。系统在
对用户所释放的存储空间进行回收时，也采取了类似于内存回收的方法，即要考虑回收区是否
与空闲盘块表中插入点的前区和后区相邻接，对相邻接者应予以合并。
需要说明的是，在内存分配上，虽然较少采用连续组织方式，但在外存的管理中，由于这
种组织方式具有较高的分配速度，可减少访问磁盘的 I/O频率，因此其在诸多组织方式中仍占有
一席之地。例如，在前面所介绍的对换方式中，对换空间一般都采用连续组织方式。对于文件
空闲空间管理


--- Page 311 ---
290
计算机操作系统 （慕课版）
系统，当文件较小（占1 ～4个盘块）时，仍采用连续组织方式为文件分配相邻接的几个盘块；
当文件较大时，便采用离散组织方式。另外，对于多媒体文件，为了能减少磁头的寻道时间，
也应采用连续组织方式。
2．空闲链表法
空闲链表法是将所有空闲盘区拉成一条空闲链。根据构成空闲链所用的基本元素的不同，
可把链表分成两种形式：空闲盘块链和空闲盘区链。
（1）空闲盘块链。这是将磁盘上的所有空闲空间以盘块为单位拉成一条链，其中的每个盘
块都有指向后继盘块的指针。当用户因创建文件而请求分配存储空间时，系统便从链首开始，
依次摘下适当数目的空闲盘块分配给用户。当用户因删除文件而释放存储空间时，系统便将回
收的盘块依次挂在空闲盘块链的末尾。这种方法的优点是用于分配和回收一个盘块的过程非常
简单；但在为一个文件分配盘块时，可能要重复操作多次，分配和回收的效率较低。此外，因
为它是以盘块为单位的，所以相应的空闲盘块链会很长。
（2）空闲盘区链 。这是将磁盘上的所有空闲盘区（每个盘区可包含若干个盘块）拉成一
条链。在每个盘区上除了含有用于指示下一个空闲盘区的指针外，还应含有能指明本盘区大小
（所含盘块数）的信息。分配盘区的方法与内存分区的动态分配方法类似，通常采用首次适应
算法。在回收盘区时，同样也要将回收区与相邻接的空闲盘区合并。在采用首次适应算法时，
为了提高对空闲盘区的检索速度，可以采用显式链接组织方式，即在内存中为空闲盘区建立一
张链表。这种方法的优缺点刚好与空闲链表法的优缺点相反，即分配与回收的过程比较复杂，
但分配与回收的效率较高，每次会为文件分配多个连续的盘块，且空闲盘区链较短。
9.2.2　位示图法
1．位示图
位示图是指利用二进制的一位来表示磁盘中一个盘块的使用情况。当其值为“0 ”时，表
示对应的盘块空闲；当其值为“1 ”时，表示对应的盘块已被分配。有的系统把“0 ”作为盘块
已被分配的标志，把“1”作为盘块空闲的标志。它们在本质上是相同的，都是用一位的两种状
态来标志空闲和已被分配这两种情况。磁盘上的所有盘块都有一个二进制位与之对应，这样，
由所有盘块所对应的位构成的一个集合，称为位示图。通常可用 m×n个位来构成位示图，并使
m×n等于磁盘的总块数，如图 9-9所示；此时，磁盘的总块数=16× 16=256。位示图也可被描述
为一个二维数组map[i, j]。
1
1
1
0
0
0
1
1
1
0
0
1
0
0
1
1
0
1
1
1
0
0
0
1
1
1
1
1
1
0
0
0
0
0
0
0
1
1
1
1
1
1
0
0
0
0
1
1
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
1
2
3
…
16
图 9-9　位示图
2．盘块的分配 
根据位示图分配盘块时，可分3步进行。

--- Page 312 ---
291
第
9章 
磁盘存储器管理
（1）顺序扫描位示图，从中找出一个或一组值为“0”的二进制位（“0”表示空闲）。
（2）将所找到的一个或一组二进制位转换成与之相对应的盘块号。假定找到值为“0 ”的
二进制位处在位示图的第i行、第j列，则其对应的盘块号应按下式进行计算：
b=n×(i-1)+j，
式中，n表示每行的位数。
（3）修改位示图，令map[i, j]=1。
3．盘块的回收
盘块的回收可分两步进行。
（1）将回收盘块的盘块号转换成位示图中的行号和列号，转换公式为：
i=(b-1) DIV n+1，
j=(b-1) MOD n+1。
（2）修改位示图，令map[i, j]=0。
位示图法的主要优点是，从位示图中很容易找到一个或一组相邻接的空闲盘块。例如，当
需要找到6个相邻接的空闲盘块时，只须在位示图中找出值连续为“ 0”的6个位即可。此外，由
于位示图很小，占用空间少，因此可将它保存在内存中，这使得在每次进行盘块分配时无须首
先把空闲盘块表读入内存，从而节省了许多磁盘启动操作。因此，位示图常用于微机和小型计
算机（如CP/M、Apple-DOS等）中。
请思考应该如何将盘块号转换为磁盘的三维地址（柱面号 C，磁头号 H，扇区号 S） 。
思考题
9.2.3　成组链接法
空闲区表法和空闲链表法都不适用于大型文件系统，因为此类系统会使空闲区表或空闲链
表太长。在UNIX系统中采用的是成组链接法，这是将上述两种方法相结合而形成的一种空闲盘
块管理方法，它兼备上述两种方法的优点而克服了两种方法均有的“表太长”这一缺点。
1．空闲盘块的组织
（1）空闲盘块号栈，用于存放当前可用的一组空闲盘块的盘块号（最多含100个盘块
号），以及栈中尚有的空闲盘块（号）数 N。顺便指出，N还兼作栈顶指针用。例如，当 N=100
时，它指向S.free(99)。由于栈是临界资源，每次只允许一个进程去访问，故系统为栈设置了
一把锁。图 9-10 左部所示即空闲盘块号栈的结构，其中， S.free(0) 是栈底，栈满时的栈顶为
S.free(99)。
（2）文件区中的所有空闲盘块被分成若干个组，例如，将每100个盘块作为一组。假定盘
上共有10 000个盘块，每块大小为1KB，其中第201 ～7 999号盘块用于存放文件，即作为文件
区，这样，该区的最末一组盘块号为7 901 ～7 999；次末组盘块号为7 801 ～7 900，……第二组
盘块号为301～400；第一组盘块号为201～300，如图9-10右部所示。
（3）将每组含有的盘块总数 N和该组所有的盘块号记入其前一组的第一个盘块中。这样，
由各组的第一个盘块可链接成一条链。
（4）将第一组的盘块总数和所有的盘块号记入空闲盘块号栈中，作为当前可供分配的空闲
盘块号。

--- Page 313 ---
292
计算机操作系统 （慕课版）
空闲盘
块号栈
S.free
100
100
100
99
0
7 999
7 900
7 901
400
399
301
300
400
7 899
7 999
399
299
100
300
299
202
201
…
…
…
…
…
…
…
…
0
98
99
201
301
7 801
7 901
1
图 9-10　成组链接法
（5）最末一组只有99个盘块，其盘块号分别记入其前一组的S.free(1) ～S.free(99)中，而在
S.free(0)中则存放“0 ”，作为空闲盘块链的结束标志。注意：最后一组的盘块数应是99，不是
100，这是指可供使用的空闲盘块，编号为1～99，0号盘块中放空闲盘块链的结尾标志。
2．空闲盘块的分配与回收
当系统要为用户分配文件所需的盘块时，须调用盘块分配过程来完成。该过程首先会检查
空闲盘块号栈是否上锁，若未上锁，则从栈顶取出一空闲盘块号，并将与之对应的盘块分配给
用户。其次，将栈顶指针下移一格。若该盘块号已是栈底，即S.free(0)，这是当前栈中最后一个
可分配的盘块号，则由于在该盘块号所对应的盘块中记有下一组可用的盘块号，因此须调用磁
盘读过程，将栈底盘块号所对应盘块的内容读入栈中，作为新的盘块号栈的内容，并把原栈底
对应的盘块分配出去（其中有用的数据已读入栈中）。再次，分配一个相应的缓冲区，作为该
盘块的缓冲区。最后，把栈中的空闲盘块数减1并返回。
在系统回收空闲盘块时，须调用盘块回收过程。它是将回收盘块的盘块号记入空闲盘块号
栈的顶部，并执行空闲盘块数加1 操作。当栈中的空闲盘块号数目已达100时，表示栈已满，将
现有栈中的100个空闲盘块号记入新回收的盘块中，并将新回收盘块号作为新栈底。
9.3　提高磁盘I/O速度的途径
文件系统的性能可表现在多个方面，其中至关重要的一个方面是对文件的访问速度。为
了提高对文件的访问速度，可从3 方面着手：①改进文件的目录结构以及检索目录的方法，以
减少对目录的查找时间；②选取好的文件存储结构，以提高对文件的访问速度；③提高磁盘
I/O速度，以实现将文件中的数据快速地从磁盘传送到内存中，或者反向传送。其中，第一方
面和第二方面的内容已在第8 章和9.1节中做了详细阐述，本节将主要介绍如何提高磁盘I/O  
速度。
目前，磁盘的I/O速度远低于对内存的访问速度，通常要低上 4～6个数量级，这可谓已成为
计算机系统的瓶颈。因此，人们千方百计地提高磁盘 I/O速度，所采用的最主要的技术便是磁盘
高速缓存（disk cache）。

--- Page 314 ---
293
第
9章 
磁盘存储器管理
9.3.1　磁盘高速缓存
在7.7.5小节中介绍的高速缓存，是指在内存和CPU之间所增设的一个小容量高速存储器，
而在这里所要介绍的磁盘高速缓存，是指在内存中为磁盘盘块所设置的一个缓冲区，在该缓冲
区中保存了某些盘块的副本。当出现一个磁盘访问请求时，由内核先去查看所请求的盘块内容
是否已在磁盘高速缓存中，如果在，则可从磁盘高速缓存中直接获取，这样就省去了启动磁盘
的操作，而且可使本次访问速度提高几个数量级；如果不在，则需要启动磁盘以将所需要的盘
块内容读入，并把读入的盘块内容送到磁盘高速缓存中，以便于以后又需要访问该盘块的内容
时直接从磁盘高速缓存中获取。在设计磁盘高速缓存时需要考虑的问题有：①如何将磁盘高速
缓存中的数据传送给请求进程；②应该采用何种置换算法；③已修改的盘块数据应在何时写回
磁盘高速缓存。下面将对上述问题逐一进行解答。
1．数据交付方式
如果I/O请求所需要的数据能从磁盘高速缓存中获取，则此时需要将磁盘高速缓存中的数据
传送给请求进程。所谓的数据交付（data delivery），是指将磁盘高速缓存中的数据传送给请求
进程。系统可以采取两种方式将数据交付给请求进程： ①数据交付，即直接将磁盘高速缓存中
的数据传送到请求进程的内存工作区中； ②指针交付，即只将指向磁盘高速缓存中某区域的指
针交付给请求进程。后一种方式由于所传送的数据量少，因而节省了数据从磁盘高速缓存传递
到进程的内存工作区的时间。
2．置换算法
如同请求调页（段）一样，在将磁盘中的盘块数据读入磁盘高速缓存时，同样会出现因磁
盘高速缓存中已装满盘块数据而需要将其中某些盘块的数据先换出的问题。相应地，也存在采
用哪种置换算法的问题。较常用的算法仍是LRU置换算法、Clock置换算法以及最少使用置换算
法等。由于请求调页中的联想存储器与磁盘高速缓存（磁盘 I/O中）的工作情况不同，它们在置
换算法中所应考虑的问题也有所差异。因此，现在不少系统在设计其磁盘高速缓存的置换算法
时，除了考虑最近最久未使用这一原则外，还会考虑以下几点。
（1）访问频率。通常，每执行一条指令便可能访问一次联想存储器，即对联想存储器的访
问频率基本上与指令执行的频率相当；而对磁盘高速缓存的访问频率则与磁盘 I/O的频率相当。
因此，对联想存储器的访问频率远远高于对磁盘高速缓存的访问频率。
（2）可预见性 。在磁盘高速缓存中的各盘块数据中，哪些数据可能在较长时间内都不会
被再次访问，哪些数据可能很快就会被再次访问，这些信息中会有相当一部分是可预知的。例
如，对于二次间址及目录块等，当它们被访问过一次后，可能很久都不会再被访问。再如，正
在写入数据的未满盘块，可能很快又会被访问。
（3）数据的一致性。由于磁盘高速缓存在内存中，而内存又是一种易失性存储器，一旦系
统发生故障，存放在磁盘高速缓存中的数据就会丢失；而其中有些盘块（如索引节点盘块）中
的数据已被修改但尚未拷回磁盘。因此，系统发生故障可能会造成数据不一致。
基于上述考虑，在有的系统中便将磁盘高速缓存中的所有盘块数据拉成了一条LRU链。
对于那些会严重影响数据一致性的盘块数据和很久都可能不再使用的盘块数据，将它们都放
在LRU链的头部，使它们能被优先写回磁盘，以减少发生数据不一致情况的概率，同时可以尽
早地腾出磁盘高速缓存的空间。对于那些可能在不久之后便要再使用的盘块数据，将它们挂在

--- Page 315 ---
294
计算机操作系统 （慕课版）
LRU链的尾部，以便在以后需要时，只要该盘块中的数据尚未被写回磁盘，便可直接从LRU链
中找到它们。
3．周期性地写回磁盘
还有一种情况值得注意，即根据 LRU置换算法，那些经常要被访问的盘块数据可能会一直
保留在磁盘高速缓存中，长期不会被写回磁盘。这是因为LRU链中的任一元素在被访问之后，
都会被挂到链的尾部而不被写回磁盘，只有一直未被访问的元素才有可能移到链的头部而被写
回磁盘。为了解决这一问题，在 UNIX系统中专门增设了一个修改（ update）程序在后台运行。
该程序会周期性地调用一个SYNC，其主要功能是强制性地将所有在磁盘高速缓存中已修改的盘
块数据写回磁盘。一般会把两次调用SYNC的时间间隔定为30s，这样，系统故障所造成的工作
损失就不会超过30s的工作量。
9.3.2　提高磁盘 I/O 速度的其他方法
除了磁盘高速缓存外，可以有效提高磁盘I/O速度的方法还有很多，如提前读、延迟写、优
化物理块的分布、虚拟盘等。下面将对这些方法进行具体介绍。
1．提前读
如果采用顺序访问方式对文件进行访问，则可以预知下一次要读的盘块。此时可采取预先
读的方式，即在读当前块的同时要求将下一个盘块（提前读的盘块）中的数据也读入缓冲区。
这样，当下一次要读该盘块中的数据时，由于其已被提前读入缓冲区，因而此时可直接从缓冲
区中取得下一个盘块的数据，而无须再去启动磁盘 I/O，从而大大减少了读数据的时间，有效地
提高了磁盘I/O的速度。“提前读”这一方法已被广泛采用。
2．延迟写
延迟写是指缓冲区A 中的数据本应立即写回磁盘，但考虑到该缓冲区中的数据可能会在不
久之后再次被本进程或其他进程访问（共享资源），因而并不会立即将该缓冲区A中的数据写回
磁盘，而是会将它挂在空闲缓冲区队列的末尾。随着空闲缓冲区的使用，缓冲区也会缓缓往前
移动，直至移到空闲缓冲队列之首。当再有进程申请到该缓冲区时，就将该缓冲区中的数据写
回磁盘，同时把该缓冲区作为空闲缓冲区分配出去。只要该缓冲区仍在队列中，任何访问该缓
冲区中的数据的进程就都可以直接读出其中的数据而不必访问磁盘。这样，又可进一步减少磁
盘的I/O时间。同样，“延迟写”这一方法也已被广泛采用。
3．优化物理块的分布
在采用链接组织方式和索引组织方式时，可以将一个文件分散存储在磁盘的任意位置，但如果
过于分散，则会增加磁头的移动距离。例如，将文件的第一个盘块安排在最里边的一条磁道上，而
把第二个盘块安排在最外边的一条磁道上，这样，在读完第一个盘块后转去读第二个盘块时，磁头
要从最里边的磁道移到最外边的磁道上。如果我们将这两个数据块安排在属于同一条磁道的两个盘
块上，则显然会由于消除了磁头在磁道间的移动而大大提高对这两个盘块的访问速度。
对文件盘块位置的优化应在为文件分配盘块时进行。如果系统中的空闲存储空间采用位
示图进行表示，则要想将同属于一个文件的盘块安排在同一条磁道上或相邻的磁道上是十分
容易的事。此时，只要从位示图中找到一片相邻接的多个空闲盘块即可。但当系统采用线性表

--- Page 316 ---
295
第
9章 
磁盘存储器管理
（链）法来组织空闲存储空间时，要为一个文件分配多个相邻接的盘块就要困难一些。此时可
以将在同一条磁道上的若干个盘块组成一簇（如一簇包括4 个盘块），在分配存储空间时以簇为
单位进行分配。这样就可以保证在访问这几个盘块时，不必移动磁头或者仅移动一条磁道的距
离即可，从而减少了磁头的平均移动距离。
4．虚拟盘
由于访问内存的速度远高于访问磁盘的速度，于是有人试图利用内存空间去仿真磁盘，进而
形成所谓的虚拟盘，又称为RAM盘。该盘的设备驱动程序可以接受所有标准的磁盘操作，但这些
操作的执行不是在磁盘上而是在内存中进行。它们对用户而言都是透明的。换言之，用户不会发
现这与真正的磁盘操作有何不同，仅是略微快了些而已。虚拟盘存在的主要问题是：它是易失性
存储器，一旦系统或电源发生故障，或系统重启，原来保存在虚拟盘中的数据就会丢失。因此，
虚拟盘通常用于存放临时文件，如编译程序所产生的目标程序等。虚拟盘与磁盘高速缓存的主要
区别在于：虚拟盘中的内容完全由用户控制，而磁盘高速缓存中的内容则是由OS控制的。例如，
虚拟盘在开始时是空的，仅当用户（程序）在其中创建了文件后，其中才会有内容。
9.3.3　廉价磁盘冗余阵列
当今存在着一种非常有用的设计思想：如果仅使用一个组件对系统性能进行改进会受到很大
的限制，那么可通过使用多个相同的组件来获得系统性能的大幅度提升，这种情况在计算机领域
已屡见不鲜。正是在这种设计思想的推动下，单处理机系统演变成了多处理机系统，芯片上的单
核演变成了多核；同样，用这种设计思想来指导磁盘存储器的设计，于1987年开发出了由多个小
磁盘组成的一个容量很大的廉价磁盘冗余阵列（redundant array of inexpensive disk，RAID）。
RAID利用一台磁盘阵列控制器来统一管理和控制一组（几台到几十台）磁盘驱动器，进而
组成一个大型磁盘系统。RAID不仅大幅度增加了磁盘的容量，而且极大地提高了磁盘的I/O速度
和整个磁盘系统的可靠性。因此，RAID一经推出便被许多大型系统所采用。
1．并行交叉存取
把在大、中型计算机中用于提高访问内存速度的并行交叉存取技术应用到磁盘存储系统
中，可以提高磁盘的I/O速度。在这样的系统中，有多台磁盘驱动器，系统将每一盘块中的数据
分为若干个子盘块数据，再把每一子盘块的数据分别存储到不同磁盘中的相同位置上。以后，
当要将一个盘块的数据传送到内存时，采取并行传输方式，将各个盘块中的子盘块数据同时向
内存中传输，从而使传输时间大大减少。例如，在存放一个文件时，可将该文件中的第一个数
据子块放在第一个磁盘上，将第二个数据子块放在第二个磁盘上……将第 N个数据子块放在第N
个磁盘上。以后在读取数据时，采取并行交叉存取方式可同时从第1 ～N个磁盘中读出数据，这
样便把磁盘的I/O速度提高了N-1倍。图9-11所示为磁盘并行交叉存取方式示意。
1
2
3
4
图 9-11　磁盘并行交叉存取方式示意

--- Page 317 ---
296
计算机操作系统 （慕课版）
2．RAID 的分级
RAID在刚被推出时分为6级，即RAID 0级、RAID 1级、RAID 2级、RAID 3级、RAID 4级
和RAID 5级。后来，又增加了RAID 6级和RAID 7级。
（1）RAID 0级 。该级仅提供并行交叉存取功能。RAID 0级的主要优点是能够实现高效传
输，并能实现高速I/O请求；主要缺点是无冗余校验功能，致使磁盘系统的可靠性并不是很高。
只要阵列中有一个磁盘损坏，便会造成不可弥补的数据丢失。因此，该级较少使用。
（2）RAID 1级。该级具有磁盘镜像功能，例如，当磁盘阵列中具有8个盘时，可将其中的
4个作为数据盘，另外4个作为镜像盘，在每次访问磁盘时，可利用并行读/ 写特性将数据分块同
时写入数据盘和镜像盘。RAID 1级的主要优点是可靠性好，且从故障中恢复很简单；主要缺点
是磁盘容量的利用率只有50%。RAID 1级的优点是以牺牲磁盘容量为代价而获得的。
（3）RAID 2级 。该级也称为内存方式的差错纠正组织。内存系统长期以来实现了基于奇
偶位的错误检测，内存中的每个字节都是一个关联的奇偶位，以记录字节中为1 的个数是偶数还
是奇数。如果字节的某一个位发生了损坏（或是1 变成0，或是0变成1），则字节的奇偶校验位
就会改变，这会使其与所存储的奇偶校验位不再匹配。类似地，如果存储的奇偶校验位损坏，
则它就会与计算的奇偶校验位不再匹配。因此，单个位的差错可被内存系统检测出来。
（4）RAID 3级。该级所对应的RAID是具有并行传输功能的磁盘阵列。它只利用一个奇偶
校验盘来实现数据的校验功能。例如，当阵列中只有 7个盘时，可将6个盘作为数据盘，剩余的1
个盘作为校验盘。磁盘的利用率为6/7 （约85.7%）。
（5）RAID 4级 。该级与块交错奇偶校验结构均采用块级分条，这与RAID 0级一样；此
外，该级会在一个单独的磁盘上保存其他 N个磁盘的块的奇偶校验块。如果有一个磁盘出现故
障，则可以通过奇偶校验块和其他磁盘的相应块恢复故障磁盘的块。
（6）RAID 5级。该级所对应的RAID是具有独立传送功能的磁盘阵列。每个驱动器都有各
自独立的数据通路，独立地进行读/ 写，且无专门的校验盘。用来进行纠错的校验信息是以螺旋
（spiral）方式散布在所有数据盘上的。
（7）RAID 6级和RAID 7级 。这两级是强化后的RAID。在RAID 6级的磁盘阵列中，设置
了一个专用的、可快速访问的异步校验盘，该盘具有独立的数据通路，具有比RAID 3级与RAID 
5级更好的性能，但其性能改进得很有限且代价较大。RAID 7级是对RAID 6级的改进，在该级
的磁盘阵列中，所有磁盘都具有较高的传输速率和优异的性能。 RAID 7 级是目前最高档次的磁
盘阵列，但其价格较高。
3．RAID 的优点
RAID具有下述一系列明显的优点。 ①可靠性高，除了RAID 0级外，其余各级都采用了容
错技术。当阵列中某一磁盘损坏时，并不会造成数据的丢失；此时可根据其他未损坏磁盘中的
数据来恢复已损坏磁盘中的数据。因此，其可靠性比单个磁盘高出一个数量级。 ②磁盘I/O速
度快，由于采取了并行交叉存取方式，磁盘I/O速度提高了 N-1倍。③性价比（性能/价格）高，
RAID的体积与具有相同容量和速度的大型磁盘系统相比，只是后者的1/3 ，价格也只是后者的
1/3，且可靠性高。换言之，它仅以牺牲1/N的容量为代价换取了高可靠性。
9.4　提高磁盘可靠性的技术
在第8章中已经介绍了影响文件安全性的主要因素有人为因素、系统因素和自然因素三

--- Page 318 ---
297
第
9章 
磁盘存储器管理
类，同时也说明了为确保文件系统的安全性，应采取三方面的措施。采用存取控制机制来防
止人为因素造成的文件不安全，已在8.5节中进行了详细阐述。本节主要介绍通过系统容错
技术来防止因系统因素造成的文件不安全，以及通过建立“后备系统”来防止因自然因素造
成的文件不安全。
容错技术是通过在系统中设置冗余部件来提高系统可靠性的一种技术。磁盘容错技术则是
通过增加冗余的磁盘驱动器、磁盘控制器等方法来提高磁盘系统可靠性的一种技术，即当磁盘
系统的某部分出现缺陷或故障时，磁盘仍能正常工作，且不致造成数据的丢失或错误。目前广
泛采用磁盘容错技术来改善磁盘系统的可靠性。
磁盘容错技术可分成三个级别：第一级容错技术是指低级磁盘容错技术；第二级容错技术
是指中级磁盘容错技术；第三级容错技术是指基于集群系统的容错技术，该技术也被人们称为
系统容错（system fault tolerant，SFT）技术。
9.4.1　第一级容错技术
第一级容错技术（ SFT -Ⅰ）是最基本的一种磁盘容错技术，主要用于防止因磁盘表面缺陷
所造成的数据丢失。它包含双份目录、双份FAT、热修复重定向以及写后读校验等措施。
1．双份目录和双份 FAT
在磁盘上存放的文件目录和FAT ，是管理文件时所用的重要数据结构。为了防止这些表格
被破坏，可以在不同的磁盘上或磁盘的不同区域中分别建立（双份）文件目录和FAT，其中一份
为主文件目录及主FAT，另一份为备份文件目录及备份FAT。一旦由于磁盘表面缺陷而造成主文
件目录或主FAT损坏，系统便会自动启用备份文件目录或备份 FAT，从而可以保证磁盘上的数据
仍可访问。
2．热修复重定向和写后读校验
由于磁盘价格昂贵，当磁盘表面有少量缺陷时，可在采取某种补救措施后继续使用。
一般主要可以采取以下两种补救措施。①热修复重定向：系统将磁盘容量的很小一部分（如
2%～3%）作为热修复重定向区，用于存放发现磁盘有缺陷时的待写数据，并对写入该区的所有
数据进行登记，以便今后对这些数据进行快速访问。②写后读校验：为保证写入磁盘的所有数
据都能写到完好的盘块中，应该在每次向磁盘中写入一个数据块后立即将它读出来，并送至另
一缓冲区中，再将该缓冲区的内容与内存缓冲区中写后仍保留的数据进行比较，若两者一致，
则认为此次写入成功；否则重写。若重写后两者仍不一致，则认为该盘块有缺陷，此时便将应
写入该盘块的数据写入热修复重定向区。
9.4.2　第二级容错技术
第二级容错技术（ SFT -Ⅱ）主要用于防止系统因磁盘驱动器和磁盘控制器故障而无法正常
工作这一情况的发生。此级容错技术具体可分为磁盘镜像和磁盘双工。
1．磁盘镜像
为了避免因磁盘驱动器发生故障而丢失数据，系统增设了磁盘镜像（disk mirroring）功
能。为了实现该功能，须在同一磁盘控制器下增设一个完全相同的磁盘驱动器，如图9-12所
示。当采用磁盘镜像方式时，在每次向主磁盘写入数据后，都需要将数据再写到备份磁盘上，

--- Page 319 ---
298
计算机操作系统 （慕课版）
以使两个磁盘上具有完全相同的位像图。把备份磁盘看作主磁盘的一面镜子。当主磁盘驱动器
发生故障时，由于有备份磁盘的存在，在进行切换后，主机仍能正常工作。磁盘镜像虽然实现
了容错功能，却使磁盘的利用率降至原来的50%，也未能使服务器的磁盘I/O速度得到提高。
主 机通道 磁盘
控制器 磁盘驱动器
图 9-12　磁盘镜像示意
2．磁盘双工
如果控制上述两台磁盘驱动器的磁盘控制器发生故障，或主机到磁盘控制器之间的通道发
生故障，则磁盘镜像功能就起不到保护数据的作用了。因此，在第二级容错技术中又增加了磁
盘双工（disk duplexing）功能，即将两台磁盘驱动器分别接到两个磁盘控制器上，同样使这两
个磁盘控制器镜像成对，如图9-13所示。
主 机
通道
通道
磁盘
控制器
磁盘
控制器
磁盘驱动器
图 9-13　磁盘双工示意
在磁盘双工时，文件服务器同时将数据写到两个处于不同控制器下的磁盘上，使两者有
完全相同的位像图。如果某个通道或磁盘控制器发生故障，则由于另一通道上的磁盘仍能正常
工作，因此不会造成数据丢失。在磁盘双工时，由于每个磁盘都有自己独立的通道，故可同时
（并行地）将数据写入磁盘，或从磁盘中读出数据。
9.4.3　基于集群系统的容错技术
在进入20世纪90年代后，为了进一步增强服务器的可用性，采用了多台对称多处理机服务
器来实现集群系统服务器的功能。所谓集群，是指由一组互连的自主计算机组成统一的计算机
系统，给人们的感觉是，它们是一台机器。利用集群系统不仅可提高系统的并行处理能力，还
可提高系统的可用性。它们是当前使用最广泛的一类具有容错功能的集群系统，主要工作模式
有3种：双机热备份模式、双机互为备份模式、公用磁盘模式。下面具体介绍如何在这3 种模式
下利用集群系统来提高服务器的可用性。
1．双机热备份模式
如图9-14所示，在具有双机热备份模式的系统中，备有两台服务器，两者的处理能力通常
是完全相同的，一台作为主服务器，另一台作为备份服务器。平时，主服务器运行，备份服务
器则时刻监视着主服务器的运行情况，一旦主服务器出现故障，备份服务器便立即接替主服务
器的工作而成为系统中新的主服务器；修复后的原来的主服务器此时会被作为备份服务器。

--- Page 320 ---
299
第
9章 
磁盘存储器管理
主服务器
传输介质
MSL
备份服务器
图 9-14　双机热备份系统示意
为使这两台服务器之间能保持镜像关系，应在这两台服务器上各装入一块网卡，并通过一
条镜像服务器链路（mirrored server link ，MSL）将两台服务器连接起来。两台服务器之间保持
一定的距离，其所允许的最长距离取决于所配置的网卡和传输介质。如果配置了采用光纤分布
式数据接口（fiber distributed data interface， FDDI）协议传输数字信号的单模光纤（简称FDDI
单模光纤），则两台服务器间的距离可达20km。此外，还必须在系统中设置某种机制以检测主
服务器中数据的改变。一旦该机制检测到主服务器中有数据变化，便立即通过通信系统将修改
后的数据传送到备份服务器的相应数据文件中。为了保证在两台服务器之间通信的高速性和安
全性，通常会选用高速通信信道并设置备份线路。
在双机热备份模式下，一旦主服务器发生故障，系统能自动将主要业务的用户切换到备份
服务器上。为保证切换时间足够快（通常为数分钟），要求在系统中配置用于切换硬件的开关
设备，在备份服务器上事先建立好通信配置，并使其能迅速处理客户机的重新登录等事宜。
双机热备份模式是早期使用的一种集群技术，它的最大优点是提高了系统的可用性，易于
实现，而且主服务器与备份服务器完全独立，可支持远程热备份，从而能消除由于火灾、爆炸
等非计算机因素所造成的隐患。其主要缺点是备份服务器处于被动等待状态，整个系统的使用
效率只有50%。
2．双机互为备份模式
在双机互为备份模式中，两台服务器在平时均为在线服务器（如一台作为数据库服务器，
另一台作为电子邮件服务器），它们各自完成自己的任务。为了实现两者互为备份的功能，应
通过某种专线将两台服务器连接起来。如果希望两台服务器之间能相距较远，则最好利用 FDDI
单模光纤来连接两台服务器，在此情况下，最好再通过路由器将两台服务器连接起来作为备份
通信线路。图9-15所示为双机互为备份系统示意。
具有两块
硬盘
数据库
服务器
路由器
交换集线器
电子邮件
服务器
单模光纤
X.25
具有两块
硬盘
图 9-15　双机互为备份系统示意

--- Page 321 ---
300
计算机操作系统 （慕课版）
在双机互为备份模式中，最好在每台服务器内都配置两块硬盘，一块用于装载系统程序/ 应
用程序，另一块用于接收由另一台服务器发来的备份数据，即作为另一台服务器的镜像盘。在
正常运行时，镜像盘对本地用户是锁死的，这样就较易于保证镜像盘中数据的正确性。如果仅
有一块硬盘，则可通过建立虚拟盘的方式或分区方式，分别存放系统程序/ 应用程序以及另一台
服务器发来的备份数据。
当通过专线链接检查到某台服务器发生故障后，再通过路由器去验证这台服务器是否真的
发生了故障。如果故障被证实，则由正常服务器向故障服务器的客户机发出广播信息，表明要
进行切换。在切换成功后，客户机无须重新登录便可继续使用网络提供的服务并访问服务器上
的数据。对于连接在非故障服务器上的客户机，此时它们只会感到网络服务速度稍有减慢，而
不会有其他的感觉。当故障服务器修复并重新联网后，已被迁移到无故障服务器上的服务功能
将返回到修复后的服务器上。
双机互为备份模式的优点是两台服务器都可用于处理任务，因而系统效率较高。现在已将
这种模式从两台服务器增加到4 台、8台、16台甚至更多。系统中的所有服务器都可用于处理任
务，而当其中一台发生故障时，系统可指定另一台服务器来接替它的工作。
3．公用磁盘模式
为了减少信息复制的开销，可以将多台计算机连接到一个公用磁盘上。该公用磁盘被划分
为若干个卷，每台计算机使用一个卷。如果某台计算机发生故障，则系统将重新进行配置，即
根据某种调度策略来选择另一台机器进行替代，后者对发生故障的机器的卷拥有所有权，从而
可接替故障计算机来承担其任务。这种模式的优点是消除了信息的复制时间，从而减少了网络
和服务器的开销。
9.4.4　后备系统
在一个完整的系统中必须配置后备系统，这一方面是因为磁盘系统不够大，不可能将系统
在运行过程中产生的所有数据都装在磁盘中，应当把暂时不需要但仍然有用的数据存放在后备
系统中并保存起来；另一方面是为了防止系统发生故障或被计算机病毒感染，进而将系统中的
数据弄错或丢失，同时也可以将比较重要的数据存放在后备系统中。目前常用作后备系统的设
备（后备设备）有磁带机、硬盘和光盘驱动器等。
1．磁带机
磁带机是最早作为计算机系统外部存储器的设备，但由于它只适合存储顺序文件，故现在主
要把它作为后备设备。磁带机的主要优点是容量大（一般可达数GB至数十GB），价格便宜，故
在许多大、中型系统中都配置了磁带机。其缺点是只能顺序存取且速度比较慢（一般为数百KB每
秒到数MB每秒），因此将一个大容量磁盘上的数据复制到磁带机上需要花费很多时间。
2．硬盘
（1）移动磁盘。小型系统和个人计算机常将移动磁盘作为后备系统，其最大的优点是速度
快，脱机保存方便，且保存时间较长，可比磁带机长出3 ～5年，但单位容量的费用较高。近年
来，移动磁盘的价格已明显下降，且体积也非常小，应用也日益广泛。
（2）固定硬盘驱动器。在大、中型系统中可使用大容量硬盘兼作后备系统，为此需要在一
个系统中配置两个大容量硬盘。每个硬盘都被划分为两个分区：一个为数据区，另一个为备份

--- Page 322 ---
301
第
9章 
磁盘存储器管理
区，如图9-16所示。可在每天晚上将硬盘0中的“数据0”复制到硬盘1中的复制区中进行保存；同
样也将硬盘1中的“数据1”复制到硬盘0中的复制区中进行保存。这种后备系统，不仅复制速度非
常快，而且还具有容错功能，即当其中任何一个硬盘驱动器发生故障时，都不会引起系统瘫痪。
硬盘0
数据1
的复制区
数据0 数据1
数据0
的复制区
硬盘1
CPU
图 9-16　使用大容量硬盘兼作后备系统
3．光盘驱动器
光盘驱动器是现在最流行的多媒体设备，其可分为如下两类。
（1）只读光盘驱动器，如CD-ROM和DVD-ROM，这两种驱动器主要用于播放音频和视频
文件。由于它们都只能播放（读）而不能刻录（写），故难以用作后备设备。
（2）可读写光盘驱动器 ，又称为刻录机。它们既能播放（读）又能刻录（写），故可用
作后备设备，存储计算机中的数字信息。目前有3 类刻录机：①CD -RW刻录机，能播放和刻录
CD、VCD等；②COMBO刻录机，能播放数字视频光盘（digital video disc， DVD），但只能刻
录CD、VCD等；③DVD刻录机，能播放和刻录CD、VCD和DVD等。
9.5　存储新技术
纵观数据存储技术的发展，从20世纪50年代发明硬盘、使用直连式存储开始，到20世纪
70—80年代发明网络附加存储、存储区域网络，再到 2006年发明对象存储，可见，数据存储领
域正发生着剧烈变化，而且这种变化具有长期发展下去的趋势。
9.5.1　传统存储系统
传统存储系统的3种主要架构分别是直连式存储、网络附加存储和存储区域网络。
1．直连式存储
直连式存储（direct attached storage， DAS），顾名思义，是一种通过总线适配器直接将硬
盘等存储介质连接到主机上的存储方式，也称为主机连接存储，在存储设备和主机之间通常没
有任何网络设备的参与。可以说DAS是最原始、最基本的存储架构，在个人计算机、服务器上
最为常见。DAS设备与服务器主机之间的连接通道使用了多种技术，典型的台式计算机采用I/O
总线架构，如IDE（ATA）、SATA、SCSI等。高端工作站和服务器通常采用更复杂的I/O总线架
构，如光纤通道（fiber channel ，FC）等。DAS设备主要是硬盘驱动器、RAID、CD、DVD、磁
带驱动器、磁盘簇（just a bunch of disks，JBOD）等。DAS的优点是架构简单、成本低廉、读写
效率高等；缺点是容量有限、难以共享，因此容易形成“信息孤岛”。

--- Page 323 ---
302
计算机操作系统 （慕课版）
2．网络附加存储
网络附加存储（network attached storage，NAS）是一种提供文件级别访问接口的网络存储系
统架构，通常采用NFS、SMB/CIFS等网络文件共享协议进行文件存取。它可以直接连接在计算机
网络（如以太网等）上，对不同类型OS的使用者提供集中式资料存取服务。NAS支持多客户端同
时访问，为服务器提供了大容量的集中式存储，从而方便了服务器间的数据共享。使用者可以通
过某种方式（如Linux系统中的mount命令）将存储服务挂载到本地进行访问，在本地呈现的就是
一个文件目录树。NAS的缺点是：由于存储数据通过普通数据网络进行传输，会消耗数据网络的
带宽，从而会加重网络通信的延迟，这对于大型客户机-服务器环境可能影响较大。
3．存储区域网络
存储区域网络（storage area network， SAN）是一种通过光纤交换机等高速网络设备在服务
器和磁盘阵列等存储设备间搭设专门的存储网络，从而提供高性能存储系统的架构。SAN的优
势在于灵活性，多个主机和多个存储阵列（磁盘阵列）可以连接到同一个SAN上，存储任务可
以被动态地分配到各个主机上。
SAN与NAS的区别在于，SAN提供块级别的访问接口，一般不会同时提供一个文件系统级
别的访问接口。通常情况下，服务器需要通过SCSI等 I/O总线架构将SAN映射到本地磁盘，然后
在其上创建文件系统后进行使用。目前，主流的企业级 NAS或SAN存储产品一般都可以提供 TB
级的存储容量，高端的存储产品甚至可以提供高达几个PB（1PB=1024TB）的存储容量。
9.5.2　新型存储系统
1．分布式存储系统
大数据时代的到来，使得数据量呈现出指数级的增长趋势。此时，传统的集中式存储
（如NAS、 SAN等）在容量和性能等各方面，都无法较好地满足大数据对存储的需求。在此
背景下，具有优秀的可扩展能力的分布式存储系统成了存储大数据的主流存储系统。分布式
存储系统多采用普通的硬件设备作为基础设施，因此，单位容量的存储成本得以大大降低。
另外，分布式存储系统在性能、维护性和容灾性等方面，相比传统存储系统也具有不同程度的  
优势。
分布式存储系统需要解决的关键技术问题包括可扩展性、数据冗余、数据一致性、全局命名空
间缓存等。根据系统架构的不同，大体上可将分布式存储系统架构分为两种：C/S （client/server）架
构和P2P （peer-to-peer）架构。当然，也有一些分布式存储系统中会同时存在这两种架构。
分布式存储系统面临的一个共性问题是，如何组织和管理成员节点，以及如何建立数据与
节点之间的映射关系。成员节点的动态增加或者删除，在分布式存储系统中基本上可以算是一
种常态。
2．云存储系统
云存储系统是由第三方运营商提供的在线存储系统，例如面向个人用户的在线网盘，面向
企业的文件、块或对象存储系统等。云存储系统的运营商负责数据中心的部署、运营和维护等
工作，其会将数据存储包装成服务的形式提供给用户。云存储系统作为云计算的延伸和重要组
件之一，为云计算的实现提供了“按需分配、按量计费”的数据存储服务。因此，云存储系统
的用户不需要搭建自己的数据中心和基础架构，也不需要关心低层存储系统的管理与维护等工

--- Page 324 ---
303
第
9章 
磁盘存储器管理
作，同时还可以根据业务需求动态地扩大或减少自己对存储容量的需求。
9.5.3　硬盘新技术
硬盘是计算机中非常重要的存储器之一，计算机正常运行所需的大部分软件都存储在硬盘
上。硬盘存储容量较大，故区别于内存和光盘。近几年来在个人计算机上，除了使用传统的机
械硬盘（hard disk driver， HDD）外，还会使用固态硬盘（solid state disk， SSD），且固态硬盘
的风头正盛，大有赶超机械硬盘之势。这是因为固态硬盘和机械硬盘相比，在速度、功耗、噪
声等方面均有优势。不过在存储容量、写入耐久度和价格等方面，机械硬盘仍然有着不可比拟
的优势。下面将分别介绍机械硬盘技术革新与固态硬盘及其分类。
1．机械硬盘技术革新
从1956年发明第一个机械硬盘开始，存储技术的发展走过了很长的一段路。机械硬盘从
5MB发展到现在的20TB，容量大幅增加，读/ 写速度也逐步提升。在固态硬盘大量使用的情况
下，机械硬盘也在加快技术革新的步伐。例如，希捷公司提出的从传统磁记录（conventional 
magnetic recording，CMR）技术到叠瓦式磁记录（shingled magnetic recording， SMR）技术，再
到引入热辅助磁记录（heat assisted magnetic recording， HAMR）技术，极大限度地扩大了机械
硬盘的容量；同时，双磁头驱动臂技术的应用也大大提升了机械硬盘的读/写速度。
2．固态硬盘
固态硬盘是用固态电子存储芯片阵列所制成的硬盘。固态硬盘在接口的规范与定义、功能
以及使用方法上与普通硬盘完全相同，在产品的外形和尺寸上也基本与普通硬盘一致。但是，
新兴的U.2、M.2等接口形式的固态硬盘，它们的尺寸与外形与SATA架构的机械硬盘完全不同。
固态硬盘被广泛应用于军事、医疗、航空、交通（导航设备）、通信（网络监控）等领域。
根据存储介质的不同，可将固态硬盘分为三类：第一类是基于闪存的固态硬盘（将闪存
作为存储介质）；第二类是基于DRAM 的固态硬盘（将DRAM作为存储介质）；第三类（最新
的）是基于XPoint类的固态硬盘，此类硬盘采用了英特尔公司所提出的XPoint颗粒技术。
（1）基于闪存的固态硬盘。
基于闪存的固态硬盘将Flash芯片作为存储介质，此类固态硬盘即通常所说的固态硬盘，是
固态硬盘的主要类别。它的外观可以被制作成多种样式，如笔记本硬盘、微硬盘、存储卡、优
盘等。此类固态硬盘最大的优点是可以移动，而且数据保护不受电源控制，能适应各种环境，
适合个人用户使用。此类固态硬盘的使用寿命根据不同的闪存介质而有所不同，可靠性很高，
高品质的家用固态硬盘的故障率可轻松保持在普通家用机械硬盘故障率的十分之一甚至更低。
（2）基于DRAM的固态硬盘。
基于DRAM的固态硬盘将DRAM作为存储介质，应用范围较窄。此类固态硬盘效仿了机械
硬盘的设计，因此可被绝大部分OS 的文件系统工具进行卷设置和卷管理，并能提供外设互连
（peripheral component interconnect，PCI）标准接口和FC标准接口用于连接主机或服务器，应用
方式可分为固态硬盘和固态硬盘阵列两种。此类固态硬盘是一种高性能的存储器，理论上可以
无限写入，缺点是需要独立电源来保护数据安全，属于非主流存储设备。
（3）基于XPoint类的固态硬盘。
基于XPoint类的固态硬盘在原理上接近基于DRAM的固态硬盘，但其属于非易失性存储
器，读取时延极低，可轻松达到现有固态硬盘的百分之一，并且有接近无限的存储寿命。其缺

--- Page 325 ---
304
计算机操作系统 （慕课版）
点是密度相对于基于闪存的固态硬盘较低，成本极高，因此多用于发烧级台式计算机和数据  
中心。
9.6　数据一致性控制
在实际应用中，经常会在多个文件中包含同一个数据。所谓数据一致性问题，是指保存在
多个文件中的同一个数据，在任何情况下都必须保证相同。例如，当我们发现某种商品的进价
有错时，我们必须同时修改流水账、付费账、分类账以及总账等一系列文件中关于该商品的价
格，如此才能保证数据的一致性。但如果在修改途中系统突然发生故障，则会造成各个账目中
该数据的不一致性，进而就会使多个账目不一致。为了保证数据的一致性，在现代OS中都配置
了能保证数据一致性的软件。
9.6.1　事务
1．事务的定义
事务是用于访问和修改各种数据项的一个程序单位。事务也可被看作一系列读/ 写操作。
被访问的数据可以分散地存放在同一文件的不同记录中，也可以存放在多个文件中。只有对分
布在不同位置的同一数据进行的读/ 写操作（含修改）全部完成时，才能通过托付操作（commit 
operation）来终止事务。只要有一个读/写操作失败，便须执行夭折操作（abort operation）。读/
写操作的失败可能是由逻辑错误或系统故障导致的。
一个被“夭折”的事务，通常已执行了一些操作，因而可能已对某些数据做了修改。为了
使“夭折”的事务不会引起数据的不一致性，须将该事务内刚被修改的数据项恢复成原来的情
况，以使系统中各数据项与该事务未执行时系统中各数据项的内容完全相同。此时，可以说该
事务“已被退回”（rolled back）。不难看出，一个事务在对一批数据执行修改操作时，要么全
部完成并用修改后的数据代替原来的数据，要么一个也不修改。事务操作所具有的这种特性，
就是本书第1章中曾讲过的“原子性”。
2．事务记录
为了实现上述“原子性”修改，通常须借助于称为“事务记录”（transaction record）的数
据结构。这些数据结构被放在一个非常可靠的存储器（又称为稳定存储器）中，用于记录在事
务运行过程中与数据项修改相关的全部信息，这些信息又被称为“运行记录”（log）。该记录
中包含下列字段。
 事务名：用于标志该事务的唯一名字。
 数据项名：它是被修改数据项的唯一名字。
 旧值：修改前数据项的值。
 新值：修改后数据项将具有的值。
在事务记录表中的每一项记录，都描述了在事务运行过程中的重要事务操作，如修改操
作、开始操作、托付操作、夭折操作等。在一个事务 Ti开始执行时，〈Ti开始〉记录被写入事务
记录表中；在Ti执行期间，在Ti的任何写（修改）操作之前，均须先在事务记录表中写一项适当
的新记录；当Ti进行托付时，要把一个〈Ti托付〉记录写入事务记录表中。

--- Page 326 ---
305
第
9章 
磁盘存储器管理
3．恢复算法
由于一组被事务 Ti修改的数据以及它们被修改前后的值，都能在事务记录表中找到，因
此，系统利用事务记录表可以处理任何故障而不会使故障造成非易失性存储器中信息的丢失。
恢复算法可通过以下两个过程实现。
（1）undo〈Ti〉：该过程把所有被事务Ti修改过的数据恢复为修改前的值。
（2）redo〈Ti〉：该过程把所有被事务Ti修改过的数据设置为新值。
如果系统发生故障，系统应对以前所发生的事务进行清理。通过查找事务记录表，可以把
尚未清理的事务分成两类。一类是所包含的各类操作都已完成的事务，确定为这一类事务的依
据是，在事务记录表中既包含了〈T
i开始〉记录，又包含了〈Ti托付〉记录，此时，系统会利用
redo〈Ti〉过程把所有已被修改的数据设置成新值。另一类是所包含的各个操作并未全部完成的事
务，例如，对于事务Ti，如果在事务记录表中只有〈Ti开始〉记录而无〈Ti托付〉记录，则此Ti便
属于此类事务，这时，系统会利用undo〈Ti〉过程将所有已被修改的数据恢复为修改前的值。
9.6.2　检查点
1．检查点的作用
如前所述，当系统发生故障时，必须去检查整个事务记录表，以确定哪些事务需要利用
redo〈Ti〉过程去设置新值，而哪些事务又需要利用undo〈 Ti〉过程去恢复旧值。由于在系统中
可能存在许多并发执行的事务，因而在事务记录表中会有许多事务执行操作的记录。随着时间
的推移，记录的数据会越来越多。因此，一旦系统发生故障，事务记录表中的记录清理起来就
会非常费时。
引入检查点（check points）的主要目的是，使事务记录表中事务记录的清理工作经常化，
即每隔一定的时间就做一次下述工作：首先，将驻留在易失性存储器（内存）中的当前事务记
录表中的所有记录输出到稳定存储器中；其次，将驻留在易失性存储器中的所有已修改数据输
出到稳定存储器中；再次，将事务记录表中的〈检查点〉记录输出到稳定存储器中；最后，每
当出现一个〈检查点〉记录，系统便执行一次9.6.1小节所介绍的恢复操作，即利用redo〈 T
i〉和
undo〈Ti〉过程实现数据恢复。
如果一个事务 Ti在检查点前就做了托付，则在事务记录表中便会出现一个在检查点记录前
的〈Ti托付〉记录。在这种情况下，所有被Ti修改过的数据，都会在检查点前写入稳定存储器，
或者是作为检查点记录自身的一部分写入稳定存储器。因此，以后在系统出现故障时，就不必
再执行redo〈Ti〉过程了。
2．新的恢复算法
在引入检查点后，大大减少了恢复处理的开销。因为在发生故障后，并不需要对事务记录
表中的所有事务记录都进行处理，而只需要对最后一个检查点之后的事务记录进行处理。具体
而言，恢复例程首先会查找事务记录表，确定最近检查点以前开始执行的最后事务Ti；在找到这
样的事务后，返回去搜索事务记录表，此时便可找到第一个检查点记录；恢复例程从该检查点
开始，返回搜索各个事务的记录，并利用redo〈Ti〉和undo〈Ti〉过程对它们进行处理。
如果把所有在事务Ti以后开始执行的事务表示为事务集T，则新的恢复操作要求：对所有在
T中的事务Tk，如果在事务记录表中出现了〈 Tk托付〉记录，则执行redo〈 Tk〉过程；如果在事

--- Page 327 ---
306
计算机操作系统 （慕课版）
务记录表中并未出现〈Tk托付〉记录，则执行undo〈Tk〉过程。
9.6.3　并发控制
在多用户系统和计算机网络环境下，可能有多个用户在同时执行事务。由于事务具有原子
性，这使各个事务必然会按某种次序依次执行，只有在一个事务执行完后，才允许另一事务执
行，即各事务对数据项的修改是互斥的。我们把这种特性称为顺序性，而把用于实现事务顺序
性的技术称为并发控制（concurrent control ）。该技术在数据库系统中已被广泛应用，现也广泛
应用于OS中。虽然可以利用第4章所介绍的信号量机制来保证事务顺序性，但在数据库系统和文
件服务器中，应用最多的还是较简单、较灵活的同步机制——锁。
1．利用互斥锁实现顺序性
实现顺序性最简单的方法是，设置一种用于实现互斥的锁，简称互斥锁（exclusive 
lock）。在利用互斥锁实现顺序性时，应为每个共享对象设置一把互斥锁。当某一事务 Ti要去访
问某个对象时，应先获得该对象的互斥锁。若成功，则用该锁将该对象锁住，此时事务Ti便可对
该对象执行读/写操作，而其他事务由于未获得该锁，故不能访问该对象。如果事务 Ti需要对一
批对象进行访问，则为了保证事务操作的原子性， Ti应先获得这一批对象的互斥锁，以将这一
批对象全部锁住。若成功，则可对这一批对象执行读/ 写操作；操作完成后再将所有的这些锁释
放。但如果这一批对象中的某个对象已被其他事务锁住，则此时事务 Ti应对此前已被Ti锁住的其
他对象进行开锁，宣布此次事务运行失败，但这不会引起数据变化。
2．利用互斥锁和共享锁实现顺序性
利用互斥锁实现顺序性的方法简单易行，目前有不少系统都采用了这种方法来保证事务
操作的顺序性，但这种方法存在着效率不高的问题。因为一个共享文件虽然只允许一个事务去
写，但却允许多个事务同时去读；而在利用互斥锁来锁住这个文件后，其就只允许一个事务去
读。为了提高运行效率，又引入了另一种形式的锁——共享锁（shared lock）。共享锁与互斥锁
的区别在于：互斥锁仅允许一个事务对相应的对象执行读/ 写操作，而共享锁则允许多个事务对
相应的对象执行读操作，但不允许其中任何一个事务对相应的对象执行写操作。
在为一个对象设置了互斥锁和共享锁的情况下，如果事务T
i要对对象Q执行读操作，则只须
获得对象Q的共享锁。如果对象Q已被互斥锁锁住，则事务 Ti必须等待；否则，即可获得共享锁
而对Q执行读操作。如果Ti要对Q执行写操作，则Ti还须获得Q的互斥锁。若失败，则须等待；否
则，即可获得互斥锁而对Q执行写操作。利用共享锁和互斥锁实现顺序性的方法，非常类似于本
书第4章中所介绍的读者-写者问题的解法。
9.6.4　重复数据的一致性问题
为了保证数据的安全性，最常见的做法是把关键文件或数据结构复制多份，分别存储
在不同的地方，当主文件（数据结构）失效时，还有备份文件（数据结构）可以使用，因此
不会造成数据丢失，也不会影响系统工作。显然，主文件（数据结构）中的数据应与各备份
文件中的对应数据相一致。此外，有些数据结构（如空闲盘块表等）在系统运行过程中总是
会被不断地修改，因此，同样应保证不同处的同一数据结构中（可能已被修改的）数据的一  
致性。

--- Page 328 ---
307
第
9章 
磁盘存储器管理
1．重复文件的一致性
这里以UNIX类型的文件系统为例，来说明如何保证重复文件的一致性。对于一般的UNIX
类型的目录，其每个目录项中均含有一个ASCII的文件名和一个索引节点编号，后者指向一个索
引节点。当有重复文件时，一个目录项可由一个文件名和若干个索引节点编号组成，每个索引
节点编号都会指向各自的索引节点。图9-17所示为UNIX类型的目录。
文件名
文件名
文件1
文件2
文件3
文件4
文件1
文件2
文件3
文件4
17
22
12
84
17
22
12
84
19
72
30
15
40
91
29
66
索引节点
索引节点
（a）不允许有重复文件的目录 （b）允许有重复文件的目录
图 9-17　UNIX 类型的目录
当有重复文件时，如果一个文件复制被修改，则必须同时修改其他几个文件复制，以保证
各相应文件中数据的一致性。这可采用两种方法来实现：第一种方法是当一个文件被修改后，
可查找文件目录以得到其他几个文件复制的索引节点编号，再利用这些索引节点编号找到各文
件复制的物理位置，然后对这些文件复制做同样的修改；第二种方法是为新修改的文件建立几
个文件复制，并用新文件复制去取代原来的文件复制。
2．链接数一致性检查
在UNIX类型的目录中，每个目录项内都含有一个索引节点编号，用于指向该文件的索引节
点。对于一个共享文件，其索引节点编号会在目录中出现多次。例如，当有5 个用户（进程）共
享某文件时，该文件的索引节点编号会在目录中出现5 次；另外，在该共享文件的索引节点中还
有一个链接计数值count，用于指出共享本文件的用户（进程）数。在正常情况下，这两个数据
应该一致，否则就会出现数据不一致性差错。
为了检查这种数据不一致性差错，需要配置一张计数器表，并且应为每个文件建立一个表
项，其中含有各文件索引节点编号的计数值。在进行检查时，从根目录开始查找，每当在目录
中遇到该索引节点编号时，便在该计数器表中相应文件的表项上加1 。当把所有目录都检查完
后，便可将该计数器表中每个表项中的索引节点编号计数值与该文件索引节点中的链接计数值
count进行比较，如果两者一致，则表示数据正确；否则，说明发生了数据不一致性差错。
如果索引节点中的链接计数值count大于计数器表中相应索引节点编号的计数值，则即
使所有共享此文件的用户都不再使用此文件，其count仍不为0 ，因而该文件不会被删除。这
种错误的后果是用户不再需要的一些文件仍会驻留在磁盘上，浪费存储空间。当然，这种错
误的性质并不严重，解决方法是用计数器表中正确的计数值去为count重新赋值。如果出现
count小于计数器表中相应索引节点编号计数值的情况，则说明存在潜在危险。假如有两个
用户共享一个文件，但是count仍为1 ，此时只要其中一个用户不再需要此文件，count就会
减为0 ，从而使系统将此文件删除，并释放其索引节点及文件所占用的盘块，这会导致另一
个需要共享此文件的用户所对应的目录项指向一个空索引节点，最终会导致该用户无法访问
此文件。如果该索引节点很快又被分配给了其他文件，则还会带来潜在危险，解决方法是将
count置为正确值。

--- Page 329 ---
308
计算机操作系统 （慕课版）
9.7　本章小结
磁盘驱动器是大多数计算机系统的主要外存I/O设备，大多数外存设备均为磁盘或磁带。现
代磁盘驱动结构是一个大的一维的逻辑盘块数组。一般来说，这些逻辑盘块的大小为512B 。磁
盘连接到计算机系统的方式有两种：①通过主机的本地I/O接口连接；②通过网络连接。
磁盘存储器管理的任务之一，是有效利用存储空间，即采用合适的文件组织方式为文件分
配存储空间，以改善存储空间的利用率。而文件组织方式与外存组织方式密切相关，常用的外
存组织方式包括：连续组织方式、链接组织方式和索引组织方式。在现代OS中，由于存在多
种类型的文件，因此对文件可能会采取多种类型的组织方式。存储空间的管理方法有空闲区表
法、空闲链表法、位示图法、成组链接法等。
磁盘存储器管理的任务之二，是通过采用磁盘高速缓存、RAID等途径来提高磁盘的I/O
速度。
磁盘存储器管理的任务之三，是通过采用各种容错技术和后备系统来提高磁盘的可靠性。
磁盘发展至今，已形成多种存储技术且在不断革新中；固态硬盘在存储领域的地位也在日
渐提升。除了传统的DAS、 NAS、SAN存储系统外，正在发展的新型存储系统有分布式存储系
统、云存储系统等。
习题9（含考研真题）
一、简答题
1．（考研真题）文件物理结构是指一个文件在外存上的存储组织形式，主要有连续结构、
链接结构和索引结构这3种，请分别简述它们的优缺点。
2．在FAT中为什么要引入“簇”的概念？以“簇”为基本分配单位有什么好处？
3．在MS-DOS系统中有两个文件A和B，A占用11、12、16、14这4个盘块；B占用13、18、
20这3个盘块。试画出文件A和B中各盘块间的链接情况及FAT的情况。
4．假定一个文件系统的外存组织方式采用显示链接组织方式，在 FAT中可有64K个指针，
磁盘盘块大小为512B。试问该文件系统能否表示一个512MB的磁盘？
5．（考研真题）某文件系统为单级目录结构，文件的数据一次性写入磁盘，已写入的文件
不可修改，但可多次创建新文件。请回答如下问题。
（1）在连续、链式、索引这3 种文件数据块组织方式中，哪种更合适？说明理由。为定位
文件数据块，需要在FCB中设计哪些相关描述字段？
（2）为快速找到文件，对于FCB，是集中存储好，还是与对应的文件数据块连续存储好？
说明理由。
6．有一计算机系统利用图9-18所示的位示图（行号、列号都从0 开始编号）来管理空闲盘
块。如果盘块从1开始编号，每个盘块的大小为1KB，则请回答下列问题：
（1）现要为文件分配两个盘块，试具体说明分配过程；
（2）若要释放磁盘的第300块，则应如何处理？

--- Page 330 ---
309
第
9章 
磁盘存储器管理
i
0
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
0
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
1
2
1
1
1
0
1
1
1
1
1
1
1
1
1
1
1
1
3
1
1
1
1
1
1
0
1
1
1
1
0
1
1
1
1
4
0
0
0
0
0
0
0
0
0
0
0
0
0
0
0
0
…
…
j
图 9-18　位示图
7．（考研真题）某系统采用成组链接法管理磁盘的空闲空间，目前盘块的链接情况处于
图9-19所示的状态，先由进程A释放物理块181、135、192，再由进程B申请4个物理块。试分别
画图说明进程A释放物理块后和进程B申请物理块后的盘块链接情况。
S.free 
free[0]
free[1]
…
free[96]
free[97]
free[98]
free[99]
34#
99
34
35
70
75
98
98#
87
85
143
62
55
75#
70#
35#
…
…
图 9-19　盘块链接情况
8．（考研真题）磁盘长期使用后，读/ 写其中数据的速度就会变慢；而执行磁盘碎片整理
程序后，读/写速度就提高了，为什么？
9．（考研真题）何谓磁盘高速缓存？在设计磁盘高速缓存时需要考虑哪些问题？
10．什么是磁盘容错技术？请简述基于集群技术实现容错的几种主要的工作模式。
11．引入检查点的目的是什么？引入检查点后应如何进行恢复处理?
二、计算题
12．请分别解释在连续组织方式、隐式链接组织方式、显式链接组织方式和索引组织方
式中，如何将文件的字节偏移量3 500转换为物理盘块号和块内位移量（设物理盘块的大小为
1KB，盘块号占4B）？
13．（考研真题）对于容量为200GB的硬盘，若采用FAT文件系统且盘块大小设定为4KB，
则请问其FAT表项长度应当选用16位还是32位（采用二进制表示）？其FAT共须占用多少字节的
空间？
14．某个容量为1.44MB的软盘，共有80个柱面，每个柱面上有18个盘块，盘块大小为
1KB，盘块和柱面均从0 开始编号。文件A 依次占据了20、 500、750、900这4个盘块，其FCB位
于51号盘块上，磁盘最后一次访问的是50号盘块。若采用隐式链接组织方式，则请计算顺序存
取该文件的全部内容需要的磁盘寻道距离。
15．（考研真题）某文件系统采用索引物理结构存储文件，磁盘空间为1 000GB。一个目录

--- Page 331 ---
310
计算机操作系统 （慕课版）
项可以存储10个盘块的地址，前9个为直接地址，最后一个为一级间址。若盘块的大小为512B，
则该文件系统最大能支持的文件大小是多少?
16．（考研真题）某文件系统采用混合索引组织方式，如图9-20所示，有10个直接块（每
个直接块指向1 个数据块）、1 个一级间接块、1 个二级间接块和1 个三级间接块，间接块指向的
是1个索引块，每个索引块和数据块的大小均为512B，索引块编号的大小为4B。
（1）若只使用直接块，则文件最大为多少字节？
（2）在该系统中能存储的文件最大是多少？
（3）若读取某文件第10MB的内容，则需要访问磁盘几次？
一级间接块
直接块
二级间接块
三级间接块
数据索引块
索引块
索引块
索引块
数据
数据
数据
数据
数据
数据
数据
数据
图 9-20　文件系统混合索引组织方式
17．在UNIX系统中，如果一个盘块的大小为1KB，每个盘块号占4B，即每块可放256个地
址，一个文件索引节点中磁盘的物理盘块号结构如图9-21所示。请转换下列文件的字节偏移量
为物理地址：①9 999；②18 000；③420 000。
i.addr（0）
i.addr（1）
i.addr（2）
i.addr（3）
i.addr（4）
i.addr（5）
i.addr（6）
i.addr（7）
i.addr（8）
i.addr（9）
i.addr（10）
i.addr（11）
i.addr（12）
4 096
135
192
0
3
123
245
111
367
6
428
9 123
8 034
100
34
35
70
75
98
181
633
…
428#
331
82
162
…
1 146
9 123#
…
342
335
984
…
198
331#
143
144
145
255
0
1
2
3
4
5
6
7 0
1
2
255
图 9-21　文件索引节点中磁盘的物理盘块号结构
18．假设某系统磁盘共含 500个盘块，盘块号为0 —499。若用位示图法管理这 500个盘块的
空间，则当字长为32位时，请问： （1）位示图需要多少个字节？（2）第i字节的第j位对应的盘块
号是多少？
三、综合应用题
19．如果一个文件存放在100个数据块中，FCB、 FAT、索引块或索引信息等都驻留在内存

--- Page 332 ---
311
第
9章 
磁盘存储器管理
中。在下面几种情况下，分别需要做几次磁盘I/O操作？
（1）采用连续组织方式，将最后一个数据块搬到文件头部；
（2）采用单级索引组织方式，将最后一个数据块搬到文件头部；
（3）采用显式链接组织方式，将最后一个数据块搬到文件头部；
（4）采用隐式链接组织方式，将首个数据块搬到文件尾部。
20．存放在某个磁盘上的文件系统，采用混合索引组织方式，其FCB中共有13个地址项，
第0—9个地址项为直接地址，第10个地址项为一次间接地址，第11 个地址项为二次间接地址，
第12个地址项为三次间接地址。如果每个盘块的大小为512B，盘块号占3B，则每个盘块最多存
放170个盘块地址。
（1）将文件的字节偏移量5 000、15 000、150 000转换为物理盘块号和块内偏移量。
（2）假设某个文件的FCB已在内存中，但其他信息均在外存中，为了访问该文件中某个位
置的内容，最少需要访问几次磁盘，最多需要访问几次磁盘？
21．（考研真题）文件F由200条记录组成，记录从1 开始编号，用户打开文件F 后，欲将内
存中的一条记录插入文件F中，作为其第30条记录。请回答下列问题，并说明理由。
（1）若文件系统采用顺序组织方式，每个存储块存放1条记录，文件F的存储区域前后均有
足够的空闲存储空间，则要完成上述操作最少要访问多少次存储块？文件F 的FCB内容会有哪些
改变？
（2）若文件系统采用链接组织方式，每个存储块存放1条记录和1个链接指针，则要完成上
述操作最少要访问多少次存储块？若每个存储块的大小为1KB，其中4B存放指针，则该系统支
撑文件的最大长度是多少？

--- Page 333 ---
